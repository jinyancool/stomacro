# CD44 expression level in different groups and clusters

This workflow illustrates the expression patterns of stemness markers, particularly CD44, across different experimental samples and Epithelial clusters.

## tidy sample id

```{r}
#| label: load-packages
#| include: false
library(data.table)
library(magrittr)
library(rlang)
library(ggplot2)
library(ggpubr)
library(Seurat)
library(dplyr)
library(patchwork)
library(Nebulosa)
library(ggridges)
library(clusterProfiler)
library(org.Hs.eg.db)

wkdir <- "/cluster/home/yliang_jh/projects/scRNA/oral_public_lvjiong/"
figure_dir <- "/cluster/home/xyzhang_jh/projects/oral_public_lvjiong/figure/"
rds_dir <- "/cluster/home/xyzhang_jh/projects/oral_public_lvjiong/rds/"
setwd(wkdir)
srt <- readRDS(glue(rds_dir,"srt_integrated_anno.rds"))

srt$sample_id_orig <- srt$sample_id
ids <- paste0(srt$dataset, "-", srt$sample_id) 
dt_id <- data.frame(id = unique(ids))
dt_id$sample_id <- paste0("P", sprintf("%02d", 1:nrow(dt_id)))
srt$sample_id <- dt_id$sample_id[match(ids, dt_id$id)]
saveRDS(srt, glue(rds_dir,"srt_integrated_anno.rds"))

config_fn <- glue::glue("/cluster/home/lixiyue_jh/projects/quarto/stomatology_lvjiong/quarto_book/colors.yaml")
color_celltype <- jhtools::show_me_the_colors(config_fn, "cell_type")
```

## Dotplot visualization of CD44 expression levels across individual clusters and samples

```{r}
# CD44 dotplot - sample vs celltype
dt_expr <- FetchData(srt, vars = c("sample_id", "celltype", "CD44"), layer = "data") %>%
  as.data.table()
dt <- dt_expr[, .(pct_expr = mean(CD44 > 0) * 100,
                  avg_expr = mean(CD44[CD44 > 0], na.rm = TRUE)
                  ), by = c("sample_id", "celltype")]
dt[is.na(dt)] <- 0
dt[, avg_expr_scaled := scale(avg_expr)]

p <- ggplot(dt, aes(sample_id, celltype)) +
  geom_point(aes(size = pct_expr, color = avg_expr_scaled)) +
  scale_color_gradient(low = "lightgrey", high = "blue") +
  scale_size(range = c(1, 6)) +
  theme_classic() +
  labs(x = "Sample ID", y = "Cell Type",  
       color = "Average Expression", size = "Percent Expressed")
ggsave(glue(figure_dir,"output/CD44/CD44_expr_in_sample_vs_celltype.pdf"), p, width = 15, height = 6)
```

## Visualize CD44 expression levels by umap plot

```{r}
# CD44 and other stemness markers in tumor
srt_epi <- readRDS("srt_epi.rds") ## unsavedbu
marker_stem <- c("CD44", "PROM1", "SOX2", "NANOG", "POU5F1", "BMI1")
p <- FeaturePlot(srt_epi, reduction = "umap", features = marker_stem, ncol = 3, raster = TRUE)
ggsave(glue(figure_dir,"output/CD44/umap_stemness_markers.pdf", p, width = 8, height = 5))

p <- plot_density(srt_epi, marker_stem, reduction = "umap", raster = TRUE, size = 0.1) +
  plot_layout(ncol = 3)
ggsave(glue(figure_dir,"output/CD44/umap_density_stemness_markers.pdf"), p, width = 9, height = 5)
```

## Correlation Analysis of CD44 with Other Stemness Markers

```{r}
pt <- FetchData(srt_epi, vars = marker_stem, layer = "data") %>%
  tidyr::pivot_longer(cols = PROM1:BMI1, names_to = "gene", values_to = "expr")
pt <- pt %>% filter(CD44 > 0 & expr > 0)
p <- ggplot(pt, aes(CD44, expr)) +
  geom_hex() +
  scale_fill_gradient(low = "white", high = "red") +
  facet_wrap(~ gene, scales = "free_y") +
  geom_smooth(method = lm, color = "black", se = FALSE) +
  stat_cor(method = "pearson") +
  theme_classic()
ggsave(glue(figure_dir,"output/CD44/correlation_CD44_stemness_markers.pdf"), p, width = 8, height = 5)
```

## CD44 expression patterns across samples analyzed by hierarchical clustering (k=5)

```{r}
pt <- FetchData(srt_epi, vars = c("CD44", "sample_id"), layer = "data")
p <- ggplot(pt, aes(CD44, sample_id)) +
  geom_density_ridges(aes(fill = sample_id)) +
  theme_classic() +
  guides(fill = "none")
ggsave(glue(figure_dir,"output/CD44/density_CD44_sample.pdf"), p, width = 6, height = 12)

# ks test & hclust
sps <- unique(pt$sample_id)
n <- length(sps)
ks_dist <- matrix(0, nrow = n, ncol = n)
rownames(ks_dist) <- sps
colnames(ks_dist) <- sps

for (i in 1:(n - 1)) {
  for (j in (i + 1):n) {
    ks_test <- ks.test(pt[pt$sample_id == sps[i], "CD44"], pt[pt$sample_id == sps[j], "CD44"])
    ks_dist[i, j] <- ks_test$statistic  
    ks_dist[j, i] <- ks_dist[i, j]
  }
}

dist_mat <- as.dist(ks_dist)
hc <- hclust(dist_mat, method = "ward.D2")
sp_order <- hc$labels[hc$order]
pt$sample_id <- factor(pt$sample_id, levels = sp_order)
p <- ggplot(pt, aes(CD44, sample_id)) +
  geom_density_ridges(aes(fill = sample_id)) +
  theme_classic() +
  guides(fill = "none")
ggsave(glue(figure_dir,"output/CD44/density_CD44_sample_hclust.pdf"), p, width = 6, height = 12)
pdf(glue(figure_dir, "output/CD44/density_CD44_sample_hclust_dendrogram.pdf"), width = 12, height = 6)
plot(as.dendrogram(hc))
dev.off()

clusters <- cutree(hc, k = 5)
df_cl <- data.frame(sample_id = names(clusters),
                    cluster = clusters)
fwrite(df_cl, glue(figure_dir,"output/CD44/density_CD44_sample_hclust.csv"))
```

## EpiCutree-based clustering of immune microenvironment clusters with k=5

The following code generates a visualization displaying both immune microenvironment clusters across samples and tumor cell-driven sample clustering, dividing the dataset into five distinct subgroups.

```{r}
srt <- readRDS(glue(rds_dir,"srt_integrated_anno.rds"))
pt <- srt[[c("sample_id", "celltype")]]
pt$cluster <- df_cl$cluster[match(pt$sample_id, df_cl$sample_id)]
pt$sample_id <- factor(pt$sample_id, levels = sp_order)
pt_im <- pt %>%
  filter(celltype %in% c("T/NK", "B cell", "Plasma", "TAM", "DC", "Mast")) %>%
  filter(!is.na(cluster))
p <- ggplot(pt_im, aes(sample_id, fill = celltype)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = color_celltype) +
  facet_grid(~ cluster, scales = "free_x", space = "free_x") +
  theme_classic()
ggsave(glue(figure_dir,"output/CD44/stack_bar_CD44_cluster_immune.pdf"), width = 15, height = 8)

# diff gene & enrich
Idents(srt_epi) <- df_cl$cluster[match(srt_epi$sample_id, df_cl$sample_id)]
markers <- FindAllMarkers(srt_epi)
fwrite(markers, glue(figure_dir,"output/CD44/CD44_cluster_markers.csv"))

df_sig <- markers %>%
  filter(abs(avg_log2FC) > 1 & p_val_adj < 0.05) %>%
  mutate(type = ifelse(avg_log2FC > 0, "up", "down"))
fwrite(df_sig, glue(figure_dir,"output/CD44/CD44_cluster_markers_sig.csv"))

gene_entrez <- bitr(unique(df_sig$gene), fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Hs.eg.db")
df_sig <- merge(df_sig, gene_entrez, all.x = TRUE, by.x = "gene", by.y = "SYMBOL")

res <- compareCluster(ENTREZID ~ cluster + type, 
                      data = df_sig, 
                      organism = "hsa",
                      fun="enrichKEGG",
                      use_internal_data = T)

p <- dotplot(res) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggsave(glue(figure_dir,"output/CD44/CD44_cluster_markers_enrichment_KEGG.pdf"), p, width = 12, height = 18)

df_res <- setReadable(res, OrgDb = "org.Hs.eg.db", keyType="ENTREZID") %>%
  as.data.frame()
fwrite(glue(figure_dir, df_res, "output/CD44/CD44_cluster_markers_enrichment_KEGG.csv"))
```

## Gene expression correlation between ALDH1A1 and CD44 in epi cluster

```{r}
srt_epi <- readRDS("srt_epi.rds") ## unsaved
p <- FeaturePlot(srt_epi, reduction = "umap", features = "ALDH1A1", raster = TRUE)
ggsave(glue(figure_dir,"output/CD44/umap_stemness_markers_ALDH1A1.pdf"), p, width = 5, height = 5)

p <- plot_density(srt_epi, "ALDH1A1", reduction = "umap", raster = TRUE, size = 0.1)
ggsave(glue(figure_dir,"output/CD44/umap_density_stemness_markers_ALDH1A1.pdf"), p, width = 5, height = 5)

pt <- FetchData(srt_epi, vars = c("CD44", "ALDH1A1"), layer = "data") %>%
  tidyr::pivot_longer(cols = ALDH1A1, names_to = "gene", values_to = "expr")
pt <- pt %>% filter(CD44 > 0 & expr > 0)
p <- ggplot(pt, aes(CD44, expr)) +
  geom_hex() +
  scale_fill_gradient(low = "white", high = "red") +
  facet_wrap(~ gene, scales = "free_y") +
  geom_smooth(method = lm, color = "black", se = FALSE) +
  stat_cor(method = "pearson") +
  theme_classic()
ggsave(glue(figure_dir,"output/CD44/correlation_CD44_stemness_markers_ALDH1A1.pdf"), p, width = 5, height = 5)
```

## CD44 expression patterns across samples analyzed by hierarchical clustering (k=3)

```{r}
srt_epi <- readRDS("srt_epi.rds")## unsaved
pt <- FetchData(srt_epi, vars = c("CD44", "sample_id"), layer = "data")

# ks test & hclust
sps <- unique(pt$sample_id)
n <- length(sps)
ks_dist <- matrix(0, nrow = n, ncol = n)
rownames(ks_dist) <- sps
colnames(ks_dist) <- sps

for (i in 1:(n - 1)) {
  for (j in (i + 1):n) {
    ks_test <- ks.test(pt[pt$sample_id == sps[i], "CD44"], pt[pt$sample_id == sps[j], "CD44"])
    ks_dist[i, j] <- ks_test$statistic  
    ks_dist[j, i] <- ks_dist[i, j]
  }
}

dist_mat <- as.dist(ks_dist)
hc <- hclust(dist_mat, method = "ward.D2")
sp_order <- hc$labels[hc$order]

clusters <- cutree(hc, k = 3)
df_cl <- data.frame(sample_id = names(clusters),
                    cluster = clusters) %>%
  mutate(order = match(sample_id, sp_order))
fwrite(df_cl, glue(figure_dir,"output/CD44/density_CD44_sample_hclust_k3.csv"))

# density ridges colored by cluster
srt_epi <- readRDS("srt_epi.rds")
df_cl <- fread(glue(figure_dir,"output/CD44/density_CD44_sample_hclust_k3.csv")) %>%
  arrange(order)
pt <- FetchData(srt_epi, vars = c("CD44", "sample_id"), layer = "data") %>%
  left_join(df_cl, by = "sample_id") %>%
  mutate(sample_id = factor(sample_id, levels = df_cl$sample_id))
p <- ggplot(pt, aes(CD44, sample_id)) +
  geom_density_ridges(aes(fill = as.factor(cluster))) +
  scale_fill_manual(values = c("brown2", "#4696E6", "#3CB371")) +
  labs(fill = "cluster") +
  theme_classic()
ggsave(glue(figure_dir, "output/CD44/density_CD44_sample_cluster_k3.pdf"), p, width = 6, height = 12)
```

## EpiCutree-based clustering of immune microenvironment clusters with k=5

The following code generates a visualization displaying both immune microenvironment clusters across samples and tumor cell-driven sample clustering, dividing the dataset into three distinct subgroups.

```{r}
srt <- readRDS(glue(rds_dir,"srt_integrated_anno.rds"))
pt <- srt[[c("sample_id", "celltype")]]
pt$cluster <- df_cl$cluster[match(pt$sample_id, df_cl$sample_id)]
pt$sample_id <- factor(pt$sample_id, levels = sp_order)
pt_im <- pt %>%
  filter(celltype %in% c("T/NK", "B cell", "Plasma", "TAM", "DC", "Mast")) %>%
  filter(!is.na(cluster))
p <- ggplot(pt_im, aes(sample_id, fill = celltype)) +
  geom_bar(position = "fill") +
  scale_fill_manual(values = color_celltype) +
  facet_grid(~ cluster, scales = "free_x", space = "free_x") +
  theme_classic()
ggsave(glue(figure_dir,"output/CD44/stack_bar_CD44_cluster_immune_k3.pdf"), width = 15, height = 8)

# immune cell prop boxplot
pt_box <- pt_im %>%
  count(sample_id, celltype, name = "n") %>%
  group_by(sample_id) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup
pt_box$cluster <- df_cl$cluster[match(pt_box$sample_id, df_cl$sample_id)] %>% as.factor()
p <- ggplot(pt_box, aes(celltype, prop, color = cluster)) +
  geom_boxplot(width = 0.6, outlier.shape = NA) +
  scale_color_manual(values = colors_cl) +
  # geom_point(aes(fill = sample_id), position = position_jitterdodge()) +
  # guides(fill = "none") +
  theme_classic()
ggsave(glue(figure_dir,"output/CD44/boxplot_CD44_cluster_immune_prop_k3.pdf"), p, width = 8, height = 4)

# celltype prop boxplot
pt_box <- pt %>%
  filter(!is.na(cluster)) %>%
  count(sample_id, celltype, name = "n") %>%
  group_by(sample_id) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup
pt_box$cluster <- df_cl$cluster[match(pt_box$sample_id, df_cl$sample_id)] %>% as.factor()
p <- ggplot(pt_box, aes(celltype, prop, color = cluster)) +
  geom_boxplot(width = 0.6, outlier.shape = NA) +
  scale_color_manual(values = colors_cl) +
  theme_classic()
ggsave(glue(figure_dir, "output/CD44/boxplot_CD44_cluster_celltype_prop_k3.pdf"), p, width = 8, height = 4)
```

## Gene Expression Patterns and Pathway Enrichment across Epi-Clusters

```{r}
# diff gene & enrich
Idents(srt_epi) <- df_cl$cluster[match(srt_epi$sample_id, df_cl$sample_id)]
markers <- FindAllMarkers(srt_epi)
fwrite(markers, glue(figure_dir, "output/CD44/CD44_cluster_markers_k3.csv"))

df_sig <- markers %>%
  filter(abs(avg_log2FC) > 1 & p_val_adj < 0.05) %>%
  mutate(type = ifelse(avg_log2FC > 0, "up", "down"))
fwrite(df_sig, glue(figure_dir, "output/CD44/CD44_cluster_markers_sig_k3.csv"))

gene_entrez <- bitr(unique(df_sig$gene), fromType = "SYMBOL", toType = "ENTREZID", OrgDb = "org.Hs.eg.db")
df_sig <- merge(df_sig, gene_entrez, all.x = TRUE, by.x = "gene", by.y = "SYMBOL")

res <- compareCluster(ENTREZID ~ cluster + type, 
                      data = df_sig, 
                      organism = "hsa",
                      fun="enrichKEGG",
                      use_internal_data = T)

p <- dotplot(res) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggsave(glue(figure_dir, "output/CD44/CD44_cluster_markers_enrichment_KEGG_k3.pdf"), p, width = 8, height = 12)

df_res <- setReadable(res, OrgDb = "org.Hs.eg.db", keyType="ENTREZID") %>%
  as.data.frame()
fwrite(df_res, glue(figure_dir, "output/CD44/CD44_cluster_markers_enrichment_KEGG_k3.csv"))

# barplot of selected pathway
df <- readxl::read_xlsx("output/CD44/CD44_cluster_markers_enrichment_KEGG_k3_selected.xlsx")
pt <- df %>%
  arrange(cluster, p.adjust) %>%
  mutate(p.adjust = as.numeric(p.adjust))
pmax <- max(-log10(pt$p.adjust)) %>% ceiling
colors_cl <- c("brown2", "#4696E6", "#3CB371")
p_lst <- lapply(unique(pt$cluster), function(x){
  pt1 <- pt %>%
    filter(cluster == x) %>%
    mutate(Description = factor(Description, levels = Description))
  ymax <- max(-log10(pt1$p.adjust)) %>% floor
  p <- ggplot(pt1, aes(Description, -log10(p.adjust))) +
    geom_bar(stat = "identity", fill = colors_cl[x], width = 0.6) +
    ylim(0, pmax) +
    coord_flip() +
    geom_hline(yintercept = 1:ymax, color = "white") +
    theme_classic() +
    labs(x = paste0("Cluster ", x))
  return(p)
})
hts <- pt %>% count(cluster) %>% pull(n)
p <- wrap_plots(p_lst, ncol = 1, heights = hts)
ggsave(glue(figure_dir,"output/CD44/CD44_cluster_markers_enrichment_KEGG_k3_poi_barplot.pdf"), p, width = 8, height = 8)
```

## Cytotrace score in all samples

```{r}
dss <- srt$dataset %>% unique()
res_lst <- lapply(dss, function(ds){
  srt_s <- subset(srt, subset = dataset == ds)
  srt_s <- cytotrace2(srt_s,   
                      species = "human",
                      is_seurat = TRUE,
                      slot_type = "counts",
                      batch_size = 10000, # todo NULL
                      smooth_batch_size = 1000, 
                      parallelize_models = TRUE,
                      parallelize_smoothing = TRUE,
                      ncores = 48,
                      seed = 2025)
  res <- srt_s[[c("CytoTRACE2_Score", "CytoTRACE2_Potency", "CytoTRACE2_Relative", "preKNN_CytoTRACE2_Score", "preKNN_CytoTRACE2_Potency")]]
  return(res)
})
res <- do.call(rbind, res_lst)
srt <- AddMetaData(srt, metadata = res)
srt$CytoTRACE2_Relative_Score <- scales::rescale(srt$CytoTRACE2_Score)
saveRDS(res, glue(rds_dir,"output/cytotrace/res_cytotrace.rds"))
saveRDS(srt, glue(rds_dir,"srt_integrated_anno.rds"))
```

## Cytotrace score in tumor cells

```{r}
srt_epi <- subset(srt, subset = celltype %in% c("Epithelial"))
srt_epi[["RNA"]] <- split(srt_epi[["RNA"]], f = srt_epi$dataset)
srt_epi <- NormalizeData(srt_epi) %>%
  FindVariableFeatures() %>%
  ScaleData() %>%
  RunPCA() %>%
  RunUMAP(dims = 1:20, reduction = "pca", reduction.name = "umap.unintegrated")
srt_epi <- IntegrateLayers(srt_epi, method = CCAIntegration, orig.reduction = "pca", new.reduction = "cca")
srt_epi <- JoinLayers(srt_epi)
srt_epi <- FindNeighbors(srt_epi, reduction = "cca", dims = 1:20) %>%
  RunUMAP(dims = 1:20, reduction = "cca") %>%
  FindClusters(resolution = 0.8)
saveRDS(srt_epi, glue(rds_dir,"srt_epi.rds")) # 到这里第一次存这个rds，但是代码是04，上面部分是03

dss <- srt_epi$dataset %>% unique()
res_lst <- lapply(dss, function(ds){
  srt_s <- subset(srt_epi, subset = dataset == ds)
  srt_s <- cytotrace2(srt_s,   
                      species = "human",
                      is_seurat = TRUE,
                      slot_type = "counts",
                      batch_size = NULL,
                      smooth_batch_size = 1000,
                      parallelize_models = TRUE,
                      parallelize_smoothing = TRUE,
                      ncores = 48,
                      seed = 2025)
  res <- srt_s[[c("CytoTRACE2_Score", "CytoTRACE2_Potency", "CytoTRACE2_Relative", "preKNN_CytoTRACE2_Score", "preKNN_CytoTRACE2_Potency")]]
  return(res)
})
res <- do.call(rbind, res_lst)
srt_epi <- AddMetaData(srt_epi, metadata = res)
srt_epi$CytoTRACE2_Relative_Score <- scales::rescale(srt_epi$CytoTRACE2_Score)
saveRDS(res, glue(rds_dir, "output/cytotrace/res_cytotrace_tumor.rds"))
saveRDS(srt_epi, glue(rds_dir, "srt_epi.rds"))

p <- DimPlot(srt_epi, reduction = "umap.unintegrated", group.by = "dataset", raster = TRUE)
ggsave(glue(figure_dir,"output/cytotrace/umap_dataset_before_integrate.pdf"), p, width = 6, height = 5)
p <- DimPlot(srt_epi, reduction = "umap", group.by = "dataset")
ggsave(glue(figure_dir,"output/cytotrace/umap_dataset.pdf"), p, width = 6, height = 5)
p <- DimPlot(srt_epi, reduction = "umap", group.by = "seurat_clusters")
ggsave(glue(figure_dir,"output/cytotrace/umap_cluster.pdf"), p, width = 6, height = 5)
p <- FeaturePlot(srt_epi, reduction = "umap", features = "CytoTRACE2_Relative_Score") +
  scale_color_viridis_c()
ggsave(glue(figure_dir,"output/cytotrace/umap_cytotrace.pdf"), p, width = 6, height = 5)
p <- FeaturePlot(srt_epi, reduction = "umap", features = "CD44")
ggsave(glue(figure_dir,"output/cytotrace/umap_CD44.pdf"), p, width = 6, height = 5)
pt <- FetchData(srt_epi, vars = c("CytoTRACE2_Relative_Score", "CD44"), layer = "data")
pt <- filter(pt, CD44 > 0)
p <- ggplot(pt, aes(CytoTRACE2_Relative_Score, CD44)) +
  geom_hex() +
  scale_fill_gradient(low = "white", high = "red") +
  geom_smooth(method = lm, color = "black") +
  stat_cor(method = "pearson") +
  theme_classic()
ggsave(glue(figure_dir,"output/cytotrace/correlation_CD44_cytotrace.pdf"), p, width = 6, height = 5)
```

