[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "The Oral Carcinoma Project",
    "section": "",
    "text": "Preface\nI would like to express my sincere gratitude to the Chinese Association for Blood Sciences (CABS) for their outstanding organization of the 2022 conference and the memorable football match held in Shanghai. These events provided a valuable platform for scientific exchange and helped foster meaningful connections among researchers.\nDuring the conference, I had the privilege of engaging in a stimulating discussion with Professor Dai Yun from the First Hospital of Jilin University. Our conversation took place at our hotel following the football match and focused on recent advancements in the molecular subtyping of hematological malignancies. I highlighted the significant progress made in refining molecular classifications for B-cell precursor acute lymphoblastic leukemia (BCP-ALL)(Liu et al. 2016; Li et al. 2018) and T-cell acute lymphoblastic leukemia (T-ALL)(Chen et al. 2018; Dai et al. 2022). These advances have enhanced diagnostic precision and opened new avenues for targeted therapies.\nIn response, Professor Dai shared his insights on the molecular classification of multiple myeloma, emphasizing its inherent complexity—particularly in Chinese and broader Asian populations. He noted that patients in these groups often exhibit distinct molecular and clinical features compared to their Western counterparts, posing unique challenges for diagnosis and treatment. Intrigued by this perspective, Professor Dai proposed a collaborative research initiative aimed at improving molecular subtyping specifically for Chinese patients with multiple myeloma. He suggested that methodologies and insights from BCP-ALL and T-ALL research could be adapted to address these challenges.\nI found Professor Dai’s proposal both compelling and timely, as it aligns with the growing demand for precision medicine tailored to diverse populations. Our discussion sparked enthusiasm for exploring how cutting-edge molecular techniques—such as next-generation sequencing and integrated genomic profiling—could be leveraged to better characterize multiple myeloma in Chinese patients. This exchange laid the groundwork for our current collaborative project, which seeks to bridge the gap in molecular subtyping and improve patient outcomes through personalized approaches.\nThis initiative reflects the spirit of international collaboration encouraged by events such as the CABS conference, and I am optimistic about its potential to advance our understanding of multiple myeloma and contribute to more effective, population-specific therapeutic strategies.\n\n\n\n\nChen, B., L. Jiang, M. L. Zhong, J. F. Li, B. S. Li, L. J. Peng, Y. T. Dai, et al. 2018. “Identification of Fusion Genes and Characterization of Transcriptome Features in t-Cell Acute Lymphoblastic Leukemia.” Journal Article. Proc Natl Acad Sci U S A 115 (2): 373–78. https://doi.org/10.1073/pnas.1717125115.\n\n\nDai, Y. T., F. Zhang, H. Fang, J. F. Li, G. Lu, L. Jiang, B. Chen, et al. 2022. “Transcriptome-Wide Subtyping of Pediatric and Adult t Cell Acute Lymphoblastic Leukemia in an International Study of 707 Cases.” Journal Article. Proc Natl Acad Sci U S A 119 (15): e2120787119. https://doi.org/10.1073/pnas.2120787119.\n\n\nLi, J. F., Y. T. Dai, H. Lilljebjorn, S. H. Shen, B. W. Cui, L. Bai, Y. F. Liu, et al. 2018. “Transcriptional Landscape of b Cell Precursor Acute Lymphoblastic Leukemia Based on an International Study of 1,223 Cases.” Journal Article. Proc Natl Acad Sci U S A 115 (50): E11711–20. https://doi.org/10.1073/pnas.1814397115.\n\n\nLiu, Y. F., B. Y. Wang, W. N. Zhang, J. Y. Huang, B. S. Li, M. Zhang, L. Jiang, et al. 2016. “Genomic Profiling of Adult and Pediatric b-Cell Acute Lymphoblastic Leukemia.” Journal Article. EBioMedicine 8: 173–83. https://doi.org/10.1016/j.ebiom.2016.04.038.",
    "crumbs": [
      "Preface"
    ]
  },
  {
    "objectID": "welcome.html",
    "href": "welcome.html",
    "title": "Welcome",
    "section": "",
    "text": "Reproducible Research and Open Science\nWe are grateful to all patients and clinicians who contributed to this study. This work was designed to serve three primary audiences: (i) clinicians managing oral cancer, (ii) genomicists and bioinformatics researchers, and (iii) investigators seeking to elucidate the molecular pathogenesis of oral cavity malignancies. The Results section therefore prioritizes concise, clinically actionable findings, including subtype prevalence, defining molecular features, prognostic associations, subtype-specific therapeutic vulnerabilities, and prioritized candidate targets, with the aim of accelerating precision oncology approaches in this population.\nReproducibility of the entire analytical workflow was a central objective of this study, with particular attention to the needs of the genomics and bioinformatics communities. A dedicated, version-controlled companion repository is provided alongside this manuscript. The repository contains:\nThese resources enable any qualified research group to independently regenerate virtually all figures, tables, and statistical results reported herein when starting from the same raw or processed input data.\nWe deliberately adopted a policy of complete codebase openness, acknowledging that this exposes opportunities for methodological and computational refinement. We regard such openness as essential for collaborative science and actively encourage feedback from the research community to enhance analytical rigor, efficiency, and robustness. The repository will be continuously maintained and updated to incorporate evolving best practices and new algorithmic developments.\nBy integrating clinical relevance, computational transparency, and mechanistic insight, this study aims to bridge translational oncology, reproducible computational research, and fundamental oral cancer biology. We anticipate that the publicly available data and methods will facilitate improved diagnostic classification, more informed therapeutic decision-making, and deeper understanding of OSCC—particularly in Chinese and broader East Asian populations—while providing a reusable framework for molecular subtyping studies worldwide.\nAll data supporting the findings of this study are available within the article and its supplementary information files or from the corresponding author upon reasonable request. The source code and analysis pipeline are openly accessible at https://github.com/[your-repo]/OSCC_Chinese_Cohort_Subtyping under the MIT license.",
    "crumbs": [
      "Welcome"
    ]
  },
  {
    "objectID": "welcome.html#reproducible-research-and-open-science",
    "href": "welcome.html#reproducible-research-and-open-science",
    "title": "Welcome",
    "section": "",
    "text": "Fully scripted, end-to-end bioinformatics workflows implemented in Nextflow/Snakemake and R/Python\nExhaustive documentation of data preprocessing and quality-control procedures\nExact software versions, complete dependency lists, and containerized environments (Docker/Singularity) where applicable\nAll parameter settings and random seeds used\nIntermediate and final datasets sufficient for bit-for-bit replication of results",
    "crumbs": [
      "Welcome"
    ]
  },
  {
    "objectID": "intro.html",
    "href": "intro.html",
    "title": "Introduction",
    "section": "",
    "text": "Oral squamous cell carcinoma (OSCC) represents the most common malignancy of the oral cavity and remains a major public health challenge in many regions, particularly in East Asia where incidence rates are among the highest worldwide. Despite advances in surgery, radiotherapy, and systemic therapy, long-term survival has improved only modestly over the past decades, underscoring the need for a deeper molecular understanding to enable precision oncology approaches.\nIn this study, we performed comprehensive molecular subtyping of OSCC in one of the largest comprehensively profiled Chinese patient cohorts reported to date. By integrating multi-omics data with detailed clinical annotation, we aimed to define robust, clinically relevant subtypes, elucidate their biological drivers, and identify subtype-specific therapeutic vulnerabilities.\nThe following sections and accompanying Supplementary Materials describe the complete analytical workflow—from raw data acquisition and rigorous quality control through integrative clustering, downstream interpretation, and independent validation. All computational steps were implemented in a fully scripted, version-controlled, and containerized pipeline that is publicly released to ensure maximal transparency and reproducibility. We provide all source code, processed datasets, intermediate files, software environments, and detailed documentation in a dedicated repository.\nWe anticipate that the molecular framework and open analytical resources presented here will facilitate refined diagnostic classification, inform treatment decision-making, and accelerate the development of targeted therapeutic strategies for OSCC, particularly in East Asian populations.",
    "crumbs": [
      "Introduction"
    ]
  },
  {
    "objectID": "jilin.html",
    "href": "jilin.html",
    "title": "1  Datasets from the first hospital of Jilin University",
    "section": "",
    "text": "This dataset was newly curated for the current study and originates from The First Hospital of Jilin University. Sample collection spanned from 2017 through the end of 2023. The dataset includes 156 RNA-seq and 84 whole-genome sequencing (WGS) datasets derived from 135 individuals, and is expected to reflect the characteristics of Chinese or broader Asian populations to some extent.\nAmong the collected samples, there are 186 baseline (newly diagnosed) cases, 29 first relapse samples, 17 post-treatment (remission) cases, and 8 others. A total of 202 samples were purified CD138⁺ bone marrow cells, and 38 samples of paired PBMCs were also included, covering multiple clinical timepoints and sample types.\nFollowing Jonathan J. Keats’ recommendation, we sequenced whole-genome sequencing (WGS) data to &gt;90x coverage for tumor samples and &gt;30x for matched normals. Typically, 100 Gb corresponds to just over 30x coverage, which may suffice for copy number variation (CNV) analysis in some myeloma samples but is underpowered for detecting structural variants and mutations. Additionally, for mRNA sequencing, we targeted approximately 100 million reads per patient to account for the fact that ~50% of RNA derives from immunoglobulin production, ensuring robust gene expression profiling.\nIn addition, we generated single-cell RNA-seq data from two IgD-type MM samples at The First Hospital of Jilin University. These new data were assembled with public single-cell RNA-seq datasets of MM samples from multiple sources. All single-cell datasets were processed using a standardized pipeline to ensure consistent integration and quality control.",
    "crumbs": [
      "Data Collection",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Jilin dataset</span>"
    ]
  },
  {
    "objectID": "ngdc.html",
    "href": "ngdc.html",
    "title": "2  National Genomics Data Center (NGDC)",
    "section": "",
    "text": "We conducted a search for datasets related to “Multiple Myeloma” in the Genome Sequence Archive (GSA) for human studies at the National Genomics Data Center (NGDC), accessible via the URL: https://ngdc.cncb.ac.cn/search/specific?db=hra&q=Multiple+Myeloma.\nThe search returned 18 entries, of which two datasets, with accession numbers HRA005897 and HRA006164, were deemed relevant to our research objectives. These datasets were subsequently applied for and successfully incorporated into our study, providing valuable genomic data critical to advancing our understanding of Multiple Myeloma.\nWe express our sincere gratitude to Prof. Juan Li and Prof. Gang An for their contributions in generating and providing these high-quality datasets. Their expertise and dedication have significantly enriched our research. Additionally, we extend our appreciation to the National Genomics Data Center (NGDC) for hosting and maintaining the GSA, which facilitated seamless access to these datasets and supported our research efforts.",
    "crumbs": [
      "Data Collection",
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data from NGDC</span>"
    ]
  },
  {
    "objectID": "qc.html",
    "href": "qc.html",
    "title": "3  Quality control",
    "section": "",
    "text": "3.1 RNA-seq\nQuality control of RNA-seq, WGS and Single cell.\nRaw RNA-seq reads were first assessed using FastQC to evaluate per-base sequence quality, GC content, adapter contamination, and overrepresented sequences. Trimming of low-quality bases and adapter sequences was performed using trimgalore where necessary. Quantification was conducted using Salmon in quasi-mapping mode, with the GENCODE GRCh38 transcriptome as the reference. Transcript-level estimates were summarized to the gene level using tximport, and samples with low mapping rates, abnormal expression distributions, or poor complexity were excluded. Additional checks included principal component analysis (PCA) for outlier detection and sample identity verification via gender marker expression (e.g., XIST, DDX3Y).",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Quality Control</span>"
    ]
  },
  {
    "objectID": "qc.html#wgs",
    "href": "qc.html#wgs",
    "title": "3  Quality control",
    "section": "3.2 WGS",
    "text": "3.2 WGS\nInitial QC involving FastQC and trimgalore were also applied for WGS data, where potential low quality bases, adapter contamination, and sequencing errors will be removed in this step. For WGS data, raw reads were aligned to the GRCh38 reference genome using BWA. Duplicates were marked using Picard, and base quality score recalibration (BQSR) was performed with GATK. Coverage metrics, insert size distributions, and depth uniformity were assessed using samtools.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Quality Control</span>"
    ]
  },
  {
    "objectID": "qc.html#single-cell",
    "href": "qc.html#single-cell",
    "title": "3  Quality control",
    "section": "3.3 Single cell",
    "text": "3.3 Single cell\nSingle-cell RNA-seq data were processed and quality-controlled following established best practices. Raw sequencing data were aligned and quantified using Cell Ranger (v9.01, 10x Genomics) against the GRCh38 human reference genome. Downstream filtering and normalization were performed using the Seurat (v5.1) R package. Low-quality cells were excluded based on three primary metrics: * Number of detected genes (nFeature_RNA): Cells with fewer than 200 or more than 5,000 detected genes were excluded to remove likely empty droplets and potential doublets, respectively. * UMI counts (nCount_RNA): Cells with abnormally low or high total RNA counts were removed to avoid low-complexity cells and potential multiplets. * Mitochondrial gene percentage (%MT): Cells with &gt;15% of total reads mapping to mitochondrial genes were excluded, as this indicates potential apoptosis or technical stress. After initial filtering, datasets were log-normalized and scaled. Highly variable genes were selected for dimensionality reduction, and principal component analysis (PCA) was used to identify potential batch effects and outliers. In addition to these general QC metrics, a biological filter was applied due to the CD138⁺ selection of bone marrow plasma cells prior to sequencing. To ensure that the resulting single-cell data represented the intended plasma cell population, we retained only samples in which plasma cells accounted for at least 50% of the total cells, as determined by canonical plasma cell markers (e.g., SDC1/CD138, MZB1, PRDM1, XBP1). This threshold ensured consistency with the experimental design and reduced the impact of technical noise or sample impurity in CD138-enriched datasets. Samples failing this criterion were excluded from downstream analysis.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Quality Control</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html",
    "href": "batchrnaseq.html",
    "title": "4  Batch correction for RNA-seq data",
    "section": "",
    "text": "4.1 Setup\nBatch effect correction is a technically challenging task, and a common question in the field is: what constitutes an effective batch effect correction strategy? I recommend a correction method that enables samples to cluster based on their biological characteristics rather than their technical or data source origins. For instance, after correction, samples with shared gene fusions or hotspot mutations should cluster together, regardless of the batch in which they were processed. This indicates that the correction preserves biologically meaningful signals while minimizing technical variation.\nTo evaluate this, we performed batch correction on gene expression profiles using dataset origin as the batch variable and assessed the correction’s effectiveness through unsupervised clustering. Notably, samples with specific genomic alterations, such as the t(4;14) translocation, remained tightly clustered, indicating that the corrected expression data retained biologically relevant structure and validated the correction strategy. Below is a step-by-step description of how we explored batch effects in the data.\nLoad required R packages and set the working directory.\n# Load necessary R packages for data processing and visualization\npkgs &lt;- c(\"fs\", \"jhuanglabRNAseq\", \"umap\", \"stringr\", \"ggpubr\", \"ggthemes\",\n          \"jhtools\", \"Rtsne\", \"scatterplot3d\", \"patchwork\", \"tidyverse\", \"dplyr\")\nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = TRUE))\n}\n\n# Define project parameters\nproject &lt;- \"mm\"\ndataset &lt;- \"meta\"\nspecies &lt;- \"human\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/rnaseq\")\nsetwd(workdir)",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html#data-loading",
    "href": "batchrnaseq.html#data-loading",
    "title": "4  Batch correction for RNA-seq data",
    "section": "4.2 Data Loading",
    "text": "4.2 Data Loading\nLoad RNA-Seq expression data from three cohorts: Jilin, CoMMpass, and Public. Convert data frames for plotting and check their dimensions.\n\n# Load and preprocess Jilin dataset\njilin_exp &lt;- \"~/projects/mm/analysis/jilin/human/rnaseq/exp/tables/jilin_human.csv\" |&gt;\n  read_csv(show_col_types = FALSE, progress = FALSE) |&gt; \n  convert_df_plot()\n\n# Load and preprocess CoMMpass dataset\ncommpass_exp &lt;- \"~/projects/mm/analysis/commpass/human/rnaseq/exp/tables/commpass_human.csv\" |&gt;\n  read_csv(show_col_types = FALSE, progress = FALSE) |&gt; \n  convert_df_plot()\n\n# Load and preprocess Public dataset\npublic_exp_raw &lt;- \"~/projects/mm/analysis/public/human/rnaseq/exp/tables/public_human.csv\" |&gt;\n  read_csv(show_col_types = FALSE, progress = FALSE)\npublic_exp &lt;- public_exp_raw |&gt; convert_df_plot()\n\n# Check dimensions of each dataset\nsapply(list(jilin_exp, commpass_exp, public_exp), dim)\n\nBatch Information and Color Palette Define batch labels and a color palette for visualization.\n\n# Define color palette for cohorts\ncolor_palette &lt;- c(\n  Jilin    = \"#ff0000\",\n  CoMMpass = \"#74d7ff\",\n  Public   = \"#4cb049\"\n)\n\n# Create batch vector for samples\nbatch &lt;- c(\n  rep(\"Jilin\",    ncol(jilin_exp)),\n  rep(\"CoMMpass\", ncol(commpass_exp)),\n  rep(\"Public\",   ncol(public_exp))\n)\n\n# Map batch labels to colors\ncolor_before &lt;- factor(batch, levels = names(color_palette)) |&gt;\n  fct_relevel(unique(batch)) |&gt;\n  as.character() |&gt;\n  recode(!!!color_palette)",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html#batch-correction",
    "href": "batchrnaseq.html#batch-correction",
    "title": "4  Batch correction for RNA-seq data",
    "section": "4.3 Batch Correction",
    "text": "4.3 Batch Correction\nCombine datasets and apply ComBat batch correction to remove batch effects.\n\n# Combine expression data from all cohorts\ndat_exp &lt;- bind_cols(jilin_exp, commpass_exp, public_exp)\n\n# Apply ComBat batch correction\ncombat_dat &lt;- sva::ComBat(dat = as.matrix(dat_exp), batch = batch, \n                         par.prior = TRUE, prior.plots = FALSE)\n\n# Convert corrected data to data frame and add gene IDs\ndat_raw &lt;- combat_dat |&gt; as.data.frame() |&gt; \n           rownames_to_column(var = \"gene_name\")\ndat_out &lt;- left_join(dat_raw, public_exp_raw[, c(\"gene_id\", \"gene_name\")], \n                     by = \"gene_name\") |&gt;\n           relocate(\"gene_id\") |&gt; as_tibble()",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html#data-filtering",
    "href": "batchrnaseq.html#data-filtering",
    "title": "4  Batch correction for RNA-seq data",
    "section": "4.4 Data Filtering",
    "text": "4.4 Data Filtering\nFilter out blacklisted genes and select highly variable genes (HVGs) for downstream analysis.\n\n# Load blacklist of genes to exclude\nblacklist &lt;- read_rds(\"~/projects/mm/docs/meta/sampleinfo/heatmap_blacklist.rds\")\n\n# Filter out blacklisted genes from data before and after correction\ndat_before &lt;- dat_exp |&gt; \n  rownames_to_column(var = \"gene_name\") |&gt; \n  anti_join(blacklist, by = \"gene_name\") |&gt; \n  column_to_rownames(var = \"gene_name\")\n\ndat_after &lt;- dat_out |&gt; \n  anti_join(blacklist, by = \"gene_name\") |&gt; \n  dplyr::select(-gene_id) |&gt; \n  column_to_rownames(var = \"gene_name\")\n\n# Function to select highly variable genes (top 10% by variance)\nselect_hvg &lt;- function(data, p = 0.9) {\n  data |&gt; as.data.frame() |&gt;\n    rownames_to_column(var = \"gene\") |&gt;\n    rowwise() |&gt;\n    mutate(var = var(c_across(everything()))) |&gt;\n    ungroup() |&gt;\n    filter(var &gt;= quantile(var, probs = p)) |&gt;\n    select(-var, -gene) |&gt;\n    as.matrix() |&gt; t()\n}\n\n# Select HVGs for before and after batch correction\ndat_before_mat &lt;- select_hvg(dat_before, p = 0.9)\ndat_after_mat &lt;- select_hvg(dat_after, p = 0.9)",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html#pca-analysis",
    "href": "batchrnaseq.html#pca-analysis",
    "title": "4  Batch correction for RNA-seq data",
    "section": "4.5 PCA Analysis",
    "text": "4.5 PCA Analysis\nPerform PCA on the data before and after batch correction and generate 2D and 3D plots.\n\n4.5.1 PCA Before Batch Correction\n\n# Perform PCA on data before batch correction\npca_before &lt;- prcomp(dat_before_mat, scale. = TRUE)\n\n# 2D PCA Plot\nexplained_var &lt;- summary(pca_before)$importance[2, 1:2] * 100\nxlab_text &lt;- paste0(\"PC1 (Explained Variance: \", round(explained_var[1], 2), \"%)\")\nylab_text &lt;- paste0(\"PC2 (Explained Variance: \", round(explained_var[2], 2), \"%)\")\npdf(\"pcaBeforeSVA-2d.pdf\", width = 6, height = 6)\n  plot(pca_before$x[, 1:2], pch = 16, cex = 0.6,\n       xlab = xlab_text, ylab = ylab_text,\n       col = color_before,\n       main = \"PCA Before SVA\")\n  legend(\"topright\", legend = unique(batch),\n         col = unique(color_before), pch = 16, cex = 0.6)\ndev.off()\n\n\n\n\n\n\n\n\nPCA plot before batch correction.\n\n\n\n# 3D PCA Plot\npdf(\"pcaBeforeSVA-3d.pdf\", width = 8, height = 8)\n  for (ang in seq(-360, 360, by = 5)) {\n    scatterplot3d(\n      x = pca_before$x[, 1], y = pca_before$x[, 2], z = pca_before$x[, 3],\n      main = \"PCA Before SVA\", color = color_before,\n      type = \"p\", pch = 16,\n      cex.symbols = 1.2,\n      angle = ang, grid = TRUE, box = TRUE,\n      scale.y = 1,\n      col.grid = \"lightblue\"\n    )\n    legend(\"topright\",\n           legend = unique(batch),\n           fill = color_before,\n           box.col = \"grey\",\n           title = \"Cohorts\")\n  }\ndev.off()\n\n\n\n\nPCA plot before batch correction.\n\n\n\n\n4.5.2 PCA After Batch Correction\n\n# Perform PCA on data after batch correction\npca_after &lt;- prcomp(dat_after_mat, scale. = TRUE)\n\n# 2D PCA Plot\nexplained_var &lt;- summary(pca_after)$importance[2, 1:2] * 100\nxlab_text &lt;- paste0(\"PC1 (Explained Variance: \", round(explained_var[1], 2), \"%)\")\nylab_text &lt;- paste0(\"PC2 (Explained Variance: \", round(explained_var[2], 2), \"%)\")\npdf(\"pcaAfterSVA-2d.pdf\", width = 6, height = 6)\n  plot(pca_after$x[, 1:2], pch = 16, cex = 0.6,\n       xlab = xlab_text, ylab = ylab_text,\n       col = color_before,\n       main = \"PCA After SVA\")\n  legend(\"topright\", legend = unique(batch),\n         col = unique(color_before), pch = 16, cex = 0.6)\ndev.off()\n\n\n\n\nPCA plot after batch correction.\n\n\n\n# 3D PCA Plot\npdf(\"pcaAfterSVA-3d.pdf\", width = 8, height = 8)\n  for (ang in seq(-360, 360, by = 5)) {\n    scatterplot3d(\n      x = pca_after$x[, 1], y = pca_after$x[, 2], z = pca_after$x[, 3],\n      main = \"PCA After SVA\", color = color_before,\n      type = \"p\", pch = 16,\n      cex.symbols = 1.2,\n      angle = ang, grid = TRUE, box = TRUE,\n      scale.y = 1,\n      col.grid = \"lightblue\"\n    )\n    legend(\"topright\",\n           legend = unique(batch),\n           fill = color_before,\n           box.col = \"grey\",\n           title = \"Cohorts\")\n  }\ndev.off()\n\n\n\n\nPCA plot after batch correction.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html#t-sne-analysis",
    "href": "batchrnaseq.html#t-sne-analysis",
    "title": "4  Batch correction for RNA-seq data",
    "section": "4.6 t-SNE Analysis",
    "text": "4.6 t-SNE Analysis\nPerform t-SNE on the data before and after batch correction and generate 2D plots.\n\n4.6.1 t-SNE Before Batch Correction\n\n# Perform t-SNE on data before batch correction\ntsne_before &lt;- Rtsne(dat_before_mat, perplexity = 30, max_iter = 1000,\n                     verbose = FALSE, check_duplicates = FALSE)\ntsne_df &lt;- as.data.frame(tsne_before$Y)\ncolnames(tsne_df) &lt;- c(\"tSNE_1\", \"tSNE_2\")\ntsne_df$Cohorts &lt;- factor(batch)\ntsne_df$color &lt;- color_before\n\n# Plot t-SNE\npdf(\"tsneBeforeSVA.pdf\", width = 6, height = 4)\n  ggplot(tsne_df, aes(x = tSNE_1, y = tSNE_2, color = Cohorts)) +\n    geom_point(size = 0.8) +\n    theme_classic() +\n    scale_color_manual(values = setNames(color_before, batch)) +\n    guides(color = guide_legend(override.aes = list(size = 3)))\ndev.off()\n\n\n\n\ntSNE plot before batch correction.\n\n\n\n\n4.6.2 t-SNE After Batch Correction\n\n# Perform t-SNE on data after batch correction\ntsne_after &lt;- Rtsne(dat_after_mat, perplexity = 30, max_iter = 1000,\n                    verbose = FALSE, check_duplicates = FALSE)\ntsne_df &lt;- as.data.frame(tsne_after$Y)\ncolnames(tsne_df) &lt;- c(\"tSNE_1\", \"tSNE_2\")\ntsne_df$Cohorts &lt;- factor(batch)\ntsne_df$color &lt;- color_before\n\n# Plot t-SNE\npdf(\"tsneAfterSVA.pdf\", width = 6, height = 4)\n  ggplot(tsne_df, aes(x = tSNE_1, y = tSNE_2, color = Cohorts)) +\n    geom_point(size = 0.8) +\n    theme_classic() +\n    scale_color_manual(values = setNames(color_before, batch)) +\n    guides(color = guide_legend(override.aes = list(size = 3)))\ndev.off()\n\n\n\n\ntSNE plot after batch correction.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html#umap-analysis",
    "href": "batchrnaseq.html#umap-analysis",
    "title": "4  Batch correction for RNA-seq data",
    "section": "4.7 UMAP Analysis",
    "text": "4.7 UMAP Analysis\nPerform UMAP on the data before and after batch correction and generate 2D plots.\n\n4.7.1 UMAP Before Batch Correction\n\n# Perform UMAP on data before batch correction\numap_before &lt;- umap(dat_before_mat, n_neighbors = 15,\n                    n_components = 2, min_dist = 0.1,\n                    metric = \"euclidean\")\numap_df &lt;- as.data.frame(umap_before$layout)\ncolnames(umap_df) &lt;- c(\"UMAP_1\", \"UMAP_2\")\numap_df$Cohorts &lt;- factor(batch)\numap_df$color &lt;- color_before\n\n# Plot UMAP\npdf(\"umapBeforeSVA.pdf\", width = 6, height = 4)\n  ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = Cohorts)) +\n    geom_point(size = 0.8) +\n    theme_classic() +\n    scale_color_manual(values = setNames(color_before, batch)) +\n    guides(color = guide_legend(override.aes = list(size = 3)))\ndev.off()\n\n\n\n\nUMAP plot before batch correction.\n\n\n\n\n4.7.2 UMAP After Batch Correction\n\n# Perform UMAP on data after batch correction\numap_after &lt;- umap::umap(dat_after_mat, n_neighbors = 15,\n                   n_components = 2, min_dist = 0.1,\n                   metric = \"euclidean\")\numap_df &lt;- as.data.frame(umap_after$layout)\ncolnames(umap_df) &lt;- c(\"UMAP_1\", \"UMAP_2\")\numap_df$Cohorts &lt;- factor(batch)\numap_df$color &lt;- color_before\n\n# Plot UMAP\npdf(\"umapAfterSVA.pdf\", width = 6, height = 4)\n  ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = Cohorts)) +\n    geom_point(size = 0.8) +\n    theme_classic() +\n    scale_color_manual(values = setNames(color_before, batch)) +\n    guides(color = guide_legend(override.aes = list(size = 3)))\ndev.off()\n\n\n\n\nUMAP plot after batch correction.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchrnaseq.html#conclusion",
    "href": "batchrnaseq.html#conclusion",
    "title": "4  Batch correction for RNA-seq data",
    "section": "4.8 Conclusion",
    "text": "4.8 Conclusion\nBased on this analysis and the resulting plots, we are confident that our approach effectively controls for batch effects in the data.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Batch RNAseq</span>"
    ]
  },
  {
    "objectID": "batchscrnaseq.html",
    "href": "batchscrnaseq.html",
    "title": "5  Batch correction for single-cell RNA-seq data",
    "section": "",
    "text": "To enable integrative analysis of single-cell RNA-seq data collected from multiple sources, we performed batch effect correction using the Seurat (v5.1) integration workflow. Briefly, each dataset was first normalized and processed independently using NormalizeData(), FindVariableFeatures(), and ScaleData(). Highly variable genes were identified within each dataset and used for subsequent anchor-based integration.\nIntegration anchors were computed using FindIntegrationAnchors() across datasets, followed by IntegrateData() to generate a batch-corrected expression matrix. The integrated data were then used for downstream dimensionality reduction, clustering, and visualization. To verify the effectiveness of batch correction, we assessed sample mixing in low-dimensional embeddings and examined the alignment of known biological signals across datasets.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Batch SingleCell</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html",
    "href": "single_cell_integrate.html",
    "title": "6  Seurat object construction",
    "section": "",
    "text": "6.1 GSE164690 Seurat object construction\nThe following code was used to generate the Seurat object and associated metadata for GSE164690, forming the foundation for all subsequent workflows.",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html#gse164690-seurat-object-construction",
    "href": "single_cell_integrate.html#gse164690-seurat-object-construction",
    "title": "6  Seurat object construction",
    "section": "",
    "text": "6.1.1 GSE164690 Seurat object quality control\n\n\n6.1.2 GSE164690 normalize\n\n\n6.1.3 GSE164690 Seurat object marker genes umap plot\n\np1 &lt;- DimPlot(srt, reduction = \"umap\") \np2 &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"sample_id\")\np &lt;- p1 + p2\nggsave(glue(figure_dir,\"output/preprocess/GSE164690_umap_cluster_sample.pdf\"), p, width = 14, height = 6)\nmarkers &lt;- c(\"CD3D\", \"CD8A\", \"CD4\", \"IL7R\", \"FOXP3\", \"CD19\", \"CD79A\", \"CD79B\", \"IL3RA\", \"NCAM1\", \"NCR1\", \"KLRD1\", \n             \"CSF1R\", \"MST1R\", \"CD14\", \"MS4A7\", \"CD68\", \"CD83\", \"FCGR1A\", \"LAMP3\", \"FPR1\", \"THBD\", \"CD80\", \"CD86\", \"CD1C\", \"CD209\",\n             \"LYZ\", \"TPSB2\", \"TPSAB1\", \n             \"CLDN5\", \"FLT1\", \"CDH5\", \"RAMP2\", \"EPCAM\", \"KRT14\", \"KRT17\", \"COL1A1\", \"DCN\", \"COL1A2\", \"RGS5\")\np &lt;- FeaturePlot(srt, features = markers, ncol = 5, raster = TRUE)\nggsave(glue(figure_dir,\"output/preprocess/GSE164690_umap_markers.pdf\"), p, width = 18, height = 26)\nsaveRDS(srt, glue(rds_dir, \"output/preprocess/GSE164690_srt.rds\"))",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html#gse172577-seurat-object-construction",
    "href": "single_cell_integrate.html#gse172577-seurat-object-construction",
    "title": "6  Seurat object construction",
    "section": "6.2 GSE172577 Seurat object construction",
    "text": "6.2 GSE172577 Seurat object construction\nThe following code was used to generate the Seurat object and associated metadata for GSE172577, forming the foundation for all subsequent workflows.\n\n6.2.1 GSE172577 Seurat object quality control\n\n\n6.2.2 GSE172577 Seurat object normalize\n\n\n6.2.3 GSE172577 Seurat object marker genes umap plot\n\np1 &lt;- DimPlot(srt, reduction = \"umap\") \np2 &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"sample_id\")\np &lt;- p1 + p2\nggsave(glue(figure_dir,\"output/preprocess/GSE172577_umap_cluster_sample.pdf\"), p, width = 14, height = 6)\nmarkers &lt;- c(\"CD3D\", \"CD79A\", \"LYZ\", \"TPSAB1\", \n             \"EPCAM\", \"RGS5\", \"PDGFRA\", \"PECAM1\")\np &lt;- FeaturePlot(srt, features = markers, ncol = 4, raster = TRUE)\nggsave(glue(figure_dir,\"output/preprocess/GSE172577_umap_markers.pdf\"), p, width = 15, height = 8)\nsaveRDS(srt, glue(rds_dir,\"output/preprocess/GSE172577_srt.rds\"))",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html#gse188737-seurat-object-construction",
    "href": "single_cell_integrate.html#gse188737-seurat-object-construction",
    "title": "6  Seurat object construction",
    "section": "6.3 GSE188737 Seurat object construction",
    "text": "6.3 GSE188737 Seurat object construction\nThe following code was used to generate the Seurat object and associated metadata for GSE188737, forming the foundation for all subsequent workflows.\n\n6.3.1 GSE215403 Seurat object marker genes umap plot\n\np1 &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"seurat_clusters\") \np2 &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"sample_id\")\np3 &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"cell_type\")\np &lt;- p1 + p2 + p3\nggsave(glue(figure_dir,\"output/preprocess/GSE188737_umap_cluster_sample_celltype.pdf\"), p, width = 20, height = 6)\nsaveRDS(srt, glue(\"{dat_dir}/GSE188737_srt.rds\"))",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html#gse215403-seurat-object-construction",
    "href": "single_cell_integrate.html#gse215403-seurat-object-construction",
    "title": "6  Seurat object construction",
    "section": "6.4 GSE215403 Seurat object construction",
    "text": "6.4 GSE215403 Seurat object construction\nThe following code was used to generate the Seurat object and associated metadata for GSE215403, forming the foundation for all subsequent workflows.\n\n6.4.1 GSE215403 Seurat object quality control\n\n\n6.4.2 GSE215403 Seurat object marker genes umap plot\n\np1 &lt;- DimPlot(srt, reduction = \"umap\") \np2 &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"sample_id\")\np &lt;- p1 + p2\nggsave(glue(figure_dir,\"output/preprocess/GSE215403_umap_cluster_sample.pdf\"), p, width = 14, height = 6)\nmarkers &lt;- c(\"CD3D\", \"CD79A\", \"LYZ\", \"TPSAB1\", \n             \"EPCAM\", \"RGS5\", \"PDGFRA\", \"PECAM1\")\np &lt;- FeaturePlot(srt, features = markers, ncol = 4, raster = TRUE)\nggsave(glue(figure_dir,\"output/preprocess/GSE215403_umap_markers.pdf\"), p, width = 15, height = 8)\nsaveRDS(srt, glue(rds_dir,\"output/preprocess/GSE215403_srt.rds\"))",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html#gse234933-seurat-object-construction",
    "href": "single_cell_integrate.html#gse234933-seurat-object-construction",
    "title": "6  Seurat object construction",
    "section": "6.5 GSE234933 Seurat object construction",
    "text": "6.5 GSE234933 Seurat object construction\nThe following code was used to generate the Seurat object and associated metadata for GSE234933, forming the foundation for all subsequent workflows.\n\n6.5.1 GSE234933 Seurat object quality control\n\n\n6.5.2 GSE234933 Seurat object normalize\n\n\n6.5.3 GSE234933 Seurat object marker genes umap plot\n\np1 &lt;- DimPlot(srt, reduction = \"umap\") \np2 &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"sample_id\")\np &lt;- p1 + p2\nggsave(glue(figure_dir,\"output/preprocess/GSE234933_umap_cluster_sample.pdf\"), p, width = 14, height = 6)\nmarkers &lt;- c(\"CD3D\", \"CD79A\", \"LYZ\", \"TPSAB1\", \n             \"EPCAM\", \"RGS5\", \"PDGFRA\", \"PECAM1\",\n             \"FCGR3B\", \"CXCR1\", \"CXCR2\", \"PI3\", \"G0S2\", \"CSF3R\")\np &lt;- FeaturePlot(srt, features = markers, ncol = 4, raster = TRUE)\nggsave(glue(figure_dir, \"output/preprocess/GSE234933_umap_markers.pdf\"), p, width = 15, height = 16)\nsaveRDS(srt, glue(rds_dir,\"output/preprocess/GSE234933_srt.rds\"))",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html#seurat-object-integration-process",
    "href": "single_cell_integrate.html#seurat-object-integration-process",
    "title": "6  Seurat object construction",
    "section": "7.1 Seurat object integration process",
    "text": "7.1 Seurat object integration process\n\n# integrate cca\nsrt &lt;- IntegrateLayers(srt, method = CCAIntegration, orig.reduction = \"pca\", new.reduction = \"cca\")\nsrt &lt;- JoinLayers(srt)\n\nsrt &lt;- FindNeighbors(srt, reduction = \"cca\", dims = 1:30) %&gt;%\n  RunUMAP(dims = 1:30, reduction = \"cca\") %&gt;%\n  FindClusters(resolution = 0.8)\np &lt;- DimPlot(srt, reduction = \"umap\", group.by = c(\"dataset\", \"seurat_clusters\", \"cell_type\"), raster = TRUE)\nggsave(glue(figure_dir,\"output/integrate/umap_dataset_cluster_integrated.pdf\"), p, width = 18, height = 5)\nmarkers &lt;- c(\"PTPRC\", \"CD3D\", \"NKG7\", \"CD79A\", \"JCHAIN\", \"LYZ\", \"CD163\", \"LAMP3\", \"IGHG1\", \"TPSAB1\", \n             \"EPCAM\", \"KRT7\", \"KRT17\", \"STATH\", \"COL1A2\", \"RGS5\", \"PDGFRA\", \"PECAM1\")\np &lt;- FeaturePlot(srt, reduction = \"umap\", features = markers, ncol = 4, raster = TRUE)\nggsave(glue(figure_dir,\"output/integrate/umap_markers_integrated.pdf\"), p, width = 15, height = 16)\n\n# integrate harmony\nsrt[[\"RNA\"]] &lt;- split(srt[[\"RNA\"]], f = srt$dataset)\nsrt &lt;- IntegrateLayers(srt, method = HarmonyIntegration, orig.reduction = \"pca\", new.reduction = \"harmony\")\nsrt &lt;- JoinLayers(srt)\n\nsrt &lt;- FindNeighbors(srt, reduction = \"harmony\", dims = 1:10) %&gt;%\n  RunUMAP(dims = 1:10, reduction = \"harmony\", reduction.name = \"umap.harmony\") %&gt;%\n  FindClusters(resolution = 0.8, cluster.name = \"harmony_clusters\")\np &lt;- DimPlot(srt, reduction = \"umap.harmony\", group.by = c(\"dataset\", \"harmony_clusters\", \"cell_type\"), raster = TRUE)\nggsave(glue(figure_dir,\"output/integrate/umap_dataset_cluster_integrated_harmony.pdf\"), p, width = 18, height = 5)\nmarkers &lt;- c(\"PTPRC\", \"CD3D\", \"NKG7\", \"CD79A\", \"JCHAIN\", \"LYZ\", \"CD163\", \"LAMP3\", \"IGHG1\", \"TPSAB1\", \n             \"EPCAM\", \"KRT7\", \"KRT17\", \"STATH\", \"COL1A2\", \"RGS5\", \"PDGFRA\", \"PECAM1\")\np &lt;- FeaturePlot(srt, reduction = \"umap.harmony\", features = markers, ncol = 4, raster = TRUE)\nggsave(glue(figure_dir,\"output/integrate/umap_markers_integrated_harmony.pdf\"), p, width = 15, height = 16)\n\n# transfer anno\nhnscc.ref &lt;- readRDS(glue(rds_dir, \"output/preprocess/GSE188737_srt.rds\"))\nhnscc.anchors &lt;- FindTransferAnchors(reference = hnscc.ref, query = srt, dims = 1:30,\n                                     reference.reduction = \"pca\")\npredictions &lt;- TransferData(anchorset = hnscc.anchors, refdata = hnscc.ref$cell_type, dims = 1:30)\nsrt &lt;- AddMetaData(srt, metadata = predictions$predicted.id, col.name = \"celltype.pre\")\nsrt$celltype.pre[srt$celltype.pre == \"T cells\"] &lt;- \"T cell\" # 统一名称用\nsrt$celltype.pre[srt$celltype.pre == \"B cells\"] &lt;- \"B cell\" # 统一名称用\nsrt$celltype.pre[srt$celltype.pre == \"plasma cells\"] &lt;- \"Plasma\" # 统一名称用\nsrt$celltype.pre[srt$celltype.pre == \"mature DC\"] &lt;- \"DC\" # 统一名称用\nsrt$celltype.pre[srt$celltype.pre == \"Mast cells\"] &lt;- \"Mast\" # 统一名称用\nsaveRDS(srt, glue(rds_dir,\"srt_integrated.rds\"))\np &lt;- DimPlot(srt, reduction = \"umap\", group.by = \"celltype.pre\", raster = TRUE) +\n  scale_color_manual(values = color_ct)\nggsave(glue(figure_dir,\"output/integrate/umap_celltype_predicted.pdf\"), p, width = 6, height = 5)",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "single_cell_integrate.html#cluster-annotation-of-seurat-objects-using-gse188737",
    "href": "single_cell_integrate.html#cluster-annotation-of-seurat-objects-using-gse188737",
    "title": "6  Seurat object construction",
    "section": "7.2 Cluster Annotation of Seurat Objects Using GSE188737",
    "text": "7.2 Cluster Annotation of Seurat Objects Using GSE188737\n\np &lt;- DotPlot(srt, features = markers) + \n  RotatedAxis() +\n  scale_colour_gradient(low =c(\"white\"), high =c(\"red\"))\nggsave(glue(figure_dir,\"output/integrate/dotplot_cell_types_markers.pdf\"), p, width = 12, height = 12)\np &lt;- DimPlot(srt, reduction = \"umap\", label = TRUE, raster = TRUE)\nggsave(glue(figure_dir,\"output/integrate/umap_clusters.pdf\"), p, width = 6, height = 5)\ndt_anno &lt;- fread(\"output/integrate/anno.tsv\") ## unsaved\nsrt$celltype &lt;- dt_anno$celltype[match(srt$seurat_clusters, dt_anno$seurat_clusters)]\nsrt &lt;- subset(srt, subset = celltype != \"unknown\")\nIdents(srt) &lt;- srt$celltype\nsrt &lt;- RenameIdents(srt, \n                   \"B cells\" = \"B cell\",      # 统一名称用\n                   \"Plasma cells\" = \"Plasma\",     # 统一名称用\n                   \"TAMs\" = \"TAM\", # 统一名称用\n                   \"Mast cells\" = \"Mast\") # 统一名称用\nsrt@meta.data$celltype &lt;- Idents(srt)\n\nn_cells &lt;- round(table(srt$celltype)/6)\nids &lt;- mapply(function(name, n_cell){\n  subset(srt, idents = name) %&gt;%\n    subset(downsample = n_cell) %&gt;%\n    colnames\n}, names(n_cells), n_cells) %&gt;% unlist\nsrt_s &lt;- subset(srt, cells = ids)\np &lt;- DimPlot(srt_s, reduction = \"umap\", group.by = \"celltype\") +\n  scale_color_manual(values = color_celltype)\nggsave(glue(figure_dir,\"output/integrate/umap_celltype.pdf\"), p, width = 6, height = 5)\nsrt$celltype &lt;- factor(srt$celltype, levels = names(color_celltype))\nsrt[[\"percent.mt\"]] &lt;- PercentageFeatureSet(srt, pattern = \"^MT-\")\nsaveRDS(srt, glue(rds_dir, \"srt_integrated_anno.rds\"))",
    "crumbs": [
      "Data Preprocessing",
      "<span class='chapter-number'>6</span>  <span class='chapter-title'>Cell Integration</span>"
    ]
  },
  {
    "objectID": "subtypes.html",
    "href": "subtypes.html",
    "title": "7  Subtypes",
    "section": "",
    "text": "7.1 Unsupervised cluster\nWe defined subtypes based on the clustering of gene expression data, which was performed using the most highly variable genes across the samples. The clustering results were visualized using a heatmap, where each sample was annotated with its corresponding subtype. This approach allowed us to identify distinct subgroups within the dataset, facilitating further analysis of their unique characteristics and potential clinical implications.\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"ggpubr\", \"ggthemes\",\n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\",\n          \"circlize\", \"ComplexHeatmap\", \"GenomicRanges\", \"jhuanglabRNAseq\", \"ggh4x\")\nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nproject &lt;- \"mm\"\ndataset &lt;- \"meta\"\nspecies &lt;- \"human\"\nworkdir &lt;- glue(\"~/projects/{project}/analysis/{dataset}/{species}/rnaseq/figures/heatmap\") |&gt; checkdir()\nsetwd(workdir)\nset.seed(2025)\ndf &lt;- \"~/projects/mm/docs/meta/sampleinfo/sampleinfo_jilin_commpass.rds\" |&gt;\n  read_rds()\n\njinlin_commpass_heatmap_only &lt;- \"~/projects/mm/analysis/meta/human/rnaseq/exp/jinlin_commpass_heatmap_only.rds\" |&gt; read_rds()\ndat_exp &lt;- \"~/projects/mm/analysis/meta/human/rnaseq/exp/mm_heatmap1117.rds\" |&gt;\n  read_rds() |&gt; convert_df_plot()\ncogene &lt;- base::intersect(rownames(dat_exp), rownames(jinlin_commpass_heatmap_only))\n\nsubdf &lt;- df |&gt; dplyr::filter(sample_id %in% colnames(dat_exp))\n\n\nconfig_fn = \"~/projects/mm/analysis/jilin/human/rnaseq/configs/colors.yaml\"\nconfig_list &lt;- show_me_the_colors(config_fn, \"all\")\n\ncol &lt;- config_list[c(\n  \"batch\",\"Clinical_IgH\", \"RNA_Subtype_Name\",\n  \"PrimaryCluster\", \"Tx_MAF\",\"Tx_MAFA\",\"Tx_MAFB\",\n  \"Tx_CCND1\", \"Tx_CCND2\", \"Tx_CCND3\", \"Tx_NSD2\"\n)]\ncol$Dom_IgH_Type &lt;- col$Clinical_IgH\nnames(col$Dom_IgH_Type) &lt;- c(\"IGHE\", \"IGHA\", \"IGHD\", \"IGHG\", \"IGHM\", \"others\")\ncol$PrimaryCluster &lt;- c(col$PrimaryCluster, \"IgD\" = \"#FF00FF\")\ncol$batch[] &lt;- \"gray\"\ncol$datasets &lt;- c(col$batch, \"EGAD00001007813\" = \"green\", \"HRA006164\" = \"red\", bmc = \"orange\")\ncol$datasets &lt;- c(col$batch, \"EGAD00001007813\" = \"gray\", \"HRA006164\" = \"red\", bmc = \"orange\")\ncol$IRF4_mut &lt;- c(\"TRUE\" = \"#DC143C\" , \"FALSE\" = \"gray\")\nall_scores &lt;- c(\n  \"Zhan_et_al_CD-1\",\"Zhan_et_al_CD-2\",\"Zhan_et_al_HP\",\"Zhan_et_al_LB\",\"Zhan_et_al_MF\",\n  \"Zhan_et_al_MS\",\"Zhan_et_al_PR\",\"Broyl_et_al_MF\",\"Broyl_et_al_CTA\",\"Broyl_et_al_CD2\",\n  \"Broyl_et_al_LB\",\"Broyl_et_al_Myeloid\",\"Broyl_et_al_CD1\",\"Broyl_et_al_MS\",\"Broyl_et_al_PR\",\n  \"Broyl_et_al_HP\",\"Broyl_et_al_NFKB\",\"Broyl_et_al_PRL3\",\"GEP70\",\"Sheri_et_al_MAF\",\n  \"Sheri_et_al_CD1\",\"Sheri_et_al_CD2a\",\"Sheri_et_al_CD2b\",\"Sheri_et_al_MS\",\n  \"Sheri_et_al_1q gain\",\"Sheri_et_al_PR\",\"Sheri_et_al_HRD, MYC, low NFkB\",\n  \"Sheri_et_al_Low purity\",\"Sheri_et_al_HRD, low TP53\",\"Sheri_et_al_HRD, ++15\",\n  \"Sheri_et_al_HRD, ++15, MYC\"\n)\nfor(i in all_scores){\n  col[[i]] &lt;- circlize::colorRamp2(quantile(subdf[[i]], c(0.1,0.5,0.9), na.rm = T), colors = c(\"#1E90FF\", \"white\", \"#DC143C\"))\n}\nout_dir &lt;- \"step1\" |&gt; checkdir()\nall_col &lt;- c(\"datasets\",\n             \"Dom_IgH_Type\", \"Clinical_IgH\", \"PrimaryCluster\",\"RNA_Subtype_Name\", \"IRF4_mut\",\"GEP70\",\n             \"Tx_MAF\",\"Tx_MAFA\",\"Tx_MAFB\", \"Tx_CCND1\", \"Tx_CCND2\", \"Tx_CCND3\", \"Tx_NSD2\",\n             all_scores)\nhasub2 &lt;- HeatmapAnnotation(df = subdf[, all_col] |&gt; as.data.frame(),\n                            annotation_name_side = \"left\",\n                            show_legend = all_col %in% c(\"datasets\", \"Dom_IgH_Type\",\n                                                         \"Clinical_IgH\", \"PrimaryCluster\",\n                                                         \"RNA_Subtype_Name\"),\n                            col = col)\nquick_heatmap(dat_exp[cogene, subdf$sample_id], hasub2, outdir = out_dir,\n              hdf = subdf[,c(\"sample_id\",\"cn_name\",\"PrimaryCluster\",\"RNA_Subtype_Name\", \"tumor_descriptor\", \"Tx_CCND1\", \"Tx_CCND2\", \"Tx_CCND3\")] |&gt;\n                mutate(\n                  CCNDx = Tx_CCND1|Tx_CCND2|Tx_CCND3,\n                  cn_name = case_when(\n                    is.na(cn_name) ~ str_extract(sample_id, pattern = \"MMRF_\\\\d+|MM\\\\d+\"),\n                    T ~ cn_name\n                  )\n                ) |&gt;\n                dplyr::select(-c(Tx_CCND1, Tx_CCND2, Tx_CCND3)),\n              top_var_percent = 0.9,\n              keep_annotation = T,\n              column_split = 16,\n              height = 15,\n              out_put_rds = T,\n              cluster_columns = T,\n              show_column_names= F)",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>7</span>  <span class='chapter-title'>Subtypes</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html",
    "href": "reduce_dim.html",
    "title": "8  Dimensionality Reduction",
    "section": "",
    "text": "8.1 PCA figure\nDimensionality reduction is a technique used to reduce the number of random variables (features or dimensions) in a dataset, while retaining as much important information as possible.\nIt transforms high-dimensional data into a lower-dimensional space (often 2D or 3D), making it easier to: Visualize Analyze Model\nThis is especially useful when working with complex datasets like gene expression data, images, text, or any data with many features.\nHigh-dimensional data can cause several issues:",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html#pca-figure",
    "href": "reduce_dim.html#pca-figure",
    "title": "8  Dimensionality Reduction",
    "section": "",
    "text": "PCA plot .",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html#tsne-figure",
    "href": "reduce_dim.html#tsne-figure",
    "title": "8  Dimensionality Reduction",
    "section": "8.2 tSNE figure",
    "text": "8.2 tSNE figure\n\n\n\ntSNE plot.",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "reduce_dim.html#umap-figure",
    "href": "reduce_dim.html#umap-figure",
    "title": "8  Dimensionality Reduction",
    "section": "8.3 UMAP figure",
    "text": "8.3 UMAP figure\n\n\n\nUMAP plot after batch correction.",
    "crumbs": [
      "Unsupervised cluster",
      "<span class='chapter-number'>8</span>  <span class='chapter-title'>Reduce Dim</span>"
    ]
  },
  {
    "objectID": "clinical_info.html",
    "href": "clinical_info.html",
    "title": "9  Distribution of clinical features across subtypes",
    "section": "",
    "text": "9.1 Setup\nMultiple myeloma (MM) are characterized by highly heterogeneous tumor biology, like cytogenetic abnormalities, the secretion of a monoclonal component, etc. Consequently, MM patients display markedly diverse clinical characteristics, therapeutic responses, and outcomes. Therefore, we analyzed the distribution of clinical characteristics of patients with different subtypes of multiple myeloma.\nLoad required R packages and set the working directory.\n# Load necessary R packages for data processing and visualization\npkgs &lt;- c(\"fs\", \"stringr\", \"ggpubr\", \"ggthemes\", \"vroom\", \"jhtools\", \n          \"glue\", \"openxlsx\", \"ggsci\", \"patchwork\", \"cowplot\",\n          \"tidyverse\", \"dplyr\", \"ggsci\")\nfor (pkg in pkgs) {\n  suppressPackageStartupMessages(library(pkg, character.only = TRUE))\n}\n\n# Define project parameters\nproject &lt;- \"mm\"\ndataset &lt;- \"jilin\"\nspecies &lt;- \"human\"\nworkdir &lt;- glue::glue(\"~/projects/{project}/analysis/{dataset}/{species}/sinfo_plot\") %&gt;% checkdir\nsetwd(workdir)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Clinical features</span>"
    ]
  },
  {
    "objectID": "clinical_info.html#data-loading",
    "href": "clinical_info.html#data-loading",
    "title": "9  Distribution of clinical features across subtypes",
    "section": "9.2 Data Loading",
    "text": "9.2 Data Loading\nLoad sample info of all merged samples. In order to avoid the impact of treatment, primary patients were filtered. This helped to focus on the untreated patient characteristics.\n\n# Load merged sample info\nall_sampleinfo &lt;- \"/cluster/home/jhuang/projects/mm/docs/meta/sampleinfo/sampleinfo_jilin_commpass.rds\" %&gt;% \n  read_rds %&gt;% dplyr::mutate(subtypes = case_when(\n  subtypes %in% c(\"CD1a1\", \"CD1a2\", \"CD1b\") ~ \"CD1\",\n  subtypes == \"chr1qgain\" ~ \"1q gain\",\n  subtypes == \"HRD15\" ~ \"HRD, ++15\",\n  subtypes == \"HRD_chr1qgain\" ~ \"HRD, chr1qgain\",\n  subtypes == \"HRD_MYC_lowNFkB\" ~ \"HRD, MYC, low NFkB\",\n  subtypes == \"HRD_lowTP53\" ~ \"HRD, low TP53\",\n  subtypes == \"Low_purity\" ~ \"Low purity\", \n  TRUE ~ as.character(subtypes)\n))\n\n# Define colors for subtypes\nconfig_fn = \"/cluster/home/jhuang/projects/mm/analysis/jilin/human/rnaseq/configs/colors.yaml\"\ngroup_cols &lt;- show_me_the_colors(config_fn, \"subtypes\")\n\nmerged_sampleinfo &lt;- all_sampleinfo %&gt;% drop_na(subtypes) %&gt;% dplyr::filter(tumor_descriptor %in% \"primary\") %&gt;% \n  dplyr::mutate(age_group = case_when(\n    age &lt; 65 ~ \"&lt;65\",\n    age &gt;= 65 ~ \"&gt;=65\",\n    TRUE ~ NA_character_\n  )) %&gt;%\n  as.data.frame() %&gt;% `row.names&lt;-`(.$sample_id)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Clinical features</span>"
    ]
  },
  {
    "objectID": "clinical_info.html#classify-variables",
    "href": "clinical_info.html#classify-variables",
    "title": "9  Distribution of clinical features across subtypes",
    "section": "9.3 Classify variables",
    "text": "9.3 Classify variables\nClassifying variable types to plot these clinical features separately.\n\n# define a function to classify\nclassify_variables &lt;- function(df) {\n  variable_types &lt;- list(discrete = character(), continuous = character())\n\n  for (col in names(df)) {\n    if (is.character(df[[col]])) {\n      variable_types$discrete &lt;- c(variable_types$discrete, col)\n    } else if (is.numeric(df[[col]])) {\n      unique_values &lt;- length(unique(df[[col]]))\n      if (unique_values &lt; 10) { \n        variable_types$discrete &lt;- c(variable_types$discrete, col)\n      } else {\n        variable_types$continuous &lt;- c(variable_types$continuous, col)\n      }\n    }\n  }\n  return(variable_types)\n}\n\nres_vars &lt;- classify_variables(merged_sampleinfo)\n\ncontinuous_vars &lt;- setdiff(res_vars$continuous,c(\"UMAP1\", \"UMAP2\",\"cluster_order\"))\ndiscrete_vars &lt;- setdiff(res_vars$discrete,c(\"sample_id\", \"cn_name\", \"tumor_descriptor\",\n                                             \"new_type\", \"treatment_followup\", \"tissue\",\n                                             \"treatment_sampling\", \"PrimaryCluster_bk\",\n                                             \"patient_id\", \"diagnosis\", \"MRD_neg\", \n                                             \"MRD_pos\", \"asct\"))\n\nmerged_sampleinfo$karyotype &lt;- merged_sampleinfo$karyotype %&gt;%\n  str_remove_all(\"\\\\[.*?\\\\]\") %&gt;%        \n  { ifelse(is.na(.), NA, str_split_fixed(., \"/\", 2)[, 1]) } %&gt;%      \n  str_trim() %&gt;%\n  str_trunc(30, side = \"right\", ellipsis = \"...\")\n\n## separate continuous_vars and discrete_vars\ndiscrete_info &lt;- merged_sampleinfo[, discrete_vars] %&gt;% as_tibble(rownames = \"sample_id\")\ncontinuous_info &lt;- merged_sampleinfo[, c(\"subtypes\", continuous_vars)] %&gt;% as_tibble(rownames = \"sample_id\")\n\ndiscrete_info &lt;- discrete_info %&gt;%\n  dplyr::mutate(across(2:153, ~ as.character(.x))) %&gt;%\n  dplyr::mutate(across(CD38:CD56, ~ factor(.x, levels = c(\"N\", \"PN\", \"P\", \"PP\")))) %&gt;%\n  dplyr::mutate(across(ends_with(\"_class\"), ~ factor(.x, levels = c(\"low\", \"normal\", \"high\"))))",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Clinical features</span>"
    ]
  },
  {
    "objectID": "clinical_info.html#stacked-bar-plot-of-discrete-vars",
    "href": "clinical_info.html#stacked-bar-plot-of-discrete-vars",
    "title": "9  Distribution of clinical features across subtypes",
    "section": "9.4 Stacked bar plot of discrete vars",
    "text": "9.4 Stacked bar plot of discrete vars\n\n# plot function\ngroup_ratio &lt;- function(input_data = input_data, clivar = \"data\", samples = \"subtypes\", \n                       cols = color_list, fz = 8){\n  \n  input_data &lt;- as.data.frame(input_data)\n  df_ratio1 &lt;- prop.table(table(input_data[, clivar],\n                                 input_data[, samples]),\n                           margin = 2)\n  df_ratio1 &lt;- as.data.frame(df_ratio1)\n  head(df_ratio1)\n  colnames(df_ratio1)&lt;-c(\"var1\", \"var2\", \"proportion\")\n  df_ratio1$var1 &lt;- factor(df_ratio1$var1, levels = unique(df_ratio1$var1))\n  \n  legend_lab &lt;- str_c(names(table(input_data[[clivar]])), table(input_data[[clivar]]), sep = \", n=\")\n  names(legend_lab) &lt;- names(table(input_data[[clivar]]))\n\n  p &lt;- ggplot(data = df_ratio1, mapping = aes(x = var2, y = proportion, fill = var1))+\n    geom_bar(stat = \"identity\", width = 0.5,colour = '#FFFFFF')+\n    theme_classic()+\n    labs(x = samples, y = 'Ratio', fill = clivar)+\n    #geom_flow()+·\n    scale_fill_manual(values = color_list, labels = legend_lab)+\n    theme(axis.text.x = element_text(angle = 75, hjust = 1, vjust = 1, color = \"#222222\", size = 6),\n          axis.text.y = element_text(color = \"#222222\", size = 6),\n          axis.line = element_line(color = \"#222222\"),\n          axis.ticks = element_line(color = \"#222222\"),\n          axis.title = element_text(size = 6),\n          legend.title = element_text(size = 6),\n          legend.position = \"right\",\n          legend.key.size = unit(0.2, 'cm'),\n          legend.text = element_text(size = fz))\n  return(p)\n}\n\np_list &lt;- list()\n\ncolor_list &lt;- c(ggsci::pal_nejm()(8),ggsci::pal_ucscgb()(26))\n\noutput_dir &lt;- \"./stackplot\" %&gt;% checkdir()\n\np_list &lt;- list()\ndiscrete_vars &lt;- setdiff(discrete_vars, c(\"subtypes\"))\nfor (i in discrete_vars) {\n    a &lt;- group_ratio(input_data = discrete_info,\n                    clivar = i,\n                    samples = \"subtypes\",\n                    cols = color_list,\n                    fz = 6)\n    p_list[[i]] &lt;- a\n  }\nmulti_plot(fig_fn = glue::glue(\"{output_dir}/subtypes_stack_plot_all.pdf\"), p_list = p_list, nrow = 2, ncol = 2)\n\n\n\n\nclinical discrete features across subtypes\n\n\n\ntest_ls &lt;- list()\nfor (i in discrete_vars) {\n  df_tab &lt;- table(discrete_info[[\"subtypes\"]], discrete_info[[i]]) %&gt;% \n    as.data.frame %&gt;% pivot_wider(names_from = \"Var2\", values_from = \"Freq\") %&gt;% \n    dplyr::rename(\"subtypes\" = \"Var1\") %&gt;% as.data.frame() %&gt;% \n    `rownames&lt;-`(.$subtypes) %&gt;% .[,-1, drop = F]\n  \n  if (dim(df_tab)[2] == 2) {\n    results &lt;- lapply(1:nrow(df_tab), function(n) {\n      mat &lt;- matrix(c(df_tab[n, 1], df_tab[n, 2],\n                  sum(df_tab[[1]]) - df_tab[n, 1],\n                  sum(df_tab[[2]]) - df_tab[n, 2]),\n                nrow = 2, byrow = TRUE)\n  \n      test &lt;- fisher.test(mat)\n  \n      return(tibble(\n        subtypes = rownames(df_tab)[n],\n        varible = i,\n        test_method = \"fisher\",\n        p_value = test$p.value\n      ))\n    })\n \n    results_df &lt;- do.call(rbind, results)\n\n    # Benjamini-Hochberg FDR\n    results_df$adj_p &lt;- p.adjust(results_df$p_value, method = \"BH\")\n    \n  } else if (dim(df_tab)[2] &gt; 2) {\n    total_by_group &lt;- colSums(df_tab)\n    prop_total_group &lt;- total_by_group / sum(total_by_group)\n\n    results &lt;- lapply(1:nrow(df_tab), function(n) {\n      counts &lt;- as.numeric(df_tab[n, ])\n      \n      keep_idx &lt;- counts &gt; 0\n      counts &lt;- counts[keep_idx]\n      \n      if (length(counts) &lt; 2) {\n        return(tibble(\n          subtypes = rownames(df_tab)[n],\n          varible = i,\n          test_method = NA,\n          p_value = NA\n        ))\n        \n      } else {\n        prop_total_group &lt;- prop_total_group[keep_idx]\n      prop_total_group &lt;- prop_total_group / sum(prop_total_group)\n    \n      # 如果某些期望频数过小（n * p &lt; 5），chisq.test 的近似可能不稳，可以使用 simulate.p.value=TRUE\n      expected_counts &lt;- sum(counts) * prop_total_group\n      if (any(expected_counts &lt; 5)) {\n       test_res &lt;- chisq.test(counts, p = prop_total_group, simulate.p.value = TRUE, B = 20000)\n       test_meth &lt;- \"chisq_sim\"\n      } else {\n       test_res &lt;- chisq.test(counts, p = prop_total_group)\n       test_meth &lt;- \"chisq\"\n      }\n      \n         return(tibble(\n           subtypes = rownames(df_tab)[n],\n            varible = i,\n            test_method = test_meth,\n           p_value = test_res$p.value\n          ))\n       }\n      })\n      \n    results_df &lt;- do.call(rbind, results)\n    \n    # Benjamini-Hochberg FDR\n    results_df$adj_p &lt;- p.adjust(results_df$p_value, method = \"BH\")\n  } else {\n    next\n  }\n  \ntest_ls[[i]] &lt;- results_df\n}\n\n\ntest_merge &lt;- do.call(rbind, test_ls)\n\nwrite_csv(test_merge, \"discrete_vars_subtypes_merge_test.csv\")",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Clinical features</span>"
    ]
  },
  {
    "objectID": "clinical_info.html#boxplot-of-continuous-vars",
    "href": "clinical_info.html#boxplot-of-continuous-vars",
    "title": "9  Distribution of clinical features across subtypes",
    "section": "9.5 Boxplot of continuous vars",
    "text": "9.5 Boxplot of continuous vars\n\n# plot function\ncli_box &lt;- function(input_data = input_data, clivar = \"data\", samples = \"subtypes\", \n                       cols = color_list){\n  \n  input &lt;- input_data %&gt;% dplyr::select(all_of(c(clivar, samples)))\n  \n  if (any(abs(scale(input[[clivar]])) &gt; 6, na.rm = TRUE)) {\n    new_col &lt;- str_c(\"log2_\", clivar)\n    input[[new_col]] &lt;- log2(input[[clivar]] +1)\n    clivar &lt;- new_col\n  }\n    \n  p &lt;- ggplot(input,aes(x = .data[[samples]], y = .data[[clivar]], fill = .data[[samples]]))+\n        stat_boxplot(geom= \"errorbar\", width= 0.1, size= 0.5, \n                     position= position_dodge(0.6), color= \"black\")+\n        geom_boxplot(position = position_dodge(0.6),\n                     size= 0.5,\n                     width= 0.3,\n                     color= \"black\",\n                     outlier.color= \"black\",\n                     outlier.shape= 19,\n                     outlier.size= 1.5,\n                     outlier.stroke= 0.5,\n                     outlier.alpha= 45,\n                     notch= F,\n                     notchwidth= 0.5) +\n      labs(x = samples, y = clivar) +\n        theme_classic() +\n        scale_fill_manual(values = cols) +\n        theme(axis.title = element_text(size = 8),\n              axis.line = element_line(color = \"#222222\"),\n              axis.text.x = element_text(angle = 75, color = \"#222222\", hjust = 1, size = 8),\n              axis.text.y = element_text(color = \"#222222\"),\n              axis.ticks = element_line(color = \"#222222\"),\n              plot.title = element_text(size = 8, hjust = 0.5),\n              legend.position = \"none\") +\n        stat_summary(fun = mean, geom = \"point\", \n                     size = 1, aes(group = 1))\n  return(p)\n}\n\n\noutput_dir &lt;- \"./boxplot\" %&gt;% checkdir()\n\np_list &lt;- list()\ncontinuous_vars &lt;- setdiff(continuous_vars, c(\"subtype_index\", \"subtype_index1\"))\nfor (i in continuous_vars) {\n    a &lt;- cli_box(input_data = continuous_info,\n                    clivar = i,\n                    samples = \"subtypes\",\n                    cols = unname(group_cols))\n    p_list[[i]] &lt;- a\n  }\nmulti_plot(fig_fn = glue::glue(\"{output_dir}/subtypes_boxplot_all.pdf.pdf\"), p_list = p_list, nrow = 2, ncol = 2)\n\n\n\n\nclinical continuous features across subtypes",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Clinical features</span>"
    ]
  },
  {
    "objectID": "clinical_info.html#ethnicity-distribution",
    "href": "clinical_info.html#ethnicity-distribution",
    "title": "9  Distribution of clinical features across subtypes",
    "section": "9.6 ethnicity distribution",
    "text": "9.6 ethnicity distribution\n\ndf_ethnicity &lt;- table(merged_sampleinfo$ethnicity, merged_sampleinfo$subtypes) %&gt;% prop.table(., margin = 1) %&gt;% as.data.frame\nlegend_lab &lt;- str_c(names(table(merged_sampleinfo$ethnicity)), table(merged_sampleinfo$ethnicity), sep = \", n=\")\nnames(legend_lab) &lt;- names(table(merged_sampleinfo$ethnicity))\n\ncol_enthn &lt;- show_me_the_colors(config_fn, \"ethnicity\")\n  \np1 &lt;- ggplot(data = df_ethnicity[df_ethnicity$Var1 != \"other\",], mapping = aes(x = Var2, y = Freq, fill = Var1))+\n  geom_bar(stat = \"identity\", position = \"dodge\", width = 0.8, colour = '#FFFFFF')+\n  theme_classic()+\n  labs(x = \"Subtypes\", y = 'Percentage', fill = \"Ethnicity\")+\n  #geom_flow()+·\n  scale_fill_manual(values = col_enthn,\n                    labels = legend_lab)+\n  theme(axis.text.x = element_text(angle = 75, hjust = 1, vjust = 1, color = \"#222222\", size = 6),\n        axis.text.y = element_text(color = \"#222222\", size = 6),\n        axis.line.x = element_line(color = \"#222222\"),\n        axis.line.y = element_line(color = \"#222222\"),\n        axis.ticks.x = element_line(color = \"#222222\"),\n        axis.ticks.y = element_line(color = \"#222222\"),\n        axis.title.x = element_text(size = 6),\n        axis.title.y = element_text(size = 6),\n        legend.title = element_text(size = 6),\n        legend.position = \"right\",\n        legend.key.size = unit(0.2, 'cm'),\n        legend.text = element_text(size = 6))\nggsave(\"ethnicity_distribution_subtypes.pdf\", p1)\n\n\n\n\nethnicity distribution across subtypes",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Clinical features</span>"
    ]
  },
  {
    "objectID": "clinical_info.html#datasets-batch-distribution",
    "href": "clinical_info.html#datasets-batch-distribution",
    "title": "9  Distribution of clinical features across subtypes",
    "section": "9.7 datasets batch distribution",
    "text": "9.7 datasets batch distribution\n\ndf_batch &lt;- table(merged_sampleinfo$batch, merged_sampleinfo$subtypes) %&gt;% prop.table(., margin = 1) %&gt;% as.data.frame\nlegend_lab &lt;- str_c(names(table(merged_sampleinfo$batch)), table(merged_sampleinfo$batch), sep = \", n=\")\nnames(legend_lab) &lt;- names(table(merged_sampleinfo$batch))\np1 &lt;- ggplot(data = df_batch, mapping = aes(x = Var2, y = Freq, fill = Var1))+\n  geom_bar(stat = \"identity\", position = \"dodge\", width = 0.8, colour = '#FFFFFF')+\n  theme_classic()+\n  labs(x = \"Subtypes\", y = 'Percentage', fill = \"Batch\")+\n  #geom_flow()+·\n  scale_fill_manual(values = ggsci::pal_nejm()(6),\n                    labels = legend_lab)+\n  theme(axis.text.x = element_text(angle = 75, hjust = 1, vjust = 1, color = \"#222222\", size = 6),\n        axis.text.y = element_text(color = \"#222222\", size = 6),\n        axis.line.x = element_line(color = \"#222222\"),\n        axis.line.y = element_line(color = \"#222222\"),\n        axis.ticks.x = element_line(color = \"#222222\"),\n        axis.ticks.y = element_line(color = \"#222222\"),\n        axis.title.x = element_text(size = 6),\n        axis.title.y = element_text(size = 6),\n        legend.title = element_text(size = 6),\n        legend.position = \"right\",\n        legend.key.size = unit(0.2, 'cm'),\n        legend.text = element_text(size = 6))\nggsave(\"batch_distribution_subtypes.pdf\", p1)\n\n\n\n\nbatch distribution across subtypes",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>9</span>  <span class='chapter-title'>Clinical features</span>"
    ]
  },
  {
    "objectID": "polaris.html",
    "href": "polaris.html",
    "title": "10  Package load and plot settings.",
    "section": "",
    "text": "10.1 (a) Sample correlation heatmap\n# read data\nsrat_qt_fil &lt;- readRDS(\"{dat_dir}/srat_qt_fil.rds\")\nsrat_core &lt;- subset(srat_qt_fil, subset = roi_type == \"Core\")\n\n# cluster samples by cell type proportion - pool multiple TMA together\n## correlation mat\ndf_prop &lt;- srat_core[[]] %&gt;%\n  group_by(sample_id, celltype) %&gt;%\n  summarise(n = n()) %&gt;%\n  mutate(freq = n / sum(n)) %&gt;%\n  as.data.table() %&gt;%\n  dcast(sample_id ~ celltype, value.var = \"freq\", fill = 0) \nmat_prop &lt;- df_prop[, -1] %&gt;% as.matrix()\nrownames(mat_prop) &lt;- df_prop$sample_id\nmat_cor &lt;- cor(t(mat_prop), method = \"pearson\")\n# plot group\ndt_grp &lt;- fread(\"./data/sample_cluster_group_newcore.csv\")\ndf_anno &lt;- as.data.frame(dt_grp[match(colnames(mat_cor), sample_id), ]) %&gt;%\n  `rownames&lt;-`(colnames(mat_cor)) %&gt;%\n  .[, \"group\", drop = FALSE]\nrow_ha &lt;- rowAnnotation(df = df_anno, col = list(group = cols_grp))\ncol_ha &lt;- HeatmapAnnotation(df = df_anno, col = list(group = cols_grp))\nidx_order &lt;- match(dt_grp$sample_id, rownames(df_anno))\np1 &lt;- ComplexHeatmap::Heatmap(mat_cor, col = col_fun,\n                              column_order = idx_order,\n                              row_order = idx_order,\n                              column_names_gp = grid::gpar(fontsize = 4),\n                              show_row_names = FALSE,\n                              top_annotation = col_ha,\n                              left_annotation = row_ha)\npdf(\"./results/fig1/fig1a_heatmap_sample_correlation_group_anno.pdf\", width = 8, height = 8)\np1 &lt;- draw(p1)\ndev.off()",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Polaris</span>"
    ]
  },
  {
    "objectID": "polaris.html#b-sample-group-celltype-propotion",
    "href": "polaris.html#b-sample-group-celltype-propotion",
    "title": "10  Package load and plot settings.",
    "section": "10.2 (b) Sample group celltype propotion",
    "text": "10.2 (b) Sample group celltype propotion\n\n# plot group freq\ndf_grp_ct &lt;- srat_core[[]] %&gt;%\n  select(sample_id, roi_id, cell_id, celltype) %&gt;%\n  left_join(tibble::rownames_to_column(df_anno, var = \"sample_id\"))\np2 &lt;- ggplot(df_grp_ct, aes(group, fill = celltype)) +\n  geom_bar(position = \"fill\") +\n  scale_fill_manual(values = cols_ct) +\n  coord_flip() +\n  theme_classic()\nggsave(\"./results/fig1/fig1b_bar_stack_sample_group_celltype_prop.pdf\", p2, width = 7, height = 4)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Polaris</span>"
    ]
  },
  {
    "objectID": "polaris.html#c-survival-curve-sample-core-cluster",
    "href": "polaris.html#c-survival-curve-sample-core-cluster",
    "title": "10  Package load and plot settings.",
    "section": "10.3 (c) Survival curve sample core cluster",
    "text": "10.3 (c) Survival curve sample core cluster\n\n# ===================== survival analysis ===========================\n# clinical data\nclin &lt;- fread(\"./data/clinical_info.tsv\")\nclin[RFS_time &gt; 60, `:=`(RFS_time = 60,\n                         RFS = 0)]\n\n# read group data\ndt &lt;- dt_grp %&gt;%\n  left_join(clin, by = \"sample_id\") %&gt;%\n  na.omit(cols = c(\"RFS\", \"RFS_time\"))\ndt[, group := as.factor(group)]\n\n# survival analysis\nfit &lt;- survfit(Surv(RFS_time, RFS) ~ group, data = dt)\n\np3 &lt;- ggsurvplot(fit, data = dt, xlab = \"Time (Months)\", pval = TRUE, risk.table = TRUE,\n                risk.table.height = 0.3, \n                palette = unname(cols_grp), title = \"Survival by Core Cluster\")\np3 &lt;- arrange_ggsurvplots(list(p3), ncol = 1, print = FALSE)\nggsave(\"./results/fig1/fig1c_survival_curve_sample_core_cluster.pdf\", p3, width = 7, height = 7)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Polaris</span>"
    ]
  },
  {
    "objectID": "polaris.html#d-survival-curve-cd44-mac1-core-cluster-m2-spinous-high",
    "href": "polaris.html#d-survival-curve-cd44-mac1-core-cluster-m2-spinous-high",
    "title": "10  Package load and plot settings.",
    "section": "10.4 (d) Survival curve cd44 mac1 core cluster m2 spinous high",
    "text": "10.4 (d) Survival curve cd44 mac1 core cluster m2 spinous high",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>10</span>  <span class='chapter-title'>Polaris</span>"
    ]
  },
  {
    "objectID": "codex.html",
    "href": "codex.html",
    "title": "11  CODEX",
    "section": "",
    "text": "11.1 Package load and plot settings.\n.libPaths(c(.libPaths(), \"/cluster/home/yliang_jh/sbin/R/library/4.3.0\"))\npkgs &lt;- c(\"fs\", \"configr\", \"stringr\", \n          \"jhtools\", \"glue\", \"patchwork\", \"tidyverse\", \"dplyr\", \"Seurat\", \"magrittr\", \n          \"readxl\", \"writexl\", \"ComplexHeatmap\", \n          \"data.table\", \"ggplot2\", \"ggbeeswarm\", \"ggdendro\", \"dendextend\", \"deldir\",\n          \"sf\", \"corrplot\", \"ggpubr\", \"survival\", \"survminer\", \"forestmodel\", \"BiocParallel\", \"BiocNeighbors\")  \nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nsource(\"func_utils.R\")\n\nknitr::opts_chunk$set(message = FALSE)\n\nwkdir &lt;- glue(\"/cluster/home/lixiyue_jh/projects/quarto/stomatology_lvjiong/quarto_book\") %&gt;% setwd()\nfs::dir_create(\"./result/codex\")\n\n\n\n# colors setting\nconfig_fn = \"/cluster/home/lixiyue_jh/projects/quarto/stomatology_lvjiong/quarto_book/colors.yaml\"\nconfig_list &lt;- show_me_the_colors(config_fn, \"all\")\ncolors_celltype &lt;- config_list$cell_type\n\nconfig &lt;- read.config(config_fn)\ncell_type_order &lt;- config$cell_type_order\n\nsampleinfo &lt;- readRDS(\"./doc/sampleinfo.rds\")",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#a-barplot-stacked-celltype-frequency",
    "href": "codex.html#a-barplot-stacked-celltype-frequency",
    "title": "11  CODEX",
    "section": "11.2 (a) Barplot: stacked celltype frequency",
    "text": "11.2 (a) Barplot: stacked celltype frequency\n\nsrt &lt;- readRDS(\"./result/codex/srt_split_anno.rds\")\nsampleinfo &lt;- readRDS(\"./doc/sampleinfo.rds\")\nspinfo &lt;- sampleinfo$codex %&gt;% filter(type == \"Tumor\")\n\ndf &lt;- srt[[c(\"orig.ident\", \"celltype\")]] %&gt;% count(orig.ident, celltype, name = \"n\") %&gt;% group_by(orig.ident) %&gt;%\n  mutate(n_total = sum(n), freq = n / n_total) %&gt;% ungroup() %&gt;% mutate(sample_id = orig.ident) %&gt;%\n  filter(sample_id %in% spinfo$sample_id)\n\nmat &lt;- df %&gt;%\n  select(sample_id, celltype, freq) %&gt;%\n  tidyr::pivot_wider(names_from = celltype, values_from = freq, values_fill = 0) %&gt;%\n  tibble::column_to_rownames(\"sample_id\") %&gt;%\n  as.matrix()\n\ndist_mat &lt;- dist(mat, method = \"euclidean\")\nhc &lt;- hclust(dist_mat, method = \"ward.D2\")\ncl &lt;- cutree(hc, k = 4)\ndf$cluster &lt;- NA\ndf$cluster &lt;- cl[match(df$sample_id, names(cl))]\n\n\ndf_anno &lt;- spinfo %&gt;%\n  select(-time, -status, -TNM, -type, -CN, -K10, -celltype) %&gt;%\n  tibble::column_to_rownames(\"sample_id\") %&gt;%\n  mutate(across(c(clinical_stage, T_stage, metastasis), as.numeric))\ndf_anno &lt;- df_anno[match(rownames(mat), rownames(df_anno)), ]\nha &lt;- HeatmapAnnotation(df = df_anno, \n                        col = list(age = circlize::colorRamp2(c(30, 90), config_list$age), \n                                   gender = config_list$gender,\n                                   tumor_site = config_list$tumor_site,\n                                   differentiation = config_list$differentiation,\n                                   clinical_stage = config_list$clinical_stage,\n                                   T_stage = config_list$T_stage,\n                                   metastasis = config_list$metastasis))\n\n\ncol_dend &lt;- as.dendrogram(hc)\ncol_dend &lt;- color_branches(col_dend, k = 4, col = config_list$dend_color[1:4])\n\n\nht &lt;- Heatmap(t(mat), name = \"Percentage\",\n              cluster_columns = col_dend,\n              cluster_rows = F,\n              show_column_names = T,\n              bottom_annotation = ha)\npdf(\"./result/codex/heatmap_celltype_freq.pdf\", width = 10, height = 8)\nht &lt;- draw(ht, heatmap_legend_side = \"bottom\", annotation_legend_side = \"bottom\")\ndev.off()\n\ncol_order &lt;- column_order(ht)\ndend_order &lt;- rownames(mat)[col_order]\n\ndf &lt;- df %&gt;% \n  mutate(celltype = factor(celltype, levels = intersect(cell_type_order, unique(df$celltype))),\n         sample_id = factor(sample_id, levels = dend_order))\np_bar &lt;- ggplot(df, aes(sample_id, freq, fill = celltype)) +\n  geom_col(width = 1, color = NA) +\n  scale_fill_manual(values = config_list$cell_type) +\n  labs(x = \"\", y = \"Percentage\", fill = \"Cell type\") +\n  theme_minimal() +\n  theme(axis.text.x = element_blank(),\n        panel.grid.major.x = element_blank(),\n        plot.margin = margin(0,0,0,0))\nggsave(\"./result/codex/stacked_bar_celltype_freq.pdf\", p_bar, width = 10, height = 6)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#b-celltype_cn-heatmap_celltype_cn_composition",
    "href": "codex.html#b-celltype_cn-heatmap_celltype_cn_composition",
    "title": "11  CODEX",
    "section": "11.3 (b) celltype_cn, heatmap_celltype_cn_composition",
    "text": "11.3 (b) celltype_cn, heatmap_celltype_cn_composition\n\ncluster_message &lt;- readRDS(glue(\"{wkdir}/result/codex/codex_cluster_message.rds\"))\ndt_fil &lt;- cluster_message$celltype_cn %&gt;% as.data.table()\nmat &lt;- melt(dt_fil[, -\"n\"], id.vars = c(\"cell_id\", \"cluster\"), variable.name = \"celltype\", value.name = \"frequency\") %&gt;%\n  .[, .(freq = mean(frequency)), by = .(cluster, celltype)] %&gt;%\n  .[, cluster := factor(paste0(\"CN\", cluster), levels = paste0(\"CN\", 1:10))] %&gt;%\n  dcast(cluster ~ celltype) %&gt;%\n  tibble::column_to_rownames(\"cluster\") %&gt;%\n  as.matrix()\nmat_scale &lt;- scale(mat)\n\ncelltype = c(\"CD4 T\", \"CD8 T\", \"NKT\", \"B cell\", \"Macrophage\", \"Fibroblast\", \"Blood vessel\", \"Tumor cell\")\nmat_anno &lt;- mat[, match(celltype, colnames(mat))]\n\nha &lt;- rowAnnotation(CN = anno_barplot(mat_anno, \n                                      bar_width = 1, \n                                      gp = gpar(fill = config_list$cell_type), \n                                      border = FALSE,\n                                      axis = TRUE,\n                                      axis_param = list(direction = \"reverse\"),\n                                      width = unit(4, \"cm\")),\n                    show_annotation_name = FALSE)\nlgd_list &lt;- list(Legend(labels = celltype, title = \"Cell type\", \n                        legend_gp = gpar(fill = config_list$cell_type)))\n\n\ndt_anno &lt;- sampleinfo$codex_cn_celltype\nrow_labels &lt;- structure(paste(dt_anno$cn, dt_anno$anno), names = dt_anno$cn)\nht &lt;- Heatmap(mat_scale, name = \"Relative enrichment\",\n              col = circlize::colorRamp2(c(-3, -2, -1, 0, 1, 2, 3), config_list$scale_7),\n              right_annotation = ha,\n              cluster_rows = TRUE,\n              cluster_columns = TRUE,\n              row_labels = row_labels[rownames(mat_scale)])\npdf(\"./result/codex/heatmap_celltype_cn_composition.pdf\", width = 10, height = 6)\ndraw(ht, heatmap_legend_list = lgd_list)\ndev.off()",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#c-subtype_cn-heatmap_subtype_cn_composition",
    "href": "codex.html#c-subtype_cn-heatmap_subtype_cn_composition",
    "title": "11  CODEX",
    "section": "11.4 (c) subtype_cn, heatmap_subtype_cn_composition",
    "text": "11.4 (c) subtype_cn, heatmap_subtype_cn_composition\n\ncluster_message &lt;- readRDS(glue(\"{wkdir}/result/codex/codex_cluster_message.rds\"))\ndt_fil &lt;- cluster_message$subtype_cn %&gt;% as.data.table()\n\n\nmat &lt;- melt(dt_fil[, -\"n\"], id.vars = c(\"cell_id\", \"cluster\"), variable.name = \"subtype\", value.name = \"frequency\") %&gt;%\n  .[, .(freq = mean(frequency)), by = .(cluster, subtype)] %&gt;%\n  .[, cluster := factor(paste0(\"CN\", cluster), levels = paste0(\"CN\", 1:35))] %&gt;%\n  dcast(cluster ~ subtype) %&gt;%\n  tibble::column_to_rownames(\"cluster\") %&gt;%\n  as.matrix()\nmat_scale &lt;- scale(mat)\n\n\nmat_anno &lt;- mat %&gt;% as.data.table(keep.rownames = \"cn\") %&gt;%\n  melt(id.vars = \"cn\", variable.name = \"subtype\", value.name = \"freq\") %&gt;%\n  .[, `:=`(subtype = tstrsplit(subtype, split = \"_\")[[1]],\n           cn = factor(cn, levels = paste0(\"CN\", 1:35)))] %&gt;%\n  .[, .(freq = sum(freq)), by = .(cn, subtype)] %&gt;%\n  dcast(cn ~ subtype, value.var = \"freq\", fill = 0) %&gt;%\n  tibble::column_to_rownames(\"cn\") %&gt;%\n  as.matrix()\ncelltype = c(\"CD4T\", \"CD8T\", \"NKT\", \"B cell\", \"Macrophage\", \"Fibroblast\", \"Blood vessel\", \"Tumor\")\nmat_anno &lt;- mat_anno[, match(celltype, colnames(mat_anno))]\ncelltype = c(\"CD4 T\", \"CD8 T\", \"NKT\", \"B cell\", \"Macrophage\", \"Fibroblast\", \"Blood vessel\", \"Tumor cell\")\nnames(mat_anno) &lt;- celltype\nha &lt;- rowAnnotation(CN = anno_barplot(mat_anno, \n                                      bar_width = 1, \n                                      gp = gpar(fill = config_list$cell_type), \n                                      border = FALSE,\n                                      axis = TRUE,\n                                      axis_param = list(direction = \"reverse\"),\n                                      width = unit(3, \"cm\")),\n                    show_annotation_name = FALSE)\nlgd_list &lt;- list(Legend(labels = celltype, title = \"Cell type\", \n                        legend_gp = gpar(fill = config_list$cell_type)))\n\ndt_anno &lt;- sampleinfo$codex_cn_subtype\nrow_labels &lt;- structure(paste(dt_anno$cn, dt_anno$anno), names = dt_anno$cn)\n\nht &lt;- Heatmap(mat_scale, name = \"Relative enrichment\",\n              col = circlize::colorRamp2(c(-2, -1, 0, 2, 4, 6), config_list$scale_6),\n              right_annotation = ha,\n              cluster_rows = TRUE,\n              cluster_columns = TRUE,\n              row_labels = row_labels[rownames(mat_scale)])\npdf(\"./result/codex/heatmap_subtype_cn_composition.pdf\", width = 15, height = 12)\ndraw(ht, heatmap_legend_list = lgd_list, padding = unit(c(10, 2, 2, 30), \"mm\"), heatmap_legend_side = \"bottom\")\ndev.off()",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#d-celltype_cn-sample_cluster_heatmap_celltype_cn",
    "href": "codex.html#d-celltype_cn-sample_cluster_heatmap_celltype_cn",
    "title": "11  CODEX",
    "section": "11.5 (d) celltype_cn, sample_cluster_heatmap_celltype_cn",
    "text": "11.5 (d) celltype_cn, sample_cluster_heatmap_celltype_cn\n\nsrt &lt;- readRDS(\"./result/codex/srt_split_anno.rds\")\nspinfo &lt;- sampleinfo$codex\ndf &lt;- srt[[c(\"orig.ident\", \"celltype_cn\")]] %&gt;%\n  na.omit() %&gt;%\n  rename(sample_id = orig.ident) %&gt;%\n  count(sample_id, celltype_cn, name = \"n\") %&gt;%\n  tidyr::complete(sample_id, celltype_cn, fill = list(n = 0)) %&gt;%\n  group_by(sample_id) %&gt;%\n  mutate(freq = n / sum(n)) %&gt;%\n  ungroup() %&gt;%\n  left_join(spinfo)\n\n# cluster samples based on celltype-cn\nmat &lt;- tidyr::pivot_wider(df, id_cols = sample_id, names_from = celltype_cn, values_from = freq) %&gt;%\n  tibble::column_to_rownames(\"sample_id\") %&gt;%\n  as.matrix()\nmat &lt;- mat * 100\n\nhc &lt;- hclust(dist(mat))\ncl &lt;- cutree(hc, k = 3)\ndend &lt;- as.dendrogram(hc)\n\n# plot heatmap\ndf_anno &lt;- data.frame(cluster = cl, row.names = as.character(names(cl)))\nha &lt;- rowAnnotation(df = df_anno, col = list(cluster = config_list$cluster))\n\ndt_anno &lt;- sampleinfo$codex_cn_celltype\ncol_labels &lt;- structure(paste(dt_anno$cn, dt_anno$anno), names = dt_anno$cn)\n\nht &lt;- Heatmap(mat, name = \"Percentage\",\n              col = circlize::colorRamp2(c(0, 25, 50, 65, 80, 100), config_list$scale_6),\n              cluster_rows = dend,\n              cluster_columns = TRUE,\n              column_labels = col_labels[colnames(mat)],\n              show_row_names = FALSE,\n              left_annotation = ha)\npdf(\"./result/codex/sample_cluster_heatmap_celltype_cn.pdf\", width = 6, height = 8)\nht &lt;- draw(ht, padding = unit(c(2, 2, 2, 2), \"mm\"))\ndev.off()",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#e-subtype_cn-sample_cluster_heatmap_subtype_cn-survival_curve-k10-cl5",
    "href": "codex.html#e-subtype_cn-sample_cluster_heatmap_subtype_cn-survival_curve-k10-cl5",
    "title": "11  CODEX",
    "section": "11.6 (e) subtype_cn, sample_cluster_heatmap_subtype_cn, survival_curve (k=10, cl=5)",
    "text": "11.6 (e) subtype_cn, sample_cluster_heatmap_subtype_cn, survival_curve (k=10, cl=5)\n\nk = 10\n\nsrt &lt;- readRDS(\"./result/codex/srt_split_anno.rds\")\nspinfo &lt;- sampleinfo$codex\ndf &lt;- srt[[c(\"orig.ident\", \"subtype_cn\")]] %&gt;%\n  na.omit() %&gt;%\n  rename(sample_id = orig.ident) %&gt;%\n  count(sample_id, subtype_cn, name = \"n\") %&gt;%\n  tidyr::complete(sample_id, subtype_cn, fill = list(n = 0)) %&gt;%\n  group_by(sample_id) %&gt;%\n  mutate(freq = n / sum(n)) %&gt;%\n  ungroup() %&gt;%\n  left_join(spinfo)\n\n# cluster samples based on subtype-cn\nmat &lt;- tidyr::pivot_wider(df, id_cols = sample_id, names_from = subtype_cn, values_from = freq) %&gt;%\n  tibble::column_to_rownames(\"sample_id\") %&gt;%\n  as.matrix() %&gt;% t()\nmat &lt;- mat * 100\nmat_scale &lt;- t(scale(t(mat)))\n\ncolor_cl &lt;- config_list$cluster\n\ndt_anno &lt;- sampleinfo$codex_cn_subtype\nrow_labels &lt;- structure(paste(dt_anno$cn, dt_anno$anno), names = dt_anno$cn)\n\n\nhc &lt;- hclust(dist(t(mat_scale)))\n\nk = 10\ncl &lt;- cutree(hc, k = k)\ndend &lt;- as.dendrogram(hc)\n  \n# plot heatmap\ndf_anno &lt;- data.frame(cluster = cl,row.names = names(cl))\nha &lt;- HeatmapAnnotation(df = df_anno, col = list(cluster = color_cl[1:k]))\n  \nht &lt;- Heatmap(mat_scale, name = \"z-score\",\n                col = circlize::colorRamp2(c(0, 1, 2, 3, 4, 5), config_list$scale_6),\n                cluster_rows = TRUE,\n                cluster_columns = TRUE,\n                row_labels = row_labels[rownames(mat_scale)],\n                show_column_names = FALSE,\n                column_split = k,\n                column_title = unique(cl[hc$order]),\n                top_annotation = ha\n  )\n\npdf(file.path(\"./result/codex/\", paste0(\"sample_cluster_heatmap_subtype_cn_k\", k, \".pdf\")), width = 12, height = 6)\ndraw(ht, padding = unit(c(2, 2, 2, 20), \"mm\"))\ndev.off()\n\nwrite.csv(df_anno, glue(\"{wkdir}/result/codex/sample_cluster_heatmap_subtype_cn_k10.csv\"))\n\ni = 5\ndf_surv &lt;- df_anno %&gt;%\n  mutate(cluster = as.character(cluster)) %&gt;%\n  tibble::rownames_to_column(\"sample_id\") %&gt;%\n  left_join(spinfo, join_by(sample_id)) %&gt;%\n  filter(type == \"Tumor\")\n  df_surv$cluster[df_surv$cluster != i] &lt;- \"others\"\n    \nfit &lt;- survfit(Surv(time, status) ~ cluster, data = df_surv)\np &lt;- ggsurvplot(fit, data = df_surv, xlab = \"Time (Months)\", pval = TRUE, risk.table = TRUE,\n                    risk.table.height = 0.3, \n                    palette = config_list$split_2,\n                    title = paste0(\"RFS - Subtype CN cluster\", i))\np &lt;- arrange_ggsurvplots(list(p), ncol = 1, print = FALSE)\nggsave(file.path(\"./result/codex/\", paste0(\"sample_cluster_surv_curve_subtype_cn_cl\", i, \".pdf\")), p, width = 6, height = 8)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#f-pairwise-cell-interaction-subtype-macrophage_cd44---tumor_cd44-cd4t_cd44---tumor_cd44-cd8t_cd44---tumor_cd44",
    "href": "codex.html#f-pairwise-cell-interaction-subtype-macrophage_cd44---tumor_cd44-cd4t_cd44---tumor_cd44-cd8t_cd44---tumor_cd44",
    "title": "11  CODEX",
    "section": "11.7 (f) pairwise cell interaction (subtype): Macrophage_CD44+ - Tumor_CD44+; CD4T_CD44+ - Tumor_CD44+; CD8T_CD44+ - Tumor_CD44+;",
    "text": "11.7 (f) pairwise cell interaction (subtype): Macrophage_CD44+ - Tumor_CD44+; CD4T_CD44+ - Tumor_CD44+; CD8T_CD44+ - Tumor_CD44+;\n\nlst_pci_message &lt;- readRDS(glue(\"{wkdir}/result/codex/pci_message.rds\"))\ndf_res2 &lt;- lst_pci_message$df_res\ndf_surv2 &lt;- lst_pci_message$df_surv\n\n\n\npair_fig = list()\npair2 &lt;- c(\"Macrophage_CD44+-Tumor_CD44+\", \"CD4T_CD44+-Tumor_CD44+\", \"CD8T_CD44+-Tumor_CD44+\")\n#pair2 &lt;- df_res2 %&gt;% filter(pval &lt; 0.05) %&gt;% pull(var)\nfor(pair in pair2){\n  cut &lt;- surv_cutpoint(df_surv2, time = \"time\", event = \"status\", variables = pair)\n  cp &lt;- cut$cutpoint$cutpoint\n  dt_grp &lt;- cut$data \n  dt_grp$group &lt;- ifelse(dt_grp[, pair] &gt; cp, \"high\", \"low\")\n  form &lt;- as.formula(\"Surv(time, status) ~ group\")\n  fit &lt;- surv_fit(formula = form, data = dt_grp)\n  p &lt;- ggsurvplot(fit, data = dt_grp, xlab = \"Time (Months)\", pval = TRUE, risk.table = TRUE,\n                  risk.table.height = 0.3, \n                  palette = config_list$pci_color,\n                  title = paste(\"RFS - Subtype PCI \", pair))\n  p &lt;- arrange_ggsurvplots(list(p), ncol = 1, print = FALSE)\n  ggsave(paste0(\"./result/codex/surv_curve_pci_subtype_\", pair, \".pdf\"), p, width = 6, height = 8)\n  pair_fig[pair] &lt;- p\n}\n\n\np1 &lt;- pair_fig[\"Macrophage_CD44+-Tumor_CD44+\"]\np2 &lt;- pair_fig[\"CD8T_CD44+-Tumor_CD44+\"]\np3 &lt;- pair_fig[\"CD8T_CD44+-Tumor_CD44+\"]",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#g-voronoi-plot-in-situ-message-3-2-4-3-4-3-3-5-4",
    "href": "codex.html#g-voronoi-plot-in-situ-message-3-2-4-3-4-3-3-5-4",
    "title": "11  CODEX",
    "section": "11.8 (g) voronoi plot in situ message: 3-2-4, 3-4-3, 3-5-4",
    "text": "11.8 (g) voronoi plot in situ message: 3-2-4, 3-4-3, 3-5-4\n\nlst_sf_invert &lt;- readRDS(glue(\"{wkdir}/result/codex/sf_invert_insitu_celltype_message.rds\"))\n\nvoronoi_fig &lt;- list()\nImages &lt;- c(\"3-2-4\", \"3-4-3\", \"3-5-4\")\nfor(img in Images){\n\n  sf_invert &lt;- lst_sf_invert[[img]]\n\n  # plot\n  p &lt;- ggplot() +\n    geom_sf(data = sf_invert, aes(fill = celltype), linewidth = 0.001) +\n    scale_fill_manual(values = config_list$cell_type) +\n    theme_void() \n  ggsave(paste0(\"./result/codex/voronoi_\", img, \"_spatial_celltype_map.pdf\"), p, \n         width = 6, height = 6)\n\nvoronoi_fig[[img]] &lt;- p\n}\n\np1 &lt;- voronoi_fig[\"3-2-4\"]\np2 &lt;- voronoi_fig[\"3-4-3\"]\np3 &lt;- voronoi_fig[\"3-5-4\"]",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "codex.html#h-voronoi-plot-in-situ-message-3-2-4-subtype",
    "href": "codex.html#h-voronoi-plot-in-situ-message-3-2-4-subtype",
    "title": "11  CODEX",
    "section": "11.9 (h) voronoi plot in situ message: 3-2-4 subtype",
    "text": "11.9 (h) voronoi plot in situ message: 3-2-4 subtype\n\nlst_sf_invert &lt;- readRDS(glue(\"{wkdir}/result/codex/sf_invert_insitu_subtype_message.rds\"))\n\n\n\n\nimgs = c(\"3-2-4\")\n\nfor(img in imgs){\n\n  sf_invert &lt;- lst_sf_invert[[img]]\n  p &lt;- ggplot() +\n    geom_sf(data = sf_invert, aes(fill = subtype_cn), linewidth = 0.001) +\n    scale_fill_manual(values = config_list$CN_subtype) +\n    theme_void() \n  ggsave(paste0(\"./result/codex/voronoi_\", img, \"_spatial_subtype_cn_top_map.pdf\"), p, \n         width = 6, height = 6)\n}",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>11</span>  <span class='chapter-title'>CODEX</span>"
    ]
  },
  {
    "objectID": "cd44.html",
    "href": "cd44.html",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "",
    "text": "12.1 tidy sample id\nThis workflow illustrates the expression patterns of stemness markers, particularly CD44, across different experimental samples and Epithelial clusters.",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#dotplot-visualization-of-cd44-expression-levels-across-individual-clusters-and-samples",
    "href": "cd44.html#dotplot-visualization-of-cd44-expression-levels-across-individual-clusters-and-samples",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.2 Dotplot visualization of CD44 expression levels across individual clusters and samples",
    "text": "12.2 Dotplot visualization of CD44 expression levels across individual clusters and samples\n\n# CD44 dotplot - sample vs celltype\ndt_expr &lt;- FetchData(srt, vars = c(\"sample_id\", \"celltype\", \"CD44\"), layer = \"data\") %&gt;%\n  as.data.table()\ndt &lt;- dt_expr[, .(pct_expr = mean(CD44 &gt; 0) * 100,\n                  avg_expr = mean(CD44[CD44 &gt; 0], na.rm = TRUE)\n                  ), by = c(\"sample_id\", \"celltype\")]\ndt[is.na(dt)] &lt;- 0\ndt[, avg_expr_scaled := scale(avg_expr)]\n\np &lt;- ggplot(dt, aes(sample_id, celltype)) +\n  geom_point(aes(size = pct_expr, color = avg_expr_scaled)) +\n  scale_color_gradient(low = \"lightgrey\", high = \"blue\") +\n  scale_size(range = c(1, 6)) +\n  theme_classic() +\n  labs(x = \"Sample ID\", y = \"Cell Type\",  \n       color = \"Average Expression\", size = \"Percent Expressed\")\nggsave(glue(figure_dir,\"output/CD44/CD44_expr_in_sample_vs_celltype.pdf\"), p, width = 15, height = 6)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#visualize-cd44-expression-levels-by-umap-plot",
    "href": "cd44.html#visualize-cd44-expression-levels-by-umap-plot",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.3 Visualize CD44 expression levels by umap plot",
    "text": "12.3 Visualize CD44 expression levels by umap plot\n\n# CD44 and other stemness markers in tumor\nsrt_epi &lt;- readRDS(\"srt_epi.rds\") ## unsavedbu\nmarker_stem &lt;- c(\"CD44\", \"PROM1\", \"SOX2\", \"NANOG\", \"POU5F1\", \"BMI1\")\np &lt;- FeaturePlot(srt_epi, reduction = \"umap\", features = marker_stem, ncol = 3, raster = TRUE)\nggsave(glue(figure_dir,\"output/CD44/umap_stemness_markers.pdf\", p, width = 8, height = 5))\n\np &lt;- plot_density(srt_epi, marker_stem, reduction = \"umap\", raster = TRUE, size = 0.1) +\n  plot_layout(ncol = 3)\nggsave(glue(figure_dir,\"output/CD44/umap_density_stemness_markers.pdf\"), p, width = 9, height = 5)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#correlation-analysis-of-cd44-with-other-stemness-markers",
    "href": "cd44.html#correlation-analysis-of-cd44-with-other-stemness-markers",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.4 Correlation Analysis of CD44 with Other Stemness Markers",
    "text": "12.4 Correlation Analysis of CD44 with Other Stemness Markers\n\npt &lt;- FetchData(srt_epi, vars = marker_stem, layer = \"data\") %&gt;%\n  tidyr::pivot_longer(cols = PROM1:BMI1, names_to = \"gene\", values_to = \"expr\")\npt &lt;- pt %&gt;% filter(CD44 &gt; 0 & expr &gt; 0)\np &lt;- ggplot(pt, aes(CD44, expr)) +\n  geom_hex() +\n  scale_fill_gradient(low = \"white\", high = \"red\") +\n  facet_wrap(~ gene, scales = \"free_y\") +\n  geom_smooth(method = lm, color = \"black\", se = FALSE) +\n  stat_cor(method = \"pearson\") +\n  theme_classic()\nggsave(glue(figure_dir,\"output/CD44/correlation_CD44_stemness_markers.pdf\"), p, width = 8, height = 5)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#cd44-expression-patterns-across-samples-analyzed-by-hierarchical-clustering-k5",
    "href": "cd44.html#cd44-expression-patterns-across-samples-analyzed-by-hierarchical-clustering-k5",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.5 CD44 expression patterns across samples analyzed by hierarchical clustering (k=5)",
    "text": "12.5 CD44 expression patterns across samples analyzed by hierarchical clustering (k=5)\n\npt &lt;- FetchData(srt_epi, vars = c(\"CD44\", \"sample_id\"), layer = \"data\")\np &lt;- ggplot(pt, aes(CD44, sample_id)) +\n  geom_density_ridges(aes(fill = sample_id)) +\n  theme_classic() +\n  guides(fill = \"none\")\nggsave(glue(figure_dir,\"output/CD44/density_CD44_sample.pdf\"), p, width = 6, height = 12)\n\n# ks test & hclust\nsps &lt;- unique(pt$sample_id)\nn &lt;- length(sps)\nks_dist &lt;- matrix(0, nrow = n, ncol = n)\nrownames(ks_dist) &lt;- sps\ncolnames(ks_dist) &lt;- sps\n\nfor (i in 1:(n - 1)) {\n  for (j in (i + 1):n) {\n    ks_test &lt;- ks.test(pt[pt$sample_id == sps[i], \"CD44\"], pt[pt$sample_id == sps[j], \"CD44\"])\n    ks_dist[i, j] &lt;- ks_test$statistic  \n    ks_dist[j, i] &lt;- ks_dist[i, j]\n  }\n}\n\ndist_mat &lt;- as.dist(ks_dist)\nhc &lt;- hclust(dist_mat, method = \"ward.D2\")\nsp_order &lt;- hc$labels[hc$order]\npt$sample_id &lt;- factor(pt$sample_id, levels = sp_order)\np &lt;- ggplot(pt, aes(CD44, sample_id)) +\n  geom_density_ridges(aes(fill = sample_id)) +\n  theme_classic() +\n  guides(fill = \"none\")\nggsave(glue(figure_dir,\"output/CD44/density_CD44_sample_hclust.pdf\"), p, width = 6, height = 12)\npdf(glue(figure_dir, \"output/CD44/density_CD44_sample_hclust_dendrogram.pdf\"), width = 12, height = 6)\nplot(as.dendrogram(hc))\ndev.off()\n\nclusters &lt;- cutree(hc, k = 5)\ndf_cl &lt;- data.frame(sample_id = names(clusters),\n                    cluster = clusters)\nfwrite(df_cl, glue(figure_dir,\"output/CD44/density_CD44_sample_hclust.csv\"))",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#epicutree-based-clustering-of-immune-microenvironment-clusters-with-k5",
    "href": "cd44.html#epicutree-based-clustering-of-immune-microenvironment-clusters-with-k5",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.6 EpiCutree-based clustering of immune microenvironment clusters with k=5",
    "text": "12.6 EpiCutree-based clustering of immune microenvironment clusters with k=5\nThe following code generates a visualization displaying both immune microenvironment clusters across samples and tumor cell-driven sample clustering, dividing the dataset into five distinct subgroups.\n\nsrt &lt;- readRDS(glue(rds_dir,\"srt_integrated_anno.rds\"))\npt &lt;- srt[[c(\"sample_id\", \"celltype\")]]\npt$cluster &lt;- df_cl$cluster[match(pt$sample_id, df_cl$sample_id)]\npt$sample_id &lt;- factor(pt$sample_id, levels = sp_order)\npt_im &lt;- pt %&gt;%\n  filter(celltype %in% c(\"T/NK\", \"B cell\", \"Plasma\", \"TAM\", \"DC\", \"Mast\")) %&gt;%\n  filter(!is.na(cluster))\np &lt;- ggplot(pt_im, aes(sample_id, fill = celltype)) +\n  geom_bar(position = \"fill\") +\n  scale_fill_manual(values = color_celltype) +\n  facet_grid(~ cluster, scales = \"free_x\", space = \"free_x\") +\n  theme_classic()\nggsave(glue(figure_dir,\"output/CD44/stack_bar_CD44_cluster_immune.pdf\"), width = 15, height = 8)\n\n# diff gene & enrich\nIdents(srt_epi) &lt;- df_cl$cluster[match(srt_epi$sample_id, df_cl$sample_id)]\nmarkers &lt;- FindAllMarkers(srt_epi)\nfwrite(markers, glue(figure_dir,\"output/CD44/CD44_cluster_markers.csv\"))\n\ndf_sig &lt;- markers %&gt;%\n  filter(abs(avg_log2FC) &gt; 1 & p_val_adj &lt; 0.05) %&gt;%\n  mutate(type = ifelse(avg_log2FC &gt; 0, \"up\", \"down\"))\nfwrite(df_sig, glue(figure_dir,\"output/CD44/CD44_cluster_markers_sig.csv\"))\n\ngene_entrez &lt;- bitr(unique(df_sig$gene), fromType = \"SYMBOL\", toType = \"ENTREZID\", OrgDb = \"org.Hs.eg.db\")\ndf_sig &lt;- merge(df_sig, gene_entrez, all.x = TRUE, by.x = \"gene\", by.y = \"SYMBOL\")\n\nres &lt;- compareCluster(ENTREZID ~ cluster + type, \n                      data = df_sig, \n                      organism = \"hsa\",\n                      fun=\"enrichKEGG\",\n                      use_internal_data = T)\n\np &lt;- dotplot(res) +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1))\nggsave(glue(figure_dir,\"output/CD44/CD44_cluster_markers_enrichment_KEGG.pdf\"), p, width = 12, height = 18)\n\ndf_res &lt;- setReadable(res, OrgDb = \"org.Hs.eg.db\", keyType=\"ENTREZID\") %&gt;%\n  as.data.frame()\nfwrite(glue(figure_dir, df_res, \"output/CD44/CD44_cluster_markers_enrichment_KEGG.csv\"))",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#gene-expression-correlation-between-aldh1a1-and-cd44-in-epi-cluster",
    "href": "cd44.html#gene-expression-correlation-between-aldh1a1-and-cd44-in-epi-cluster",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.7 Gene expression correlation between ALDH1A1 and CD44 in epi cluster",
    "text": "12.7 Gene expression correlation between ALDH1A1 and CD44 in epi cluster\n\nsrt_epi &lt;- readRDS(\"srt_epi.rds\") ## unsaved\np &lt;- FeaturePlot(srt_epi, reduction = \"umap\", features = \"ALDH1A1\", raster = TRUE)\nggsave(glue(figure_dir,\"output/CD44/umap_stemness_markers_ALDH1A1.pdf\"), p, width = 5, height = 5)\n\np &lt;- plot_density(srt_epi, \"ALDH1A1\", reduction = \"umap\", raster = TRUE, size = 0.1)\nggsave(glue(figure_dir,\"output/CD44/umap_density_stemness_markers_ALDH1A1.pdf\"), p, width = 5, height = 5)\n\npt &lt;- FetchData(srt_epi, vars = c(\"CD44\", \"ALDH1A1\"), layer = \"data\") %&gt;%\n  tidyr::pivot_longer(cols = ALDH1A1, names_to = \"gene\", values_to = \"expr\")\npt &lt;- pt %&gt;% filter(CD44 &gt; 0 & expr &gt; 0)\np &lt;- ggplot(pt, aes(CD44, expr)) +\n  geom_hex() +\n  scale_fill_gradient(low = \"white\", high = \"red\") +\n  facet_wrap(~ gene, scales = \"free_y\") +\n  geom_smooth(method = lm, color = \"black\", se = FALSE) +\n  stat_cor(method = \"pearson\") +\n  theme_classic()\nggsave(glue(figure_dir,\"output/CD44/correlation_CD44_stemness_markers_ALDH1A1.pdf\"), p, width = 5, height = 5)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#cd44-expression-patterns-across-samples-analyzed-by-hierarchical-clustering-k3",
    "href": "cd44.html#cd44-expression-patterns-across-samples-analyzed-by-hierarchical-clustering-k3",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.8 CD44 expression patterns across samples analyzed by hierarchical clustering (k=3)",
    "text": "12.8 CD44 expression patterns across samples analyzed by hierarchical clustering (k=3)\n\nsrt_epi &lt;- readRDS(\"srt_epi.rds\")## unsaved\npt &lt;- FetchData(srt_epi, vars = c(\"CD44\", \"sample_id\"), layer = \"data\")\n\n# ks test & hclust\nsps &lt;- unique(pt$sample_id)\nn &lt;- length(sps)\nks_dist &lt;- matrix(0, nrow = n, ncol = n)\nrownames(ks_dist) &lt;- sps\ncolnames(ks_dist) &lt;- sps\n\nfor (i in 1:(n - 1)) {\n  for (j in (i + 1):n) {\n    ks_test &lt;- ks.test(pt[pt$sample_id == sps[i], \"CD44\"], pt[pt$sample_id == sps[j], \"CD44\"])\n    ks_dist[i, j] &lt;- ks_test$statistic  \n    ks_dist[j, i] &lt;- ks_dist[i, j]\n  }\n}\n\ndist_mat &lt;- as.dist(ks_dist)\nhc &lt;- hclust(dist_mat, method = \"ward.D2\")\nsp_order &lt;- hc$labels[hc$order]\n\nclusters &lt;- cutree(hc, k = 3)\ndf_cl &lt;- data.frame(sample_id = names(clusters),\n                    cluster = clusters) %&gt;%\n  mutate(order = match(sample_id, sp_order))\nfwrite(df_cl, glue(figure_dir,\"output/CD44/density_CD44_sample_hclust_k3.csv\"))\n\n# density ridges colored by cluster\nsrt_epi &lt;- readRDS(\"srt_epi.rds\")\ndf_cl &lt;- fread(glue(figure_dir,\"output/CD44/density_CD44_sample_hclust_k3.csv\")) %&gt;%\n  arrange(order)\npt &lt;- FetchData(srt_epi, vars = c(\"CD44\", \"sample_id\"), layer = \"data\") %&gt;%\n  left_join(df_cl, by = \"sample_id\") %&gt;%\n  mutate(sample_id = factor(sample_id, levels = df_cl$sample_id))\np &lt;- ggplot(pt, aes(CD44, sample_id)) +\n  geom_density_ridges(aes(fill = as.factor(cluster))) +\n  scale_fill_manual(values = c(\"brown2\", \"#4696E6\", \"#3CB371\")) +\n  labs(fill = \"cluster\") +\n  theme_classic()\nggsave(glue(figure_dir, \"output/CD44/density_CD44_sample_cluster_k3.pdf\"), p, width = 6, height = 12)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#epicutree-based-clustering-of-immune-microenvironment-clusters-with-k5-1",
    "href": "cd44.html#epicutree-based-clustering-of-immune-microenvironment-clusters-with-k5-1",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.9 EpiCutree-based clustering of immune microenvironment clusters with k=5",
    "text": "12.9 EpiCutree-based clustering of immune microenvironment clusters with k=5\nThe following code generates a visualization displaying both immune microenvironment clusters across samples and tumor cell-driven sample clustering, dividing the dataset into three distinct subgroups.\n\nsrt &lt;- readRDS(glue(rds_dir,\"srt_integrated_anno.rds\"))\npt &lt;- srt[[c(\"sample_id\", \"celltype\")]]\npt$cluster &lt;- df_cl$cluster[match(pt$sample_id, df_cl$sample_id)]\npt$sample_id &lt;- factor(pt$sample_id, levels = sp_order)\npt_im &lt;- pt %&gt;%\n  filter(celltype %in% c(\"T/NK\", \"B cell\", \"Plasma\", \"TAM\", \"DC\", \"Mast\")) %&gt;%\n  filter(!is.na(cluster))\np &lt;- ggplot(pt_im, aes(sample_id, fill = celltype)) +\n  geom_bar(position = \"fill\") +\n  scale_fill_manual(values = color_celltype) +\n  facet_grid(~ cluster, scales = \"free_x\", space = \"free_x\") +\n  theme_classic()\nggsave(glue(figure_dir,\"output/CD44/stack_bar_CD44_cluster_immune_k3.pdf\"), width = 15, height = 8)\n\n# immune cell prop boxplot\npt_box &lt;- pt_im %&gt;%\n  count(sample_id, celltype, name = \"n\") %&gt;%\n  group_by(sample_id) %&gt;%\n  mutate(prop = n / sum(n)) %&gt;%\n  ungroup\npt_box$cluster &lt;- df_cl$cluster[match(pt_box$sample_id, df_cl$sample_id)] %&gt;% as.factor()\np &lt;- ggplot(pt_box, aes(celltype, prop, color = cluster)) +\n  geom_boxplot(width = 0.6, outlier.shape = NA) +\n  scale_color_manual(values = colors_cl) +\n  # geom_point(aes(fill = sample_id), position = position_jitterdodge()) +\n  # guides(fill = \"none\") +\n  theme_classic()\nggsave(glue(figure_dir,\"output/CD44/boxplot_CD44_cluster_immune_prop_k3.pdf\"), p, width = 8, height = 4)\n\n# celltype prop boxplot\npt_box &lt;- pt %&gt;%\n  filter(!is.na(cluster)) %&gt;%\n  count(sample_id, celltype, name = \"n\") %&gt;%\n  group_by(sample_id) %&gt;%\n  mutate(prop = n / sum(n)) %&gt;%\n  ungroup\npt_box$cluster &lt;- df_cl$cluster[match(pt_box$sample_id, df_cl$sample_id)] %&gt;% as.factor()\np &lt;- ggplot(pt_box, aes(celltype, prop, color = cluster)) +\n  geom_boxplot(width = 0.6, outlier.shape = NA) +\n  scale_color_manual(values = colors_cl) +\n  theme_classic()\nggsave(glue(figure_dir, \"output/CD44/boxplot_CD44_cluster_celltype_prop_k3.pdf\"), p, width = 8, height = 4)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#gene-expression-patterns-and-pathway-enrichment-across-epi-clusters",
    "href": "cd44.html#gene-expression-patterns-and-pathway-enrichment-across-epi-clusters",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.10 Gene Expression Patterns and Pathway Enrichment across Epi-Clusters",
    "text": "12.10 Gene Expression Patterns and Pathway Enrichment across Epi-Clusters\n\n# diff gene & enrich\nIdents(srt_epi) &lt;- df_cl$cluster[match(srt_epi$sample_id, df_cl$sample_id)]\nmarkers &lt;- FindAllMarkers(srt_epi)\nfwrite(markers, glue(figure_dir, \"output/CD44/CD44_cluster_markers_k3.csv\"))\n\ndf_sig &lt;- markers %&gt;%\n  filter(abs(avg_log2FC) &gt; 1 & p_val_adj &lt; 0.05) %&gt;%\n  mutate(type = ifelse(avg_log2FC &gt; 0, \"up\", \"down\"))\nfwrite(df_sig, glue(figure_dir, \"output/CD44/CD44_cluster_markers_sig_k3.csv\"))\n\ngene_entrez &lt;- bitr(unique(df_sig$gene), fromType = \"SYMBOL\", toType = \"ENTREZID\", OrgDb = \"org.Hs.eg.db\")\ndf_sig &lt;- merge(df_sig, gene_entrez, all.x = TRUE, by.x = \"gene\", by.y = \"SYMBOL\")\n\nres &lt;- compareCluster(ENTREZID ~ cluster + type, \n                      data = df_sig, \n                      organism = \"hsa\",\n                      fun=\"enrichKEGG\",\n                      use_internal_data = T)\n\np &lt;- dotplot(res) +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1))\nggsave(glue(figure_dir, \"output/CD44/CD44_cluster_markers_enrichment_KEGG_k3.pdf\"), p, width = 8, height = 12)\n\ndf_res &lt;- setReadable(res, OrgDb = \"org.Hs.eg.db\", keyType=\"ENTREZID\") %&gt;%\n  as.data.frame()\nfwrite(df_res, glue(figure_dir, \"output/CD44/CD44_cluster_markers_enrichment_KEGG_k3.csv\"))\n\n# barplot of selected pathway\ndf &lt;- readxl::read_xlsx(\"output/CD44/CD44_cluster_markers_enrichment_KEGG_k3_selected.xlsx\")\npt &lt;- df %&gt;%\n  arrange(cluster, p.adjust) %&gt;%\n  mutate(p.adjust = as.numeric(p.adjust))\npmax &lt;- max(-log10(pt$p.adjust)) %&gt;% ceiling\ncolors_cl &lt;- c(\"brown2\", \"#4696E6\", \"#3CB371\")\np_lst &lt;- lapply(unique(pt$cluster), function(x){\n  pt1 &lt;- pt %&gt;%\n    filter(cluster == x) %&gt;%\n    mutate(Description = factor(Description, levels = Description))\n  ymax &lt;- max(-log10(pt1$p.adjust)) %&gt;% floor\n  p &lt;- ggplot(pt1, aes(Description, -log10(p.adjust))) +\n    geom_bar(stat = \"identity\", fill = colors_cl[x], width = 0.6) +\n    ylim(0, pmax) +\n    coord_flip() +\n    geom_hline(yintercept = 1:ymax, color = \"white\") +\n    theme_classic() +\n    labs(x = paste0(\"Cluster \", x))\n  return(p)\n})\nhts &lt;- pt %&gt;% count(cluster) %&gt;% pull(n)\np &lt;- wrap_plots(p_lst, ncol = 1, heights = hts)\nggsave(glue(figure_dir,\"output/CD44/CD44_cluster_markers_enrichment_KEGG_k3_poi_barplot.pdf\"), p, width = 8, height = 8)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#cytotrace-score-in-all-samples",
    "href": "cd44.html#cytotrace-score-in-all-samples",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.11 Cytotrace score in all samples",
    "text": "12.11 Cytotrace score in all samples\n\ndss &lt;- srt$dataset %&gt;% unique()\nres_lst &lt;- lapply(dss, function(ds){\n  srt_s &lt;- subset(srt, subset = dataset == ds)\n  srt_s &lt;- cytotrace2(srt_s,   \n                      species = \"human\",\n                      is_seurat = TRUE,\n                      slot_type = \"counts\",\n                      batch_size = 10000, # todo NULL\n                      smooth_batch_size = 1000, \n                      parallelize_models = TRUE,\n                      parallelize_smoothing = TRUE,\n                      ncores = 48,\n                      seed = 2025)\n  res &lt;- srt_s[[c(\"CytoTRACE2_Score\", \"CytoTRACE2_Potency\", \"CytoTRACE2_Relative\", \"preKNN_CytoTRACE2_Score\", \"preKNN_CytoTRACE2_Potency\")]]\n  return(res)\n})\nres &lt;- do.call(rbind, res_lst)\nsrt &lt;- AddMetaData(srt, metadata = res)\nsrt$CytoTRACE2_Relative_Score &lt;- scales::rescale(srt$CytoTRACE2_Score)\nsaveRDS(res, glue(rds_dir,\"output/cytotrace/res_cytotrace.rds\"))\nsaveRDS(srt, glue(rds_dir,\"srt_integrated_anno.rds\"))",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "cd44.html#cytotrace-score-in-tumor-cells",
    "href": "cd44.html#cytotrace-score-in-tumor-cells",
    "title": "12  CD44 expression level in different groups and clusters",
    "section": "12.12 Cytotrace score in tumor cells",
    "text": "12.12 Cytotrace score in tumor cells\n\nsrt_epi &lt;- subset(srt, subset = celltype %in% c(\"Epithelial\"))\nsrt_epi[[\"RNA\"]] &lt;- split(srt_epi[[\"RNA\"]], f = srt_epi$dataset)\nsrt_epi &lt;- NormalizeData(srt_epi) %&gt;%\n  FindVariableFeatures() %&gt;%\n  ScaleData() %&gt;%\n  RunPCA() %&gt;%\n  RunUMAP(dims = 1:20, reduction = \"pca\", reduction.name = \"umap.unintegrated\")\nsrt_epi &lt;- IntegrateLayers(srt_epi, method = CCAIntegration, orig.reduction = \"pca\", new.reduction = \"cca\")\nsrt_epi &lt;- JoinLayers(srt_epi)\nsrt_epi &lt;- FindNeighbors(srt_epi, reduction = \"cca\", dims = 1:20) %&gt;%\n  RunUMAP(dims = 1:20, reduction = \"cca\") %&gt;%\n  FindClusters(resolution = 0.8)\nsaveRDS(srt_epi, glue(rds_dir,\"srt_epi.rds\")) # 到这里第一次存这个rds，但是代码是04，上面部分是03\n\ndss &lt;- srt_epi$dataset %&gt;% unique()\nres_lst &lt;- lapply(dss, function(ds){\n  srt_s &lt;- subset(srt_epi, subset = dataset == ds)\n  srt_s &lt;- cytotrace2(srt_s,   \n                      species = \"human\",\n                      is_seurat = TRUE,\n                      slot_type = \"counts\",\n                      batch_size = NULL,\n                      smooth_batch_size = 1000,\n                      parallelize_models = TRUE,\n                      parallelize_smoothing = TRUE,\n                      ncores = 48,\n                      seed = 2025)\n  res &lt;- srt_s[[c(\"CytoTRACE2_Score\", \"CytoTRACE2_Potency\", \"CytoTRACE2_Relative\", \"preKNN_CytoTRACE2_Score\", \"preKNN_CytoTRACE2_Potency\")]]\n  return(res)\n})\nres &lt;- do.call(rbind, res_lst)\nsrt_epi &lt;- AddMetaData(srt_epi, metadata = res)\nsrt_epi$CytoTRACE2_Relative_Score &lt;- scales::rescale(srt_epi$CytoTRACE2_Score)\nsaveRDS(res, glue(rds_dir, \"output/cytotrace/res_cytotrace_tumor.rds\"))\nsaveRDS(srt_epi, glue(rds_dir, \"srt_epi.rds\"))\n\np &lt;- DimPlot(srt_epi, reduction = \"umap.unintegrated\", group.by = \"dataset\", raster = TRUE)\nggsave(glue(figure_dir,\"output/cytotrace/umap_dataset_before_integrate.pdf\"), p, width = 6, height = 5)\np &lt;- DimPlot(srt_epi, reduction = \"umap\", group.by = \"dataset\")\nggsave(glue(figure_dir,\"output/cytotrace/umap_dataset.pdf\"), p, width = 6, height = 5)\np &lt;- DimPlot(srt_epi, reduction = \"umap\", group.by = \"seurat_clusters\")\nggsave(glue(figure_dir,\"output/cytotrace/umap_cluster.pdf\"), p, width = 6, height = 5)\np &lt;- FeaturePlot(srt_epi, reduction = \"umap\", features = \"CytoTRACE2_Relative_Score\") +\n  scale_color_viridis_c()\nggsave(glue(figure_dir,\"output/cytotrace/umap_cytotrace.pdf\"), p, width = 6, height = 5)\np &lt;- FeaturePlot(srt_epi, reduction = \"umap\", features = \"CD44\")\nggsave(glue(figure_dir,\"output/cytotrace/umap_CD44.pdf\"), p, width = 6, height = 5)\npt &lt;- FetchData(srt_epi, vars = c(\"CytoTRACE2_Relative_Score\", \"CD44\"), layer = \"data\")\npt &lt;- filter(pt, CD44 &gt; 0)\np &lt;- ggplot(pt, aes(CytoTRACE2_Relative_Score, CD44)) +\n  geom_hex() +\n  scale_fill_gradient(low = \"white\", high = \"red\") +\n  geom_smooth(method = lm, color = \"black\") +\n  stat_cor(method = \"pearson\") +\n  theme_classic()\nggsave(glue(figure_dir,\"output/cytotrace/correlation_CD44_cytotrace.pdf\"), p, width = 6, height = 5)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>12</span>  <span class='chapter-title'>CD44</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html",
    "href": "epi_nkt.html",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "",
    "text": "13.1 Load data and packages\nThis workflow identified the subtype of Epithelial cells and calculated differential genes between sepcific epithelial clusters.",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html#identify-tumor-cell-cluster",
    "href": "epi_nkt.html#identify-tumor-cell-cluster",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "13.2 identify tumor cell cluster",
    "text": "13.2 identify tumor cell cluster\n\n# doublets\ngenes &lt;- c(\"PTPRC\", \"CD3D\", \"NKG7\", \"CD79A\", \"JCHAIN\", \"LYZ\", \"CD163\", \"LAMP3\", \"IGHG1\", \"TPSAB1\", \n             \"EPCAM\", \"KRT7\", \"KRT17\", \"STATH\", \"COL1A2\", \"RGS5\", \"PDGFRA\", \"PECAM1\")\np &lt;- DotPlot(srt_s, features = genes, cluster.idents = TRUE) +\n  coord_flip() +\n  scale_color_viridis_c()\nggsave(glue(figure_dir,\"output/epi/doublets_dotplot_markers_epi.pdf\"), p, width = 14, height = 8)\n\np &lt;- VlnPlot(srt_s, features = c(\"nFeature_RNA\", \"nCount_RNA\", \"pct_mito\"), ncol = 1)\nggsave(glue(figure_dir,\"output/epi/doublets_vlnplot_qc_epi.pdf\"), p, width = 12, height = 8)\n\n# violin stemness marker\ngenes &lt;- c(\"CD44\", \"SOX2\", \"BMI1\", \"ALDH1A1\", \"CytoTRACE2_Relative_Score\")\np &lt;- VlnPlot(srt_s, features = genes, ncol = 1, pt.size = 0)\nggsave(glue(figure_dir,\"output/epi/vlnplot_stemness_marker_epi.pdf\"), p, width = 8, height = 16)\n\n# umap cluster\np &lt;- DimPlot(srt_s, reduction = \"umap\", group.by = \"seurat_clusters\", label = TRUE)\nggsave(glue(figure_dir,\"output/epi/umap_cluster_epi.pdf\"), p, width = 6, height = 5)\n\n# anno\ndt_anno &lt;- fread(\"output/epi/anno_epi.tsv\") #unsaved\nsrt_s$subtype &lt;- dt_anno$anno[match(srt_s$seurat_clusters, dt_anno$cluster)] %&gt;%\n  factor(levels = rev(c(\"CSC_CD44+\", \"CSC_CD44+SOX2+\", \"CSC_BMI1+\", \"CSC_ALDH1A1+\", \n                        \"CSC_allpositive\", \"CSC_allnegative\", \"Non_CSC\")))\nsaveRDS(srt_s, glue(rds_dir,\"srt_epi.rds\"))\n\n# subtype dotplot\ngenes &lt;- c(\"CD44\", \"SOX2\", \"BMI1\", \"ALDH1A1\", \"CytoTRACE2_Relative_Score\")\np &lt;- DotPlot(srt_s, features = genes, group.by = \"subtype\") +\n  scale_color_viridis_c() +\n  theme(axis.text.x = element_text(angle = 60, hjust = 1))\nggsave(glue(figure_dir,\"output/epi/dotplot_stemness_markers_epi_subtype.pdf\"), p, width = 8, height = 5)\n\n# umap anno\np &lt;- DimPlot(srt_s, reduction = \"umap\", group.by = \"subtype\", cols = color_celltype)\nggsave(glue(figure_dir,\"output/epi/umap_epi_subtype.pdf\"), p, width = 7, height = 6)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html#differential-gene-expression-patterns-across-defined-epithelial-clusters",
    "href": "epi_nkt.html#differential-gene-expression-patterns-across-defined-epithelial-clusters",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "13.3 Differential gene expression patterns across defined epithelial clusters",
    "text": "13.3 Differential gene expression patterns across defined epithelial clusters\n\n13.3.1 # diff CD44+ vs CD44-\n\nmarkers &lt;- FindMarkers(srt_s, ident.1 = c(0,2,3,6,7,13,19), ident.2 = c(20,21,23,24))\nwrite.csv(markers, glue(figure_dir,\"output/epi/CD44pos_vs_CD44neg_diff_genes.csv\"))\n\ndf_sig &lt;- markers %&gt;%\n  filter(abs(avg_log2FC) &gt; 1 & p_val_adj &lt; 0.05) %&gt;%\n  filter(pct.1 &gt; 0.1 | pct.2 &gt; 0.1) %&gt;%\n  mutate(type = ifelse(avg_log2FC &gt; 0, \"CD44+ up\", \"CD44+ down\")) %&gt;%\n  tibble::rownames_to_column(\"gene\")\nwrite.csv(df_sig, glue(figure_dir,\"output/epi/CD44pos_vs_CD44neg_diff_genes_sig.csv\"))\n\ngene_entrez &lt;- bitr(unique(df_sig$gene), fromType = \"SYMBOL\", toType = \"ENTREZID\", OrgDb = \"org.Hs.eg.db\")\ndf_sig &lt;- merge(df_sig, gene_entrez, all.x = TRUE, by.x = \"gene\", by.y = \"SYMBOL\")\n\nres &lt;- compareCluster(ENTREZID ~ type,\n                      data = df_sig,\n                      organism = \"hsa\",\n                      fun = \"enrichKEGG\",\n                      use_internal_data = TRUE)\n\np &lt;- dotplot(res) +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1))\nggsave(glue(figure_dir,\"output/epi/CD44pos_vs_CD44neg_enrich_kegg.pdf\"), p, width = 7, height = 6)\n\ndf_res &lt;- setReadable(res, OrgDb = \"org.Hs.eg.db\", keyType=\"ENTREZID\") %&gt;%\n  as.data.frame()\nwrite.csv(df_res, glue(figure_dir,\"output/epi/CD44pos_vs_CD44neg_enrich_kegg.csv\"))\n\n\n\n13.3.2 diff CD44+SOX2+ vs CD44+SOX2-\n\nmarkers &lt;- FindMarkers(srt_s, ident.1 = c(2, 19), ident.2 = c(0,3,6,7,13))\nwrite.csv(markers, glue(figure_dir,\"output/epi/CD44pos_SOX2pos_vs_SOX2neg_diff_genes.csv\"))\n\ndf_sig &lt;- markers %&gt;%\n  filter(abs(avg_log2FC) &gt; 1 & p_val_adj &lt; 0.05) %&gt;%\n  filter(pct.1 &gt; 0.1 | pct.2 &gt; 0.1) %&gt;%\n  mutate(type = ifelse(avg_log2FC &gt; 0, \"SOX2+ up\", \"SOX2+ down\")) %&gt;%\n  tibble::rownames_to_column(\"gene\")\nwrite.csv(df_sig, glue(figure_dir,\"output/epi/CD44pos_SOX2pos_vs_SOX2neg_diff_genes_sig.csv\"))\n\ngene_entrez &lt;- bitr(unique(df_sig$gene), fromType = \"SYMBOL\", toType = \"ENTREZID\", OrgDb = \"org.Hs.eg.db\")\ndf_sig &lt;- merge(df_sig, gene_entrez, all.x = TRUE, by.x = \"gene\", by.y = \"SYMBOL\")\n\nres &lt;- compareCluster(ENTREZID ~ type,\n                      data = df_sig,\n                      organism = \"hsa\",\n                      fun = \"enrichKEGG\",\n                      use_internal_data = TRUE)\n\np &lt;- dotplot(res) +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1))\nggsave(glue(figure_dir,\"output/epi/CD44pos_SOX2pos_vs_SOX2neg_enrich_kegg.pdf\"), p, width = 7, height = 6)\n\ndf_res &lt;- setReadable(res, OrgDb = \"org.Hs.eg.db\", keyType=\"ENTREZID\") %&gt;%\n  as.data.frame()\nwrite.csv(df_res, glue(figure_dir,\"output/epi/CD44pos_SOX2pos_vs_SOX2neg_enrich_kegg.csv\"))\n\n\n\n13.3.3 diff ALDH1A1+ vs other CSC\n\nmarkers &lt;- FindMarkers(srt_s, ident.1 = c(2,20), ident.2 = c(0,3,6,7,13,19,21,23,24))\nwrite.csv(markers, glue(figure_dir,\"output/epi/ALDH1A1pos_vs_otherCSC_diff_genes.csv\"))\n\ndf_sig &lt;- markers %&gt;%\n  filter(abs(avg_log2FC) &gt; 1 & p_val_adj &lt; 0.05) %&gt;%\n  filter(pct.1 &gt; 0.1 | pct.2 &gt; 0.1) %&gt;%\n  mutate(type = ifelse(avg_log2FC &gt; 0, \"ALDH1A1+ up\", \"ALDH1A1+ down\")) %&gt;%\n  tibble::rownames_to_column(\"gene\")\nwrite.csv(df_sig, glue(figure_dir,\"output/epi/ALDH1A1pos_vs_otherCSC_diff_genes_sig.csv\"))\n\ngene_entrez &lt;- bitr(unique(df_sig$gene), fromType = \"SYMBOL\", toType = \"ENTREZID\", OrgDb = \"org.Hs.eg.db\")\ndf_sig &lt;- merge(df_sig, gene_entrez, all.x = TRUE, by.x = \"gene\", by.y = \"SYMBOL\")\n\nres &lt;- compareCluster(ENTREZID ~ type,\n                      data = df_sig,\n                      organism = \"hsa\",\n                      fun = \"enrichKEGG\",\n                      use_internal_data = TRUE)\n\np &lt;- dotplot(res) +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1))\nggsave(glue(figure_dir,\"output/epi/ALDH1A1pos_vs_otherCSC_enrich_kegg.pdf\"), p, width = 7, height = 6)\n\ndf_res &lt;- setReadable(res, OrgDb = \"org.Hs.eg.db\", keyType=\"ENTREZID\") %&gt;%\n  as.data.frame()\nwrite.csv(df_res, glue(figure_dir,\"output/epi/ALDH1A1pos_vs_otherCSC_enrich_kegg.csv\"))\n\n\n\n13.3.4 diff BMI1+ vs other CSC\n\nmarkers &lt;- FindMarkers(srt_s, ident.1 = c(2,23), ident.2 = c(0,3,6,7,13,19,21,20,24))\nwrite.csv(markers, glue(figure_dir,\"output/epi/BMI1pos_vs_otherCSC_diff_genes.csv\"))\n\ndf_sig &lt;- markers %&gt;%\n  filter(abs(avg_log2FC) &gt; 1 & p_val_adj &lt; 0.05) %&gt;%\n  filter(pct.1 &gt; 0.1 | pct.2 &gt; 0.1) %&gt;%\n  mutate(type = ifelse(avg_log2FC &gt; 0, \"BMI1+ up\", \"BMI1+ down\")) %&gt;%\n  tibble::rownames_to_column(\"gene\")\nwrite.csv(df_sig, glue(figure_dir,\"output/epi/BMI1pos_vs_otherCSC_diff_genes_sig.csv\"))\n\ngene_entrez &lt;- bitr(unique(df_sig$gene), fromType = \"SYMBOL\", toType = \"ENTREZID\", OrgDb = \"org.Hs.eg.db\")\ndf_sig &lt;- merge(df_sig, gene_entrez, all.x = TRUE, by.x = \"gene\", by.y = \"SYMBOL\")\n\nres &lt;- compareCluster(ENTREZID ~ type,\n                      data = df_sig,\n                      organism = \"hsa\",\n                      fun = \"enrichKEGG\",\n                      use_internal_data = TRUE)\n\np &lt;- dotplot(res) +\n  theme(axis.text.x = element_text(angle = 90, hjust = 1))\nggsave(glue(figure_dir,\"output/epi/BMI1pos_vs_otherCSC_enrich_kegg.pdf\"), p, width = 7, height = 6)\n\ndf_res &lt;- setReadable(res, OrgDb = \"org.Hs.eg.db\", keyType=\"ENTREZID\") %&gt;%\n  as.data.frame()\nwrite.csv(df_res, glue(figure_dir,\"output/epi/BMI1pos_vs_otherCSC_enrich_kegg.csv\"))",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html#enriched-pathway-in-compared-clusters",
    "href": "epi_nkt.html#enriched-pathway-in-compared-clusters",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "13.4 Enriched pathway in compared clusters",
    "text": "13.4 Enriched pathway in compared clusters\n\n# pathway of interest\ndf1 &lt;- read.csv(\"output/epi/CD44pos_vs_CD44neg_enrich_kegg_poi.csv\", row.names = 1) ##unsaved\npt1 &lt;- df1 %&gt;%\n  mutate(log10p = ifelse(Cluster == \"CD44+ up\", -log10(p.adjust), log10(p.adjust)),\n         just = ifelse(Cluster == \"CD44+ up\", 1.01, -0.01)) %&gt;%\n  arrange(log10p) %&gt;%\n  mutate(Description = factor(Description, levels = Description),\n         Cluster = factor(Cluster, levels = c(\"CD44+ up\", \"CD44- up\")))\np1 &lt;- ggplot(pt1, aes(Description, log10p, fill = Cluster)) +\n  geom_bar(stat = \"identity\") +\n  scale_fill_manual(values = c(\"#4696E6\", \"#e8d056\")) +\n  scale_y_continuous(\"-log10(p.adjust)\", limits = c(-6, 11), \n                     breaks = seq(-4, 10, 2),labels = c(4, 2, 0, 2, 4, 6, 8, 10)) +\n  scale_x_discrete(\"\", labels = NULL) +\n  coord_flip() +\n  geom_text(aes(Description, 0, label = Description), hjust = pt1$just) +\n  theme_classic() +\n  theme(axis.line.y = element_blank(),\n        axis.ticks.y = element_blank()) +\n  labs(fill = \"\")\nggsave(glue(figure_dir,\"output/epi/CD44pos_vs_CD44neg_enrich_kegg_poi_barplot.pdf\"), p1, width = 8, height = 8)\n\ndf2 &lt;- read.csv(\"output/epi/CD44pos_SOX2pos_vs_SOX2neg_enrich_kegg_poi.csv\", row.names = 1)##unsaved\npt2 &lt;- df2 %&gt;%\n  mutate(log10p = ifelse(Cluster == \"SOX2+ up\", -log10(p.adjust), log10(p.adjust)),\n         just = ifelse(Cluster == \"SOX2+ up\", 1.01, -0.01)) %&gt;%\n  arrange(log10p) %&gt;%\n  mutate(Description = factor(Description, levels = Description),\n         Cluster = factor(factor(Cluster, levels = c(\"SOX2+ up\", \"SOX2+ down\")),\n                          labels = c(\"CD44+SOX2+ up\", \"CD44+SOX2- up\")))\np2 &lt;- ggplot(pt2, aes(Description, log10p, fill = Cluster)) +\n  geom_bar(stat = \"identity\") +\n  scale_fill_manual(values = c(\"#4696E6\", \"#e8d056\")) +\n  scale_y_continuous(\"-log10(p.adjust)\", limits = c(-13, 6), \n                     breaks = seq(-12, 4, 2),labels = c(12, 10, 8, 6, 4, 2, 0, 2, 4)) +\n  scale_x_discrete(\"\", labels = NULL) +\n  coord_flip() +\n  geom_text(aes(Description, 0, label = Description), hjust = pt2$just) +\n  theme_classic() +\n  theme(axis.line.y = element_blank(),\n        axis.ticks.y = element_blank()) +\n  labs(fill = \"\")\nggsave(glue(figure_dir,\"output/epi/CD44pos_SOX2pos_vs_SOX2neg_enrich_kegg_poi_barplot.pdf\"), p2, width = 8, height = 8)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html#load-data",
    "href": "epi_nkt.html#load-data",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "14.1 Load data",
    "text": "14.1 Load data\n\nsrt &lt;- readRDS(glue(rds_dir,\"srt_integrated_anno.rds\"))\nsrt_s &lt;- subset(srt, subset = celltype %in% c(\"T/NK\"))",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html#reclustering-t-cell-and-nk-cells",
    "href": "epi_nkt.html#reclustering-t-cell-and-nk-cells",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "14.2 reclustering T cell and NK cells",
    "text": "14.2 reclustering T cell and NK cells\n\nsrt_s[[\"RNA\"]] &lt;- split(srt_s[[\"RNA\"]], f = srt_s$dataset)\nsrt_s &lt;- NormalizeData(srt_s) %&gt;%\n  FindVariableFeatures(nfeatures = 1500) %&gt;%\n  ScaleData() %&gt;%\n  RunPCA()\nElbowPlot(srt_s, ndims = 50);dev.off()\nsrt_s &lt;- IntegrateLayers(srt_s, method = HarmonyIntegration,\n                         orig.reduction = \"pca\", new.reduction = \"harmony\", \n                         group.by.vars = c(\"dataset\", \"sample_id\"),\n                         dims.use = 1:10)\nsrt_s &lt;- FindNeighbors(srt_s, k.param = 20, reduction = \"harmony\", dims = 1:10) %&gt;%\n  FindClusters(resolution = 0.8) %&gt;%\n  RunUMAP(reduction = \"harmony\", dims = 1:10)\n\n# tsne/umap cluster & samples\np &lt;- DimPlot(srt_s, reduction = \"umap\", label = TRUE)\nggsave(glue(figure_dir,\"output/tnk/umap_tnk_cluster.pdf\"), p, width = 6, height = 5)\n\np &lt;- DimPlot(srt_s, reduction = \"umap\", group.by = \"dataset\")\nggsave(glue(figure_dir,\"output/tnk/umap_tnk_dataset.pdf\"), p, width = 6, height = 5)\n\ngenes &lt;- c(\"CD69\", \"CD3D\", \"CD8B\", \"CD4\", \"NKG7\",\n           \"SELL\", \"CCR7\", \"LEF1\", \"GZMA\", \"GZMB\", \"GZMK\", \"GZMH\",\n           \"GNLY\", \"PDCD1\", \"FOXP3\", \"IL2RA\", \"LAG3\", \"CTLA4\", \n           \"CXCL13\", \"MKI67\", \"IL17A\", \"CX3CR1\", \"TOB1\",\n           \"PRF1\", \"XCL1\", \"XCL2\", \"BATF\", \"TIGIT\", \"TNFRSF4\", \"TNFRSF18\")\np &lt;- DotPlot(srt_s, features = genes, cluster.idents = TRUE) +\n  coord_flip() +\n  scale_color_viridis_c()\nggsave(glue(figure_dir,\"output/tnk/dotplot_markers_tnk_cluster.pdf\"), p, width = 10, height = 7)\n\n# doublets\nmarkers &lt;- c(\"PTPRC\", \"CD3D\", \"NKG7\", \"CD79A\", \"IGHG1\", \n             \"LYZ\", \"CD163\", \"LAMP3\", \"LILRA4\", \"TPSAB1\", \n             \"KRT7\", \"KRT17\", \"EPCAM\", \"STATH\", \n             \"COL1A2\", \"MMP2\", \"ACTA2\", \"RGS5\", \"PECAM1\")\np &lt;- DotPlot(srt_s, features = markers, cluster.idents = TRUE) +\n  coord_flip() +\n  scale_color_viridis_c()\nggsave(glue(figure_dir,\"output/tnk/dotplot_markers_doublets_tnk_cluster.pdf\"), p, width = 10, height = 6)\n\np &lt;- VlnPlot(srt_s, features = c(\"nFeature_RNA\", \"nCount_RNA\", \"percent.mt\"), ncol = 1, pt.size = 0)\nggsave(glue(figure_dir,\"output/tnk/vlnplot_qc_tnk_cluster.pdf\"), p, width = 12, height = 12)\n\nsrt_s &lt;- subset(srt_s, subset = !seurat_clusters %in% c(7, 12))\nsaveRDS(srt_s, glue(rds_dir,\"srt_tnk.rds\"))\n\n# feature plot\ngenes &lt;- c(\"CD69\", \"CD3D\", \"CD8B\", \"CD4\", \"NKG7\",\n           \"SELL\", \"CCR7\", \"LEF1\", \"GZMB\", \"GZMK\",\n           \"GNLY\", \"PDCD1\", \"FOXP3\", \"IL2RA\", \"LAG3\", \"CTLA4\", \n           \"CXCL13\", \"MKI67\", \"IL17A\", \"CX3CR1\", \"TOB1\",\n           \"PRF1\", \"XCL2\", \"BATF\", \"TIGIT\", \"TNFRSF4\", \"TNFRSF18\")\np_lst &lt;- list(FeaturePlot(srt_s, features = genes[1:9], reduction = \"umap\", raster = TRUE),\n              FeaturePlot(srt_s, features = genes[10:18], reduction = \"umap\", raster = TRUE),\n              FeaturePlot(srt_s, features = genes[19:27], reduction = \"umap\", raster = TRUE))\npdf(glue(figure_dir,\"output/tnk/featureplot_tnk_umap.pdf\"), width = 15, height = 12)\npurrr::walk(p_lst, print)\ndev.off()",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html#annotating-t-cell-and-nk-cells",
    "href": "epi_nkt.html#annotating-t-cell-and-nk-cells",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "14.3 Annotating T cell and NK cells",
    "text": "14.3 Annotating T cell and NK cells\n\n# add anno\ndt_anno &lt;- fread(\"output/tnk/anno_tnk.tsv\") #unsaved\ndt_anno[, subtype := factor(subtype, levels = c(\"CD4Tnaive\", \"CD4Tex\", \"Treg\",\n                                                \"CD8Tnaive\", \"CD8Teff\", \"CD8Tprolif\", \"CD8Tex\",\n                                                \"NK\"))]\nsrt_s$subtype &lt;- dt_anno[match(srt_s$seurat_clusters, seurat_clusters), ]$subtype \nsrt_s$subtype1 &lt;- dt_anno[match(srt_s$seurat_clusters, seurat_clusters), ]$subtype1\nsaveRDS(srt_s, glue(rds_dir,\"srt_tnk.rds\"))\n\n# anno umap/tsne\np &lt;- DimPlot(srt_s, reduction = \"umap\", group.by = \"subtype\", cols = color_celltype)\nggsave(glue(figure_dir,\"output/tnk/umap_tnk_subtype.pdf\"), p, width = 8, height = 6)\n\n# stacked bar subtype by cd44 cluster\ndf_cl &lt;- fread(glue(figure_dir,\"output/CD44/density_CD44_sample_hclust_k3.csv\")) %&gt;%\n  arrange(order)\npt &lt;- srt_s[[c(\"sample_id\", \"subtype\")]]\npt$cluster &lt;- df_cl$cluster[match(pt$sample_id, df_cl$sample_id)]\npt &lt;- pt %&gt;%\n  mutate(sample_id = factor(sample_id, df_cl$sample_id)) %&gt;%\n  filter(!is.na(cluster))\n\np &lt;- ggplot(pt, aes(sample_id, fill = subtype)) +\n  geom_bar(position = \"fill\") +\n  scale_fill_manual(values = color_celltype) +\n  facet_grid(~ cluster, scales = \"free_x\", space = \"free_x\") +\n  theme_classic()\nggsave(glue(figure_dir,\"output/tnk/stack_bar_tnk_subtype_CD44_cluster_k3.pdf\"), width = 15, height = 8)",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "epi_nkt.html#boxplot-shows-tnk-subtype-by-cd44-cluster",
    "href": "epi_nkt.html#boxplot-shows-tnk-subtype-by-cd44-cluster",
    "title": "13  Tumor Epithelial cells clustering and differential gene analysis",
    "section": "14.4 Boxplot shows T/NK subtype by CD44 cluster",
    "text": "14.4 Boxplot shows T/NK subtype by CD44 cluster\n\npt_box &lt;- pt %&gt;%\n  count(sample_id, subtype, name = \"n\") %&gt;%\n  group_by(sample_id) %&gt;%\n  mutate(prop = n / sum(n)) %&gt;%\n  ungroup\npt_box$cluster &lt;- df_cl$cluster[match(pt_box$sample_id, df_cl$sample_id)] %&gt;% as.factor()\ncolors_cl &lt;- c(\"brown2\", \"#4696E6\", \"#3CB371\")\n\np &lt;- ggplot(pt_box, aes(subtype, prop, color = cluster)) +\n  geom_boxplot(width = 0.6, outlier.shape = NA) +\n  scale_color_manual(values = colors_cl) +\n  theme_classic() +\n  stat_compare_means(aes(group = cluster, label = ..p.format..), size = 2, method = \"anova\", label.y = 0.6)\nggsave(glue(figure_dir,\"output/tnk/boxplot_tnk_subtype_CD44_cluster_k3_wo_pt.pdf\"), p, width = 8, height = 4)\n\np &lt;- ggboxplot(pt_box, x = \"subtype\", y = \"prop\", \n               color = \"cluster\", palette = colors_cl,\n               add = \"jitter\") +\n  stat_compare_means(aes(group = cluster, label = ..p.format..), size = 4, method = \"anova\")\nggsave(glue(figure_dir,\"output/tnk/boxplot_tnk_subtype_CD44_cluster_k3.pdf\"), p, width = 12, height = 6)\n\nfwrite(pt_box, glue(figure_dir,\"output/tnk/boxplot_tnk_subtype_CD44_cluster_k3.csv\"))",
    "crumbs": [
      "Analysis",
      "<span class='chapter-number'>13</span>  <span class='chapter-title'>EPI NKT</span>"
    ]
  },
  {
    "objectID": "fig1.html",
    "href": "fig1.html",
    "title": "14  Figure 1",
    "section": "",
    "text": "14.1 Figure 1",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>14</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#setup",
    "href": "fig1.html#setup",
    "title": "14  Figure 1",
    "section": "14.2 Setup",
    "text": "14.2 Setup\nLoad required R packages and set the working directory.\n\n# Load necessary R packages for data processing and visualization\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"ggpubr\", \"ggthemes\", \"jhtools\",\n          \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"circlize\", \"ggrepel\",\n          \"ComplexHeatmap\", \"GenomicRanges\", \"jhuanglabRNAseq\", \"ggh4x\")\nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\n\n# Define project parameters\nproject &lt;- \"mm\"\ndataset &lt;- \"meta\"\nspecies &lt;- \"human\"\nworkdir &lt;- glue(\"~/projects/{project}/output/{dataset}/{species}/figures/fig1\") |&gt; checkdir()\nsetwd(workdir)",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>14</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#enrich-score-of-public-gene-sets-in-mm-subtypes",
    "href": "fig1.html#enrich-score-of-public-gene-sets-in-mm-subtypes",
    "title": "14  Figure 1",
    "section": "14.3 enrich score of public gene sets in MM subtypes",
    "text": "14.3 enrich score of public gene sets in MM subtypes\n\n# read in data\nobjht &lt;- read_rds(\"/cluster/home/jhuang/projects/mm/analysis/meta/human/rnaseq/figures/heatmap/step1/heatmap_0.9_groups16.rds\")\ndf &lt;- read_rds(\"/cluster/home/jhuang/projects/mm/docs/meta/sampleinfo/sampleinfo_jilin_commpass.rds\")\nconfig_fn &lt;- \"~/projects/mm/output/meta/human/figures/colors_fix.yaml\"\nconfig_list &lt;- show_me_the_colors(config_fn, \"all\")\n\nsubdf &lt;- tibble(sample_id = rownames(objht$heatmap2[[6]])) |&gt;\n  left_join(df) |&gt; \n  mutate(\n    treatment_group = case_when(treatment_group %in% \"Unknown\" ~ NA_character_,\n                                T ~ treatment_group),\n    hit_event = str_extract(hit_event, pattern = \"\\\\d+\"),\n    best_response = case_when(\n      best_response == \"SCR\" ~ \"sCR\",\n      best_response == \"≥VGPR\" ~ \"VGPR\",\n      best_response == \"Unknown\" ~ NA_character_,\n      T ~ best_response\n    )\n  )\n\nout_dir &lt;- dir_create(\"./score_dotplot/\")\nall_scores &lt;- c(\"subtypes\", config_list$paper_scores)\nsubdf_score &lt;- subdf[,all_scores]\nsubdf_score[,config_list$paper_scores] &lt;- apply(subdf_score[,config_list$paper_scores], 2, function(x){\n  (x-min(x))/(max(x) - min(x))\n  # scale(x)\n})\nsubdf_score$subtypes = factor(subdf_score$subtypes, levels = rev(unique(subdf_score$subtypes)))\n\ndotplotdf &lt;- subdf_score |&gt; \n  pivot_longer(- subtypes) |&gt; \n  group_by(subtypes, name) |&gt; \n  summarise(\n    positive_rate = sum(value &gt; 0.5)/n(),\n    mean_score = mean(value)) |&gt; \n  ungroup() |&gt; \n  mutate(name = factor(name, levels = config_list$paper_scores))\n\nscore_dotplot &lt;- ggplot(dotplotdf |&gt; mutate(label = str_extract(name, pattern = \".+?et_al\")), \n       aes(x = name, y = subtypes, fill = mean_score, size = positive_rate)) +\n  geom_point(shape = 21)+\n  scale_fill_gradientn(limits = c(0.1, 0.9),\n                       colours = c(\"#1E90FF\", \"white\",\"#DC143C\"), \n                       values = scales::rescale(c(0.1, 0.5, 0.9)),\n                       oob = scales::squish,\n                       name = \"Z-Score\")+\n  theme_few() +\n  facet_grid(1~ label, scales = \"free_x\", space = \"free_x\") +\n  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),\n        axis.title.x = element_blank(),\n        # axis.text.y = element_blank(), \n        axis.ticks.length.y = unit(0, \"mm\"),\n        axis.ticks.length.x = unit(0, \"mm\"),\n        legend.position = \"right\", \n        panel.spacing = unit(-1, \"mm\"),\n        strip.text.y.right = element_blank(),\n        strip.text.x.top = element_blank(),\n        strip.background = element_rect(fill = NA),\n        # plot.margin = margin(l = 1),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5))\npdf(glue(\"{out_dir}/score_dotplot.pdf\"), width = 12, height = 5)\nprint(score_dotplot)\ndev.off()\n\n\n\n\nsubtypes score from public papers",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>14</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#refined-molecular-subtypes-of-mm",
    "href": "fig1.html#refined-molecular-subtypes-of-mm",
    "title": "14  Figure 1",
    "section": "14.4 Refined molecular subtypes of MM",
    "text": "14.4 Refined molecular subtypes of MM\n\n# colors settings\ncol &lt;- config_list[c(\"gender\", \"ethnicity\", \"age\", \"GEP70\", \"Clinical_IgH\", \"Clinical_IgL\", \"batch\", \"subtypes\", \"imwg_risk\",\n                     \"treatment_group\", \"best_response\", \"hit_event\")]\ncol$ethnicity &lt;- c(col$ethnicity, \"other\" = \"grey\")\ncol$datasets &lt;- config_list$batch\ncol$GEP70 &lt;- colorRamp2(quantile(subdf$GEP70, c(0.1, 0.5, 0.9), na.rm = TRUE),\n                        colors = col$GEP70[c(\"colors1\", \"colors2\", \"colors3\")])\ncol$age &lt;- colorRamp2(quantile(subdf$age, as.numeric(col$age[c(\"breaks1\", \"breaks2\", \"breaks3\")]), na.rm = TRUE),\n                      colors = col$age[c(\"colors1\", \"colors2\", \"colors3\")])\n\nout_dir &lt;- dir_create(\"./cluster_heatmap/\")\n\n# draw\nall_col &lt;- config_list$clinical_order\nshow_legend &lt;- config_list$show_legend\n\nhasub2 &lt;- HeatmapAnnotation(df = subdf[,all_col],\n                            annotation_name_side = \"left\",\n                            show_legend = all_col %in% show_legend,\n                            col = col)\n\nht &lt;- Heatmap(t(objht$heatmap2[[6]]),\n              show_column_names = FALSE,\n              show_row_names = FALSE,\n              top_annotation = hasub2,\n              name = \"Z-Score\",\n              border = TRUE,\n              cluster_columns = FALSE,\n              cluster_rows = FALSE,\n              column_gap = unit(0, \"mm\"),\n              column_title_rot = 90,\n              clustering_method_columns = \"ward.D2\",\n              clustering_method_rows = \"ward.D2\",\n              heatmap_width = unit(160, \"mm\"),\n              column_split = as.numeric(factor(subdf$subtypes, levels = unique(subdf$subtypes))),\n              column_title = unique(subdf$subtypes))\n\npdf(glue(\"{out_dir}/figure1_heatmap.pdf\"), width = 14, height = 6)\ndraw(ht, annotation_legend_side = \"right\", heatmap_legend_side = \"left\")\ndev.off()\n\n\n\n\nheatmap for clusters",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>14</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig1.html#tsne-of-subtypes",
    "href": "fig1.html#tsne-of-subtypes",
    "title": "14  Figure 1",
    "section": "14.5 TSNE of subtypes",
    "text": "14.5 TSNE of subtypes\n\nout_dir &lt;- dir_create(\"./tsne/\")\nmm_heatmap &lt;- \"/cluster/home/jhuang/projects/mm/analysis/meta/human/rnaseq/exp/mm_heatmap1117.rds\" %&gt;% \n  read_rds() |&gt; convert_df_plot()\ndat_exp &lt;- mm_heatmap[colnames(objht$heatmap2[[6]]), ] |&gt; t()\n\npca_raw &lt;- prcomp(dat_exp, scale. = TRUE)\npca_mat &lt;- as.data.frame(pca_raw$x[, 1:2])\ntsne_raw &lt;- Rtsne::Rtsne(dat_exp, perplexity = 30, max_iter = 1000,\n                         verbose = FALSE, check_duplicates = FALSE)\ntsne_mat &lt;- as.data.frame(tsne_raw$Y)\ncolnames(tsne_mat) &lt;- c(\"tSNE_1\", \"tSNE_2\")\nrownames(tsne_mat) &lt;- rownames(dat_exp)\ntsne_mat$sample_id &lt;- rownames(tsne_mat)\ntsne_mat &lt;- tsne_mat |&gt; \n  left_join(\n    subdf[,c(\"sample_id\", \"subtypes\", \"datasets\", \"ethnicity\", \"Clinical_IgH\")] |&gt; \n      mutate(\n        datasets = factor(datasets, levels = c(\"HRA006164\", \"jilin\", \"PRJNA474747\", \"bmc\", \"GSE116324\", \"GSE230526\", \"EGAD00001007813\", \"commpass\")),\n        ethnicity = factor(ethnicity, levels = c(\"Asian\", \"African\", \"Caucasian\", \"other\")),\n        Clinical_IgH = factor(Clinical_IgH, levels = c(\"IgM\", \"Bi-Clonal\", \"IgD\", \"IgA\", \"IgG\", \"Negative\")),\n      )\n  )\n\n\npdf(glue(\"{out_dir}/embedding_plot.pdf\"), width = 7, height = 6)\nggplot(tsne_mat, \n       aes(x = tSNE_1, y = tSNE_2, color = subtypes)) +\n  geom_point() +\n  ggrepel::geom_label_repel(data = tsne_mat |&gt; \n               group_by(subtypes) |&gt; \n               summarise(tSNE_1 = mean(tSNE_1),\n                         tSNE_2 = mean(tSNE_2)),\n             mapping = aes(x = tSNE_1, y = tSNE_2, label = subtypes, fill = subtypes), color = \"white\") +\n  scale_color_manual(values = col$subtypes) +\n  scale_fill_manual(values = col$subtypes) +\n  theme_void() +\n  theme(legend.position = \"none\")\ndev.off()\n\n\n\n\nTSNE plot of subtypes\n\n\n\n14.5.1 clinical features of subtypes\ncode:",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>14</span>  <span class='chapter-title'>Figure 1</span>"
    ]
  },
  {
    "objectID": "fig2.html",
    "href": "fig2.html",
    "title": "15  Figure 2",
    "section": "",
    "text": "15.1 Figure 2",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>15</span>  <span class='chapter-title'>Figure 2</span>"
    ]
  },
  {
    "objectID": "fig2.html#setup",
    "href": "fig2.html#setup",
    "title": "15  Figure 2",
    "section": "15.2 Setup",
    "text": "15.2 Setup\nLoad required R packages and set the working directory.\n\npkgs &lt;- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\",\n          \"jhtools\", \"glue\", \"ggsci\", \"cowplot\", \"patchwork\", \"tidyverse\", \n          \"circlize\", \"grid\", \"gplots\", \"ggrepel\", \"ComplexHeatmap\", \n          \"GenomicRanges\", \"jhuanglabRNAseq\", \"ggh4x\", \"gghalves\"\n          )\nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n} \n\n# Define project parameters\nproject &lt;- \"mm\"\ndataset &lt;- \"meta\"\nspecies &lt;- \"human\"\nworkdir &lt;- glue(\"~/projects/{project}/output/{dataset}/{species}/figures/fig2\") |&gt; checkdir()\nsetwd(workdir)",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>15</span>  <span class='chapter-title'>Figure 2</span>"
    ]
  },
  {
    "objectID": "fig2.html#overview-of-mutations",
    "href": "fig2.html#overview-of-mutations",
    "title": "15  Figure 2",
    "section": "15.3 overview of mutations",
    "text": "15.3 overview of mutations\n\n# load cnv data\nband_data &lt;- read.delim(\"/cluster/home/yjliu_jh/projects/leukemia/data/common/cytoBand_hg38.txt\", header = F)\ncolnames(band_data) &lt;- c(\"chr\", \"start\", \"end\", \"band\", \"stain_value\")\nband_data &lt;- band_data[nchar(band_data$chr) &lt;= 5, ]\n\nm_cnv_band &lt;- read_rds(\"../merged_cnv_band_circos.rds\")\nm_cnv_band_fil &lt;- m_cnv_band[!grepl(\"C$\", m_cnv_band$sample_id), ]\nsample_count &lt;- length(unique(m_cnv_band_fil$sample_id))\nstat_cnv_band &lt;- m_cnv_band_fil %&gt;% group_by(chr, band, bivalue) %&gt;% summarise(prop = n() / sample_count)\nstat_cnv_band &lt;- left_join(stat_cnv_band, band_data[, 1:4])\ngain_df &lt;- stat_cnv_band[stat_cnv_band$bivalue %in% 1, ]\nloss_df &lt;- stat_cnv_band[stat_cnv_band$bivalue %in% -1, ]\ngain_df$value &lt;- gain_df$prop\nloss_df$value &lt;- loss_df$prop\ngain_df &lt;- gain_df[, c(\"chr\", \"start\", \"end\", \"value\")]\nloss_df &lt;- loss_df[, c(\"chr\", \"start\", \"end\", \"value\")]\n\n# load mut data (may alter later)\nmerged_mutations &lt;- read_rds(\"../merged_mutations_circos.rds\")\n\nmerged_mutations &lt;- merged_mutations[!grepl(\"C$\", merged_mutations$sample_id), ]\nsample_count2 &lt;- length(unique(merged_mutations$sample_id))\nstat_mut &lt;- merged_mutations %&gt;% group_by(chr, start, end) %&gt;% summarise(value = n() / sample_count2)\nmutation_df &lt;- as.data.frame(stat_mut)\nmutation_df &lt;- mutation_df[mutation_df$value %notin% min(mutation_df$value), ]\nmutation_df &lt;- mutation_df[mutation_df$value %notin% min(mutation_df$value), ]\n\ncol_fun &lt;- colorRamp2(\n  c(min(mutation_df$value, na.rm = TRUE),\n    median(mutation_df$value, na.rm = TRUE),\n    max(mutation_df$value, na.rm = TRUE)),\n  c(\"steelblue\", \"yellow2\", \"tomato\")\n)\n\n# load label data\nlabel_df &lt;- read_rds(\"../white_list_label_circos.rds\") %&gt;% \n  dplyr::filter(!chr %in% c(\"chrX\"))\n\nlegend_obj &lt;- ComplexHeatmap::Legend(\n  col_fun = col_fun,\n  title = \"Mutation Frequency\",\n  direction = \"horizontal\",\n  legend_width = unit(4, \"cm\"),\n  title_position = \"topcenter\"\n)\n\n\n# plot \n\npdf(\"figure2_circos_plot_hg38.pdf\", width = 8, height = 8)\n\ncircos.clear()\n\ncircos.par(start.degree = 90, \"canvas.ylim\" = c(-1.25, 1.25))\ncircos.initializeWithIdeogram(\n  species = \"hg38\",\n  chromosome.index = paste0(\"chr\", c(1:22)),\n  plotType = \"none\" \n)\ncircos.genomicLabels(\n  label_df,\n  labels.column = 4,\n  side = \"outside\",\n  connection_height = mm_h(5),\n  line_col = \"grey30\",\n  cex = 0.5,\n  labels_height = mm_h(3)\n)\n\ncircos.clear()\npar(new = TRUE)\n\ncircos.par(\n  start.degree = 90, \n  gap.degree = 1,\n  track.margin = c(0.01, 0.01),\n  canvas.ylim = c(-1.5, 1.5) \n)\n\n# ======= initialization =======\ncircos.initializeWithIdeogram(\n  species = \"hg38\", \n  chromosome.index = paste0(\"chr\", c(1:22)),\n  plotType = c(\"ideogram\", \"labels\"),\n  ideogram.height = 0.04, \n  track.height = 0.02    \n)\n\n\n# ======= Track 3: mutation =======\ncircos.genomicTrack(mutation_df,\n                    track.height = 0.1,\n                    bg.border = NA,\n                    ylim = c(0, 1),\n                    panel.fun = function(region, value, ...) {\n                      circos.segments(region[[1]], 0, region[[2]], 1,\n                                      col = col_fun(value[[1]]), lwd = 1)\n                    })\n\n# ======= Track 1: cn gain =======\ncircos.genomicTrack(gain_df,\n                    track.height = 0.12,\n                    bg.border = NA,\n                    ylim = c(0, max(gain_df$value, na.rm = TRUE)),\n                    panel.fun = function(region, value, ...) {\n                      circos.rect(xleft  = region[[1]],\n                                  ybottom = 0,\n                                  xright = region[[2]],\n                                  ytop   = value[[1]],\n                                  col = \"#E04477\",\n                                  border = NA)\n                    })\n\n# ======= Track 2: cn loss =======\ncircos.genomicTrack(loss_df,\n                    track.height = 0.12,\n                    bg.border = NA,\n                    ylim = c(0, max(loss_df$value, na.rm = TRUE)),\n                    panel.fun = function(region, value, ...) {\n                      circos.rect(xleft  = region[[1]],\n                                  ybottom = value[[1]],\n                                  xright = region[[2]],\n                                  ytop   = 0,\n                                  col = \"#55CC33\",\n                                  border = NA)\n                    })\n\n\n# ======= Track 4: label =======\n\n\n# ======= center legend =======\npushViewport(viewport(x = 0.5, y = 0.65, width = 0.1, height = 0.1, just = c(\"center\", \"center\")))\ngrid.text(\"Legend\", y = 0.8, gp = gpar(fontsize = 10, fontface = \"bold\"))\ngrid.text(\"Red: Amplification\", y = 0.6, gp = gpar(col = \"#E04477\", fontsize = 8))\ngrid.text(\"Green: Deletion\", y = 0.4, gp = gpar(col = \"#55CC33\", fontsize = 8))\ngrid.text(\"Labeled: Selected genes\", y = 0.2, gp = gpar(fontsize = 8))\npopViewport()\n\n\npushViewport(viewport(x = 0.5, y = 0.4)) \ngrid.draw(legend_obj)\npopViewport()\n\ndev.off()\n\n\n\n\ncircos for DNA events",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>15</span>  <span class='chapter-title'>Figure 2</span>"
    ]
  },
  {
    "objectID": "fig2.html#section",
    "href": "fig2.html#section",
    "title": "15  Figure 2",
    "section": "15.4 ",
    "text": "15.4 \n\ninput_df &lt;- read_rds(\"/cluster/home/yjliu_jh/projects/mm/data/output/sv/sv_chord_input.rds\")\nchord_data &lt;- input_df %&gt;% group_by(pair) %&gt;% mutate(freq = n()) %&gt;% dplyr::select(-sample_id) %&gt;% \n  distinct() %&gt;% as.data.frame()\nchord_data &lt;- chord_data[chord_data$freq &gt;= 3, ]\ntrans_df &lt;- chord_data %&gt;%\n  mutate(\n    end1 = ifelse(end1 == start1, end1 + 1, end1),\n    end2 = ifelse(end2 == start2, end2 + 1, end2)\n  )\ntrans_df$start1[trans_df$start1 == 0] &lt;- 1\ntrans_df$start2[trans_df$start2 == 0] &lt;- 1\n\npdf(\"figure2_circos_sv_trans_test.pdf\", width = 8, height = 8)\n\ncircos.clear()\ncircos.par(\"track.height\" = 0.05)\ncircos.initializeWithIdeogram(species = \"hg38\")\n\nbed1 &lt;- trans_df[, c(\"chr1\", \"start1\", \"end1\")]\nbed2 &lt;- trans_df[, c(\"chr2\", \"start2\", \"end2\")]\nmaxf &lt;- max(trans_df$freq)\ncol_fun &lt;- colorRamp2(c(1, maxf), c(\"lightblue\", \"red\"))\ncols &lt;- col_fun(trans_df$freq)\nscaled &lt;- scales::rescale(trans_df$freq, to = c(0.1, 1))\nscaled_255 &lt;- round(scaled * 255)\nhex_vals &lt;- toupper(sprintf(\"%02X\", scaled_255))\ncols &lt;- paste0(substr(cols, 1, 7), hex_vals)\ncircos.genomicLink(bed1, bed2,\n                   col = cols,\n                   border = NA)   \ndev.off()\n\n\n\n\ncircos for translocation",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>15</span>  <span class='chapter-title'>Figure 2</span>"
    ]
  },
  {
    "objectID": "fig2.html#heatmap-of-mutations",
    "href": "fig2.html#heatmap-of-mutations",
    "title": "15  Figure 2",
    "section": "15.5 heatmap of mutations",
    "text": "15.5 heatmap of mutations\n\n# load data\nobjht &lt;- read_rds(\"/cluster/home/jhuang/projects/mm/analysis/meta/human/rnaseq/figures/heatmap/step1/heatmap_0.9_groups16.rds\")\ndf &lt;- read_rds(\"/cluster/home/jhuang/projects/mm/docs/meta/sampleinfo/sampleinfo_jilin_commpass.rds\")\nconfig_fn &lt;- \"~/projects/mm/output/meta/human/figures/colors_fix.yaml\"\nconfig_list &lt;- show_me_the_colors(config_fn, \"all\")\n\n# subset data\nsubdf &lt;- tibble(sample_id = rownames(objht$heatmap2[[6]])) |&gt;\n  left_join(df) |&gt; \n  mutate(\n    hit_event = str_extract(hit_event, pattern = \"\\\\d+\"),\n    best_response = case_when(\n      best_response == \"SCR\" ~ \"sCR\",\n      best_response == \"≥VGPR\" ~ \"VGPR\",\n      T ~ best_response\n    )\n  )\n\n# color settings\ncol &lt;- config_list[c(\"gender\", \"ethnicity\", \"age\", \"GEP70\", \"Clinical_IgH\", \"Clinical_IgL\", \"batch\", \"subtypes\", \"imwg_risk\",\n                     \"treatment_group\", \"best_response\", \"hit_event\")]\ncol$ethnicity &lt;- c(col$ethnicity, \"other\" = \"grey\")\ncol$datasets &lt;- config_list$batch\ncol$GEP70 &lt;- colorRamp2(quantile(subdf$GEP70, c(0.1, 0.5, 0.9), na.rm = TRUE),\n                        colors = col$GEP70[c(\"colors1\", \"colors2\", \"colors3\")])\ncol$age &lt;- colorRamp2(quantile(subdf$age, as.numeric(col$age[c(\"breaks1\", \"breaks2\", \"breaks3\")]), na.rm = TRUE),\n                      colors = col$age[c(\"colors1\", \"colors2\", \"colors3\")])\n\nout_dir &lt;- dir_create(\"./mutations_heatmap/\")\n\n# draw\ngenes &lt;- config_list$expression_order\nigv &lt;- str_c(\"Tx_\", config_list$igtx_order)\n# cnvlevels &lt;- config_list$cnv_order |&gt; str_c(\"_fish\")\ncnvlevels &lt;- config_list$cnv_order\n\nft &lt;- subdf$datasets %in% c(\"commpass\", \"jilin\")\nmm_heatmap &lt;- \"/cluster/home/jhuang/projects/mm/analysis/meta/human/rnaseq/exp/mm_heatmap1117.rds\" %&gt;% \n  read_rds() |&gt; convert_df_plot()\n\nmake_cnvdf &lt;- function(annotated_longmatrix){\n  annotated_longmatrix &lt;- annotated_longmatrix |&gt; mutate(pq = str_extract(band, pattern = \"[pq]\")) \n  df1 &lt;- annotated_longmatrix |&gt; \n    dplyr::filter(str_detect(sample_id, pattern = \"T$\")) |&gt; \n    group_by(chr_gene, pq, sample_id) |&gt; summarise(log2 = mean(log2)) |&gt; \n    ungroup() |&gt; mutate(sample_id = str_remove(sample_id, pattern = \"T$\"), \n                        cnvtype = case_when(\n                          log2 &gt; 0.2 ~ \"Gain\",\n                          log2 &lt; - 0.2 ~ \"Del\",\n                          T ~ \"Normal\"\n                        )) |&gt; \n    pivot_wider(id_cols = sample_id, names_from = c(chr_gene, pq), values_from = cnvtype, names_sep = \"\")\n  \n  df2 &lt;- annotated_longmatrix |&gt; \n    dplyr::filter(str_detect(sample_id, pattern = \"T$\")) |&gt; \n    group_by(chr_gene, sample_id) |&gt; summarise(log2 = mean(log2))|&gt; \n    ungroup() |&gt; mutate(sample_id = str_remove(sample_id, pattern = \"T$\"), \n                        cnvtype = case_when(\n                          log2 &gt; 0.2 ~ \"Gain\",\n                          log2 &lt; - 0.2 ~ \"Del\",\n                          T ~ \"Normal\"\n                        )) |&gt; \n    pivot_wider(id_cols = sample_id, names_from = chr_gene, values_from = cnvtype)\n  df1 |&gt; full_join(df2)\n}\n\n# gene expression\njoinedf &lt;- subdf[ft, \"sample_id\"] |&gt;\n  left_join(t(mm_heatmap[genes, ]) |&gt; as_tibble(rownames = \"sample_id\")) |&gt;\n  mutate(sample_id = factor(sample_id, levels = sample_id))\n  \n# IG translocations\nbcf_list_filted_subanno &lt;- \"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/jilin_igtx.rds\" |&gt; read_rds()\nbcf_list_filted_subanno &lt;- subdf |&gt; left_join(bcf_list_filted_subanno)\nfor(i in c(\"Tx_NSD2\", \"Tx_FGFR3\", \"Tx_CCND1\", \"Tx_CCND2\", \"Tx_CCND3\", \"Tx_MAF\", \"Tx_MAFA\", \"Tx_MAFB\", \"Tx_MYC\" )){\n  bcf_list_filted_subanno[[i]] &lt;- subdf[[i]]|bcf_list_filted_subanno[[i]]\n}\nbcf_list_filted_subanno$\"Tx_NSD2/FGFR3\" &lt;- bcf_list_filted_subanno$Tx_NSD2\nbcf_list_filted_subanno$\"Tx_NSD2/FGFR3\"[is.na(bcf_list_filted_subanno$Tx_NSD2)] &lt;- bcf_list_filted_subanno$Tx_FGFR3[is.na(bcf_list_filted_subanno$Tx_NSD2)]\n\n# CNV\njilin_cnvdf &lt;- \"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/rnaseq/figures/heatmap/cnv_rnaclusterenrich_used/annotated_longmatrix_jilin.rds\" |&gt; read_rds()\ncommpass_cnvdf &lt;- \"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/rnaseq/figures/heatmap/cnv_rnaclusterenrich_used/annotated_longmatrix_commpass.rds\" |&gt; read_rds()\ncolnames(commpass_cnvdf)[2] &lt;- \"chr_gene\"\ncommpass_cnvdf$sample_id &lt;- paste0(commpass_cnvdf$sample_id, \"T\")\n\njilin_cnvdf0 &lt;- make_cnvdf(jilin_cnvdf)\ncommpass_cnvdf0 &lt;- make_cnvdf(commpass_cnvdf)\nfull_cnvdf &lt;- subdf |&gt; \n  dplyr::select(sample_id) |&gt;\n  left_join(list(jilin_cnvdf0, commpass_cnvdf0) |&gt; list_rbind())\nfor(i in cnvlevels){\n  ftcnv &lt;- is.na(full_cnvdf[[i]])&(!is.na(subdf[[glue(\"{i}_fish\")]]))\n  full_cnvdf[[i]][ftcnv] &lt;- case_when(\n    subdf[[glue(\"{i}_fish\")]][ftcnv] == 1 ~ \"Gain\",\n    subdf[[glue(\"{i}_fish\")]][ftcnv] == -1 ~ \"Del\",\n    subdf[[glue(\"{i}_fish\")]][ftcnv] == 0 ~ \"Normal\"\n  )\n}\n\n# mutations\nwd_mutation_clean &lt;- \"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/fig2/checkmutation/samtools_merge_mut_hotspots.rds\" |&gt;\n  read_rds()\nsmall_label &lt;- read_rds(\"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/commpass_wd_mutation_clean_small_label_raw.rds\")\nsmall_label_fix &lt;- read_rds(\"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/commpass_wd_mutation_clean_small_label.rds\")\n\n# \np1 &lt;- subdf[ft, c(\"sample_id\", \"subtypes\")] |&gt;\n  mutate(sample_id = factor(sample_id, levels = sample_id)) |&gt;\n  pivot_longer(-sample_id, names_to = \"name\", values_to = \"subtypes\") |&gt;\n  ggplot(aes(sample_id, name, fill = subtypes)) +\n  geom_tile() +\n  scale_fill_manual(values = col$subtypes, guide = guide_legend(ncol = 3)) +\n  scale_y_discrete(expand = expansion(mult = c(0, 0))) +\n  ylab(\"Annotation\") +\n  theme_few() +\n  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),\n        axis.text.y = element_text(color = \"black\"), axis.ticks.length.x = unit(0, \"mm\"),\n        legend.position = \"right\", plot.margin = margin(b = 0),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5))\n\np2 &lt;- joinedf |&gt;\n  pivot_longer(-sample_id) |&gt;\n  group_by(name) |&gt;\n  mutate(value = scale(value)[,1],\n         value = pmax(pmin(value, 2), -2),\n         name = factor(name, levels = rev(genes))) |&gt;\n  ggplot(aes(sample_id, name, fill = value)) +\n  geom_tile() +\n  scale_fill_gradient2(low = \"#1E90FF\", high = \"#DC143C\",\n                       name = \"Expression\", guide = guide_colorbar(direction = \"vertical\")) +\n  scale_y_discrete(expand = expansion(mult = c(0, 0))) +\n  ylab(\"Expression\") +\n  theme_few() +\n  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),\n        axis.text.y = element_text(color = \"black\"), axis.ticks.length.x = unit(0, \"mm\"),\n        legend.position = \"right\", plot.margin = margin(b = 0, t = 0),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5))\n\np3 &lt;- bcf_list_filted_subanno[ft, c(\"sample_id\", igv)] |&gt;\n  mutate(sample_id = factor(sample_id, levels = sample_id)) |&gt;\n  pivot_longer(-sample_id) |&gt;\n  mutate(name = factor(str_remove(name, \"Tx_\"), levels = rev(str_remove(igv, \"Tx_\"))),\n         value2 = case_when(is.na(value) ~ \"NA\", value ~ \"TRUE\", TRUE ~ \"FALSE\")) |&gt;\n  ggplot(aes(sample_id, name, fill = value2)) +\n  geom_tile() +\n  scale_fill_manual(values = config_list$Igtrans_color,\n                    name = \"Ig trans\", guide = guide_legend(ncol = 1)) +\n  scale_y_discrete(expand = expansion(mult = c(0, 0))) +\n  ylab(\"Ig translocations\") +\n  theme_few() +\n  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),\n        axis.text.y = element_text(color = \"black\"), axis.ticks.length.x = unit(0, \"mm\"),\n        legend.position = \"right\", plot.margin = margin(t = 0),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5))\n\np4 &lt;- subdf[ft,] |&gt;\n  dplyr::select(sample_id) |&gt; \n  left_join(wd_mutation_clean) |&gt; \n  pivot_longer(-sample_id) |&gt; \n  mutate(\n    name = str_remove(name, pattern = \"_other\"),\n    sample_id = factor(sample_id, levels = rownames(objht$heatmap2[[6]])),\n    name = factor(name, \n                  levels = unique(rev(small_label))),\n    mutation_type = case_when(\n      is.na(value) ~ \"NA\",\n      T ~ as.character(value)\n    )\n  ) |&gt; \n  dplyr::filter(!is.na(name)) |&gt; \n  ggplot(aes(x = sample_id, y = name, fill = mutation_type)) +\n  geom_tile()+\n  scale_fill_manual(values = c(\"TRUE\" = \"black\", \"FALSE\"= \"grey\", \"NA\"= \"grey90\"),\n                    name = \"Mutation\", guide = guide_legend(ncol = 1)) +\n  ylab(\"Mutation\") +\n  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),\n        axis.text.y = element_text(color = \"black\"), axis.ticks.length.x = unit(0, \"mm\"),\n        legend.position = \"right\", plot.margin = margin(t = 0),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5))\n\np5 &lt;- full_cnvdf[ft, c(\"sample_id\", cnvlevels)] |&gt;\n  mutate(sample_id = factor(sample_id, levels = sample_id)) |&gt;\n  pivot_longer(-sample_id) |&gt;\n  mutate(name = factor(name, levels = rev(cnvlevels)),\n         value2 = case_when(is.na(value) ~ \"NA\", \n                            T ~ value)) |&gt;\n  ggplot(aes(sample_id, name, fill = value2)) +\n  geom_tile() +\n  scale_fill_manual(values = config_list$cnv_color,\n                    name = \"CNV\", guide = guide_legend(ncol = 1)) +  \n  scale_y_discrete(expand = expansion(mult = c(0, 0))) +\n  ylab(\"CNV\") +\n  theme_few() +\n  theme(axis.text.x = element_blank(), axis.title.x = element_blank(),\n        axis.line.x = element_line(linewidth = 0.5, color = \"black\"),\n        axis.text.y = element_text(color = \"black\"), axis.ticks.length.x = unit(0, \"mm\"),\n        legend.position = \"right\", plot.margin = margin(t = 0),\n        panel.border = element_rect(fill = NA, color = \"black\", size = 0.5))\n\npdf(glue(\"{out_dir}/figure2_heatmap.pdf\"), width = 12, height = 10)\n(p1 / p2 / p3 / p4 / p5) + plot_layout(ncol = 1, heights = c(0.1, 1.2, 0.8, 0.1*length(small_label), 1.3) * 0.05, guides = \"collect\") &\n  theme(legend.position = \"bottom\")\ndev.off()\n\n\n\n\nheatmap for DNA events\n\n\n\n15.5.1 DNA events test\n\nmutobj &lt;- read_rds(\"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/fig2/checkmutation/full_mutdf_anno.rds\")\nmutobj_list &lt;- split(mutobj, f = mutobj$name)\ncnvobj &lt;- read_rds(\"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/fig2/checkmutation/full_cnvdf_anno.rds\")\ncnvobj &lt;- cnvobj %&gt;% dplyr::select(- value2) %&gt;% dplyr::rename(cnvtype = value)\ncnvobj_list &lt;- split(cnvobj, f = cnvobj$name)\nmutobj_list_table &lt;- lapply(mutobj_list, function(x){\n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(subtypes)) %&gt;% \n    dplyr::select(value, subtypes) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat$positiven &lt;- positiven\n  tbrat$groupn &lt;- groupn\n  tbrat$edgep &lt;- edgep\n  tbrat$type &lt;- \"subtypes\"\n  colnames(tbrat)[1] &lt;- \"group\"\n  \n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(ethnicity)) %&gt;% \n    dplyr::select(value, ethnicity) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat2 &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat2$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat2$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat2$positiven &lt;- positiven\n  tbrat2$edgep &lt;- edgep\n  tbrat2$groupn &lt;- groupn\n  tbrat2$type &lt;- \"ethnicity\"\n  colnames(tbrat2)[1] &lt;- \"group\"\n  \n  rbind(tbrat, tbrat2)\n})|&gt; \n  list_rbind(names_to = \"label\")\nmutobj_list_table$mutation_type &lt;- \"mutation\"\nmutobj2 &lt;- read_rds(\"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/fig2/checkmutation/full_mutdf_anno.rds\")\nmutobj2 &lt;- mutobj2 |&gt; \n  dplyr::mutate(gene = str_extract(name, pattern = \".+?(?=_)\")) |&gt; \n  group_by(sample_id, gene, subtypes, ethnicity) |&gt; \n  summarise(value = case_when(\n    all(is.na(value)) ~ NA,\n    any(na.omit(value)) ~ T,\n    all(!na.omit(value)) ~ F\n  )) |&gt; \n  ungroup()\ncolnames(mutobj2)[2] &lt;- \"name\"\nmutobj_list2 &lt;- split(mutobj2, f = mutobj2$name)\nmutobj_list_table2 &lt;- lapply(mutobj_list2, function(x){\n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(subtypes)) %&gt;% \n    dplyr::select(value, subtypes) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat$positiven &lt;- positiven\n  tbrat$groupn &lt;- groupn\n  tbrat$edgep &lt;- edgep\n  tbrat$type &lt;- \"subtypes\"\n  colnames(tbrat)[1] &lt;- \"group\"\n  \n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(ethnicity)) %&gt;% \n    dplyr::select(value, ethnicity) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat2 &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat2$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat2$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat2$positiven &lt;- positiven\n  tbrat2$edgep &lt;- edgep\n  tbrat2$groupn &lt;- groupn\n  tbrat2$type &lt;- \"ethnicity\"\n  colnames(tbrat2)[1] &lt;- \"group\"\n  \n  rbind(tbrat, tbrat2)\n})|&gt; \n  list_rbind(names_to = \"label\")\nmutobj_list_table2$mutation_type &lt;- \"mutation\"\ncnvobj_list_table_Gain &lt;- lapply(cnvobj_list, function(x){\n  x &lt;- x %&gt;% mutate(\n    value = case_when(\n      cnvtype == \"Gain\" ~ TRUE,\n      cnvtype %in% c(\"Normal\", \"Del\") ~ FALSE,\n    )\n  )\n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(subtypes)) %&gt;% \n    dplyr::select(value, subtypes) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat$positiven &lt;- positiven\n  tbrat$edgep &lt;- edgep\n  tbrat$groupn &lt;- groupn\n  tbrat$type &lt;- \"subtypes\"\n  colnames(tbrat)[1] &lt;- \"group\"\n  \n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(ethnicity)) %&gt;% \n    dplyr::select(value, ethnicity) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat2 &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat2$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat2$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat2$positiven &lt;- positiven\n  tbrat2$edgep &lt;- edgep\n  tbrat2$groupn &lt;- groupn\n  tbrat2$type &lt;- \"ethnicity\"\n  colnames(tbrat2)[1] &lt;- \"group\"\n  \n  \n  rbind(tbrat, tbrat2)\n})|&gt; \n  list_rbind(names_to = \"label\")\ncnvobj_list_table_Gain$mutation_type &lt;- \"Gain\"\ncnvobj_list_table_Del &lt;- lapply(cnvobj_list, function(x){\n  x &lt;- x %&gt;% mutate(\n    value = case_when(\n      cnvtype == \"Del\" ~ TRUE,\n      cnvtype %in% c(\"Normal\", \"Del\") ~ FALSE,\n    )\n  )\n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(subtypes)) %&gt;% \n    dplyr::select(value, subtypes) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat$positiven &lt;- positiven\n  tbrat$edgep &lt;- edgep\n  tbrat$groupn &lt;- groupn\n  tbrat$type &lt;- \"subtypes\"\n  colnames(tbrat)[1] &lt;- \"group\"\n  \n  tb &lt;-  x %&gt;% \n    dplyr::filter(!is.na(value)) %&gt;% \n    dplyr::filter(!is.na(ethnicity)) %&gt;% \n    dplyr::select(value, ethnicity) %&gt;% \n    table()\n  fisherobj &lt;- tb %&gt;% \n    fisher.test(simulate.p.value=TRUE)\n  groupn &lt;- colSums(tb)\n  positiven &lt;- tb[\"TRUE\",]\n  edgepv &lt;- rowSums(tb)\n  edgep &lt;- edgepv[\"TRUE\"]/(edgepv[\"TRUE\"] + edgepv[\"FALSE\"])\n  \n  tbrat2 &lt;- as.data.frame(t(tb)/groupn) %&gt;% \n    dplyr::filter(value == \"TRUE\")\n  tbrat2$multibinop &lt;-   lapply(names(groupn), function(i){\n    dpv &lt;- dbinom(0:groupn[[i]], size = groupn[[i]], prob = edgep)\n    1-sum(dpv[1:(positiven[[i]]+1)])\n  }) %&gt;% unlist()\n  tbrat2$fisher_pvalue &lt;- fisherobj$p.value\n  tbrat2$positiven &lt;- positiven\n  tbrat2$edgep &lt;- edgep\n  tbrat2$groupn &lt;- groupn\n  tbrat2$type &lt;- \"ethnicity\"\n  colnames(tbrat2)[1] &lt;- \"group\"\n  \n  \n  rbind(tbrat, tbrat2)\n})|&gt; \n  list_rbind(names_to = \"label\")\ncnvobj_list_table_Del$mutation_type &lt;- \"Del\"\n\n\nsubtypesorder &lt;- subdf[ft, c(\"sample_id\", \"subtypes\")] |&gt;\n  mutate(sample_id = factor(sample_id, levels = sample_id)) |&gt;\n  pivot_longer(-sample_id, names_to = \"name\", values_to = \"subtypes\") |&gt; \n  pull(subtypes) |&gt; unique()\nsubtypesorder &lt;- c(subtypesorder, \"Caucasian\", \"Asian\", \"African\")\n\nfulldf &lt;- rbind(mutobj_list_table, \n                mutobj_list_table2, \n                cnvobj_list_table_Gain, \n                cnvobj_list_table_Del)\nsmall_label_fix &lt;- c(\n  \"KRAS_Gln61\", \"KRAS_Gly12\", \"KRAS_Gly13\", \"KRAS_Tyr64\", \"KRAS_Ala146\", \"KRAS_Lys117\",  \"KRAS\", \n  \"NRAS_Gln61\", \"NRAS_Gly13\", \"NRAS_Gly12\", \"NRAS_Tyr64\", \"NRAS\",\n  \"BRAF_Val600\", \"BRAF_Asp594\", \"BRAF_Gly469\", \"BRAF\", \n  \"DIS3_Arg780\", \"DIS3_Asp488\", \"DIS3_Asp479\", \"DIS3\", \n  \"IRF4_Lys123\", \n  \"FGFR3_Ter809\")\n\nfulldf &lt;- fulldf |&gt; \n  dplyr::filter(group != \"other\") |&gt; \n  mutate(mutation_type = factor(mutation_type, levels = c(\"mutation\", \"Gain\", \"Del\")),\n         group = factor(group, levels = subtypesorder),\n         label = factor(label, levels = c(small_label_fix, cnvlevels) |&gt; rev()),\n         type = factor(type, levels = c(\"subtypes\", \"ethnicity\"))) |&gt; \n  na.omit()\n# ==============================================================================\n# plot\nout_dir &lt;- dir_create(\"mutations_heatmap\")\ndraw_main &lt;- function(fulldf, color_h = \"#DC143C\"){\n  ggplot(mapping = aes(x = group, y = label, \n                       fill = Freq, color = mutation_type)) +\n    geom_tile(data = fulldf, color = \"grey\")  + \n    scale_fill_gradient2(high = color_h,\n                         name = \"Rate in groups\",\n                         guide = guide_colorbar(direction = \"vertical\")) +\n    geom_text(data = fulldf |&gt;\n                dplyr::filter(multibinop &lt; 0.05 & fisher_pvalue &lt; 0.05) |&gt; \n                mutate(star = case_when(\n                  multibinop &lt; 0.01 ~ \"**\",\n                  multibinop &lt; 0.05 ~ \"*\"\n                )),\n              mapping = aes(label = star),\n              color = \"black\", size = 5, nudge_y = - 0.25) +\n    geom_text(data = fulldf |&gt;\n                dplyr::filter(multibinop &lt; 0.1 & multibinop &gt; 0.05 & fisher_pvalue &lt; 0.05 & positiven &gt; 2) |&gt; \n                mutate(multibinop = signif(multibinop, digits = 2)),\n              mapping = aes(label = multibinop),\n              color = \"black\", size = 3) +\n    facet_grid(mutation_type ~ type, scales = \"free\", space = \"free\")+\n    scale_x_discrete(expand = expansion(mult = c(0, 0))) +\n    scale_y_discrete(expand = expansion(mult = c(0, 0))) +\n    theme_few() +\n    theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),\n          axis.title.x = element_blank(),\n          axis.line.x = element_line(linewidth = 0.5, color = \"black\"),\n          axis.title.y = element_blank(),\n          axis.text.y = element_text(color = \"black\"), \n          axis.ticks.length.x = unit(0, \"mm\"),\n          legend.position = \"right\", \n          plot.margin = margin(t = 0, r = 0),\n          strip.background = element_blank(),\n          strip.text = element_blank(),\n          panel.border = element_rect(fill = NA, color = \"black\", size = 0.5),\n          panel.spacing.x = unit(0, \"mm\"),\n          panel.spacing.y = unit(0, \"mm\"))\n}\nmain_p1 &lt;- draw_main(fulldf |&gt; dplyr::filter(mutation_type == \"mutation\"), color_h = \"#7BBB42\") +\n  theme(axis.text.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        axis.ticks.length.x = unit(0, \"mm\"),\n        axis.title.x = element_blank())\nmain_p2 &lt;- draw_main(fulldf |&gt; dplyr::filter(mutation_type == \"Gain\"), color_h = \"#DC143C\")+\n  theme(axis.text.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        axis.ticks.length.x = unit(0, \"mm\"),\n        axis.title.x = element_blank())\nmain_p3 &lt;- draw_main(fulldf |&gt; dplyr::filter(mutation_type == \"Del\"), color_h = \"#1E90FF\")\n\n\n\ntop_p &lt;- fulldf |&gt; dplyr::select(group, type) |&gt; \n  dplyr::distinct() |&gt; \n  ggplot(mapping = aes(x = group, y = 1, color = group, shape = type)) +\n  geom_tile(fill = NA, color = NA) +\n  geom_point(size = 4)+ \n  facet_grid(. ~ type, scales = \"free\", space = \"free\")+\n  scale_x_discrete(expand = expansion(mult = c(0, 0))) +\n  scale_color_manual(values = c(col$subtypes, col$ethnicity), \n                     guide = guide_legend(ncol = 3),\n                     name = \"Group\") +\n  scale_shape_manual(values = c(subtypes = 16, ethnicity = 17), \n                     guide = guide_legend(ncol = 1),\n                     name = \"Types\") +\n  theme_few() + \n  theme(plot.margin = margin(b = 0),\n        axis.text.x = element_blank(),\n        axis.title.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        axis.ticks.length.x = unit(0, \"mm\"),\n        axis.title.y = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank(),\n        panel.spacing.x = unit(0, \"mm\"))\n\nrightp &lt;- fulldf |&gt; \n  dplyr::filter(type == \"subtypes\") |&gt; \n  dplyr::select(label, edgep, mutation_type, fisher_pvalue) |&gt; \n  dplyr::distinct()|&gt; \n  ggplot(mapping = aes(x = edgep, y = label, fill = -log10(fisher_pvalue))) +\n  geom_tile(fill = NA, color = NA) +\n  geom_bar(stat = \"identity\", position = \"dodge\") +\n  facet_grid(mutation_type ~ 1, scales = \"free\", space = \"free\")+\n  scale_y_discrete(expand = expansion(mult = c(0, 0))) +\n  scale_x_continuous(expand = expansion(mult = c(0, 0)),\n                     n.breaks = 3) +\n  scale_fill_gradient2(high = \"#035e03\",\n                       name = \"-log10(Fisher pvalue)\", \n                       guide = guide_colorbar(direction = \"vertical\")) +\n  theme_few() + \n  theme(plot.margin = margin(l = 0),\n        # axis.title.x = element_blank(),\n        axis.title.y = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank(),\n        axis.ticks.length.y = unit(0, \"mm\"),\n        strip.background.x = element_blank(),\n        strip.text.x = element_blank(),\n        panel.spacing.x = unit(0, \"mm\"),\n        panel.spacing.y = unit(0, \"mm\"))\npempth &lt;- ggplot() +\n  theme_few() + \n  theme(plot.margin = margin(l = 0),\n        axis.text.x = element_blank(),\n        axis.title.x = element_blank(),\n        axis.ticks.x = element_blank(),\n        axis.ticks.length.x = unit(0, \"mm\"),\n        axis.title.y = element_blank(),\n        axis.text.y = element_blank(),\n        axis.ticks.y = element_blank(),\n        axis.ticks.length.y = unit(0, \"mm\"),\n        strip.background = element_blank(),\n        strip.text = element_blank(),\n        panel.border = element_blank())\npdf(glue(\"{out_dir}/fig2_heatmap_dna_test.pdf\"), width = 8, height = 11)\ntop_p + pempth + (main_p1+ main_p2+ main_p3+ plot_layout(ncol = 1,\n                                                         heights = c(length(small_label_fix),\n                                                                     length(cnvlevels),\n                                                                     length(cnvlevels)))) + \n  rightp  + plot_layout(ncol = 2,\n                        heights = c(2, length(subtypesorder) +\n                                      length(small_label_fix) +\n                                      length(cnvlevels)*2),\n                        widths = c(17, 1.5),\n                        guides = \"collect\") &\n  theme(legend.position = \"bottom\")\ndev.off()\n\n ### DNA events test\n\nsmall_label &lt;- read_rds(\"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/commpass_wd_mutation_clean_small_label.rds\")\ncommpass_maf &lt;- \"/cluster/home/yjliu_jh/projects/mm/output/41588_2024_1853_MOESM5_ESM_hg38.rds\" |&gt; \n  read_rds()\ncommpass_maf_sub &lt;- commpass_maf |&gt; dplyr::select(\n  sample_id = sample, GENE,  \n  chr = Chromosome, pos = Start_Position, REF, ALT,  \n  TUMOR_REF_AD, TUMOR_ALT_AD, TUMOR_ALT_FREQ, HGVS_P)|&gt; \n  dplyr::filter(HGVS_P != \".\") |&gt; \n  mutate(aa.pos = str_extract(HGVS_P, pattern = \"(?&lt;=p\\\\.)[A-Za-z]+\\\\d+\"),\n         small_label = paste0(GENE, \"_\", aa.pos),\n         dataype = \"WGS\")|&gt; \n  dplyr::filter(small_label %in% {{small_label}}) \n\n\nall_mutation_df_fix_anno &lt;- read_rds(\"/cluster/home/ztao_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/check20250623/fig2/checkmutation/samtools_subsamples_mutation_df.rds\") |&gt;\n  dplyr::filter(mutation_label == \"usemutation\") |&gt; \n  mutate(\n    max_alt_count = max(c(a, t, c, g)),\n    max_alt_vaf = max_alt_count/(a + t + c + g + match),\n    alt = c(\"A\", \"T\", \"C\", \"G\")[which.max(c(a, t, c, g))]\n  ) |&gt; \n  ungroup()|&gt; \n  mutate(small_label = paste0(gene, \"_\", aa.pos)) |&gt; \n  dplyr::filter(small_label %in% {{small_label}}) \n\nall_mutation_df_fix_anno_sub &lt;- all_mutation_df_fix_anno |&gt; \n  dplyr::select(small_label, sample_id, dataype, max_alt_vaf) \ncommpass_maf_sub_sub &lt;- commpass_maf_sub |&gt; \n  dplyr::select(small_label, sample_id, dataype, max_alt_vaf = TUMOR_ALT_FREQ) \nall_mutation &lt;- rbind(all_mutation_df_fix_anno_sub, commpass_maf_sub_sub) \nall_mutation &lt;- all_mutation |&gt; dplyr::filter(sample_id %in% subdf$sample_id[ft])\n\nsmall_label_all &lt;- all_mutation$small_label |&gt; unique()\nsummary_all_mutation &lt;- all_mutation |&gt; \n  dplyr::filter(small_label %in% small_label_all) |&gt; \n  mutate(mutation_type = case_when(\n    str_detect(small_label, pattern = \"NRAS|KRAS\") ~ \"NRAS/KRAS\",\n    str_detect(small_label, pattern = \"IRF4_Lys123\") ~ \"IRF4_Lys123\",\n    str_detect(small_label, pattern = \"FGFR3\") ~ \"FGFR3\",\n    str_detect(small_label, pattern = \"DIS3\") ~ \"DIS3\",\n    str_detect(small_label, pattern = \"BRAF\") ~ \"BRAF\",\n    T ~ \"others\"\n  )) |&gt; \n  group_by(sample_id, dataype, small_label, mutation_type) |&gt; \n  summarise(\n    max_alt_vaf = max(max_alt_vaf)\n  ) |&gt; \n  ungroup()\n\ntable(summary_all_mutation$mutation_type, summary_all_mutation$small_label)\n\npdf(glue(\"figure2_vaf_point.pdf\"))\nprint(summary_all_mutation |&gt; \n        pivot_wider(id_cols = c(sample_id, small_label, mutation_type), \n                    names_from = dataype, values_from = max_alt_vaf) |&gt; \n        na.omit() |&gt; \n        arrange(desc(mutation_type)) |&gt; \n        ggplot(aes(x = RNA, y = WGS, color = mutation_type)) +\n        geom_point() +\n        geom_smooth(method = \"lm\", se = FALSE) +\n        scale_color_manual(values = c(\"NRAS/KRAS\" = \"#D1352B\", \"IRF4_Lys123\" = \"#035e03\",\n                                      \"FGFR3\" = \"#EE934E\", \"DIS3\" = \"#1E90FF\",\"BRAF\" = \"#5653a5\",\n                                      \"others\" = \"grey\")) +\n        theme_few() +\n        theme(\n          legend.position = \"bottom\"\n        )\n)\ndev.off()\n\n\nmutation_gene_color &lt;- c(\n  \"#D1352B\", \"#EE934E\", \"#9B5B33\",\"#F5D2A8\", \n  \"#129a71\", \"#89e409\", \"#035e03\", \"#7BBB42\", \"#7DBFA7\" \n  )\nnames(mutation_gene_color) &lt;- c(\"KRAS\", \"NRAS\", \"IRF4\", \"DIS3\", \n                                \"BRAF\", \"FGFR3\", \n                                \"PTPN11\", \"MAX\", \"HIST1H1E\")\npdf(glue(\"all_point_supp.pdf\"))\nprint(summary_all_mutation |&gt; \n        pivot_wider(id_cols = c(sample_id, small_label, mutation_type), \n                    names_from = dataype, values_from = max_alt_vaf) |&gt; \n        na.omit() |&gt; \n        mutate(Gene = str_extract(small_label, pattern = \".+?(?=_)\"),\n               Gene = factor(Gene, levels = c(\"KRAS\", \"NRAS\", \"IRF4\", \"DIS3\", \n                                              \"BRAF\", \"FGFR3\", \n                                              \"PTPN11\", \"MAX\", \"HIST1H1E\"))) |&gt; \n        ggplot(aes(x = RNA, y = WGS, color = Gene)) +\n        geom_point() +\n        geom_smooth(method = \"lm\", se = FALSE) +\n        scale_color_manual(values = mutation_gene_color) +\n        theme_few() +\n        theme(\n          legend.position = \"bottom\"\n        ) +\n        facet_wrap(~ Gene)\n)\ndev.off()\n\n\n\n\nVAF of WGS and RNA\n\n\n\nmycolor &lt;- c(\"RNA\" = \"#EE934E\", \"WGS\" = \"#035e03\") \npdf(glue(\"figure2_vaf_box.pdf\"), height = 4)\nprint(\n  ggplot(summary_all_mutation |&gt; \n           mutate(dataype = factor(dataype, levels = unique(dataype)),\n                  mutation_type = factor(mutation_type, levels = c(\"NRAS/KRAS\", \"IRF4_Lys123\", \"DIS3\", \"BRAF\", \"FGFR3\", \"others\"))),\n         aes(x=dataype,\n             y=max_alt_vaf,\n             fill=dataype,\n             color=dataype)) +\n    scale_color_manual(values=rev(mycolor)) +\n    scale_fill_manual(values=rev(mycolor)) +\n    geom_half_violin(position = position_nudge(x = 0.1, y = 0),\n                     side = 'R', adjust = 1.2, trim = F, color = NA, alpha = 0.8) +\n    geom_point(aes(x = as.numeric(dataype) - 0.1,\n                   y = max_alt_vaf,\n                   color = dataype),\n               position = position_jitter(width = 0.03),size = 1, shape = 20) + \n    # geom_boxplot(outlier.shape = NA, width = 0.1, alpha = 0.7) +\n    geom_boxplot(width = 0.1, alpha = 0.7, outlier.size = 1, outlier.shape = 20) +\n    geom_hline(yintercept = 0.5, color = \"#D1352B\") +\n    geom_hline(yintercept = c(0.333333, 0.666666), linetype = \"dashed\", color = \"grey\") +\n    theme_few() +\n    theme(\n      legend.position = \"bottom\",\n      panel.spacing.x = unit(0, \"mm\")\n    ) + \n    facet_grid(.~mutation_type, space = \"free_x\") \n)\ndev.off()\n\n\n\n\nVAF of WGS and RNA\n\n\n\nfor(j in unique(summary_all_mutation$mutation_type)){\n  j0 &lt;- str_replace_all(j, pattern = \"/\", \"_\")\n  pdf(glue(\"split_{j0}_point.pdf\"))\n  print(summary_all_mutation |&gt; \n          dplyr::filter(mutation_type == {{j}}) |&gt; \n          pivot_wider(id_cols = c(sample_id, small_label, mutation_type), \n                      names_from = dataype, values_from = max_alt_vaf) |&gt; \n          na.omit() |&gt; \n          arrange(desc(mutation_type)) |&gt; \n          ggplot(aes(x = RNA, y = WGS, color = mutation_type)) +\n          geom_point() +\n          geom_smooth(method = \"lm\", se = FALSE) +\n          scale_color_manual(values = c(\"NRAS/KRAS\" = \"#D1352B\", \"IRF4_Lys123\" = \"#035e03\",\n                                        \"FGFR3\" = \"#EE934E\", \"DIS3\" = \"#1E90FF\",\"BRAF\" = \"#5653a5\",\n                                        \"others\" = \"grey\")) +\n          theme_few() +\n          theme(\n            legend.position = \"bottom\"\n          )\n  )\n  dev.off()\n  \n  mycolor &lt;- c(\"RNA\" = \"#EE934E\", \"WGS\" = \"#035e03\") \n  pdf(glue(\"split_{j0}_box.pdf\"))\n  print(\n    ggplot(summary_all_mutation |&gt; \n             dplyr::filter(mutation_type == {{j}}) |&gt; \n             mutate(dataype = factor(dataype, levels = unique(dataype))),\n           aes(x=dataype,\n               y=max_alt_vaf,\n               fill=dataype,\n               color=dataype)) +\n      scale_color_manual(values=rev(mycolor)) +\n      scale_fill_manual(values=rev(mycolor)) +\n      geom_half_violin(position = position_nudge(x = 0.1, y = 0),\n                       side = 'R', adjust = 1.2, trim = F, color = NA, alpha = 0.8) +\n      geom_point(aes(x = as.numeric(dataype) - 0.1,\n                     y = max_alt_vaf,\n                     color = dataype),\n                 position = position_jitter(width = 0.03),size = 3, shape = 20) + \n      # geom_boxplot(outlier.shape = NA, width = 0.1, alpha = 0.7) +\n      geom_boxplot(outlier.shape = NA, width = 0.1, alpha = 0.7) +\n      geom_hline(yintercept = 0.5, color = \"#D1352B\") +\n      geom_hline(yintercept = c(0.333333, 0.666666), linetype = \"dashed\", color = \"grey\") +\n      theme_few() +\n      theme(\n        legend.position = \"bottom\"\n      )\n  )\n  dev.off()\n}\n\nfor(i in small_label_all){\n  summary_all_mutation &lt;- all_mutation |&gt; \n    dplyr::filter(small_label == {{i}}) |&gt; \n    group_by(sample_id, dataype) |&gt; \n    summarise(\n      max_alt_vaf = max(max_alt_vaf)\n    ) |&gt; \n    ungroup()\n  \n  pdf(glue(\"{i}_points.pdf\"))\n  print(summary_all_mutation |&gt; \n          pivot_wider(id_cols = sample_id, names_from = dataype, values_from = max_alt_vaf) |&gt; \n          na.omit() |&gt; \n          ggplot(aes(x = RNA, y = WGS)) +\n          geom_point())\n  dev.off()\n  mycolor &lt;- c(\"RNA\" = \"#EE934E\", \"WGS\" = \"#035e03\") \n  pdf(glue(\"{i}_box.pdf\"))\n  print(\n    ggplot(summary_all_mutation |&gt; mutate(dataype = factor(dataype, levels = unique(dataype))),\n           aes(x=dataype,\n               y=max_alt_vaf,\n               fill=dataype,\n               color=dataype)) +\n      scale_color_manual(values=rev(mycolor)) +\n      scale_fill_manual(values=rev(mycolor)) +\n      geom_half_violin(position = position_nudge(x = 0.1, y = 0),\n                       side = 'R', adjust = 1.2, trim = F, color = NA, alpha = 0.8) +\n      geom_point(aes(x = as.numeric(dataype) - 0.1,\n                     y = max_alt_vaf,\n                     color = dataype),\n                 position = position_jitter(width = 0.03),size = 3, shape = 20) + \n      # geom_boxplot(outlier.shape = NA, width = 0.1, alpha = 0.7) +\n      geom_boxplot(outlier.shape = NA, width = 0.1, alpha = 0.7) +\n      geom_hline(yintercept = 0.5, color = \"#D1352B\") +\n      geom_hline(yintercept = c(0.333333, 0.666666), linetype = \"dashed\", color = \"grey\") +\n      theme_few() +\n      theme(\n        legend.position = \"bottom\"\n      )\n  )\n  dev.off()\n}",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>15</span>  <span class='chapter-title'>Figure 2</span>"
    ]
  },
  {
    "objectID": "fig3.html",
    "href": "fig3.html",
    "title": "16  Figure 3",
    "section": "",
    "text": "16.1 Figure 3",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>16</span>  <span class='chapter-title'>Figure 3</span>"
    ]
  },
  {
    "objectID": "fig3.html#figure-3",
    "href": "fig3.html#figure-3",
    "title": "16  Figure 3",
    "section": "",
    "text": "16.1.1 Functional relavances of samples in the IgD-enriched subtype\ncode:\n\npkgs &lt;- c(\"GSVA\", \"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \n          \"jhtools\", \"glue\", \"ggsci\", \"patchwork\", \"tidyverse\", \"dplyr\", \n          \"SummarizedExperiment\", \"jhuanglabRNAseq\", \"DESeq2\", \"maftools\", \n          \"matrixStats\", \"Matrix\", \"furrr\", \"ComplexHeatmap\", \"rstatix\",\n          \"clusterProfiler\", \"DOSE\", \"enrichplot\", \"org.Hs.eg.db\", \n          \"ggthemes\", \"EnhancedVolcano\", \"GseaVis\", \"glmnet\", \"tidyplots\")\nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n} \n\n# set workdir\nsetwd(\"/cluster/home/yjliu_jh/projects/mm/analysis/meta/human/figures/heatmap/check_new_cluster_addsamples/fixed_check\")\n\n# get samples\nclusterings &lt;- readxl::read_excel(\"/cluster/home/jhuang/projects/mm/analysis/meta/human/figures/heatmap/eda/check_new_cluster_addsamples/fixed_samples_3/sampleinfo_0.95.xlsx\")\ncolnames(clusterings)[1] &lt;- \"sample_id\"\n\n# get exp data\nmm1330 &lt;- read_rds(\"~/projects/mm/analysis/meta/human/rnaseq/exp/mm1330.rds\") %&gt;% convert_df_plot()\n\n# get rna sequencing type\npred_rna_lib &lt;- function (dat_mat) {\n  his_genes1 &lt;- c(\"H4C11\", \"H2BC3\", \"H4C4\", \"H3C12\", \"H2BC14\", \n                  \"H4C6\", \"H2AC16\", \"H2AC11\", \"H2AC12\", \"H1−5\", \"H3C2\", \n                  \"H3C3\", \"H3C11\", \"H2AC17\", \"H2AC13\", \"H2BC13\", \"H2AC4\", \n                  \"H2AC14\", \"H4C9\", \"H4C1\", \"H4C2\", \"H4C13\", \"H3C7\", \"H2BC9\", \n                  \"H2BC10\", \"H3C8\", \"H3C13\", \"H2BC7\", \"H2BC18\", \"H2BC15\", \n                  \"H4C14\", \"H4C8\", \"H2BC17\", \"H3C10\", \"H2BC11\", \"H4C12\", \n                  \"H3C15\", \"H2BC8\", \"H2AC8\", \"H2BC6\", \"H4C5\", \"H2AC15\", \n                  \"H1−3\", \"H3C4\", \"H4−16\", \"H2AC20\", \"H2AC21\", \"H3C1\", \n                  \"H2BC5\", \"H1−4\", \"H2AC7\", \"H2BC4\", \"H1−2\", \"H2AC6\")\n  inter_genes &lt;- intersect(his_genes1, rownames(dat_mat))\n  stopifnot(\"please make sure histone genes is contained in the data\" = length(inter_genes) &gt; 0)\n  dat_mat &lt;- dat_mat[rownames(dat_mat) %in% inter_genes, ]\n  clust &lt;- data.frame(cluster = cutree(hclust(dist(t(dat_mat))), k = 2))\n  diff &lt;- mean(unlist(dat_mat[, clust$cluster %in% 1])) - mean(unlist(dat_mat[, clust$cluster %in% 2]))\n  clust$rna_type &lt;- \"mRNA\"\n  clust$rna_type[clust$cluster == (2 - sum(diff &gt; 0))] &lt;- \"total_RNA\"\n  new_dat &lt;- data.frame(sample_id = rownames(clust), rna_type = clust$rna_type)\n  return(new_dat)\n}\nrna_lib_part &lt;- pred_rna_lib(mm1330)\n\n# get count\nmmdatasets &lt;- c(\"jilin\", \"commpass\", \"public\")\ncount_files &lt;- glue::glue(\"/cluster/home/jhuang/projects/mm/analysis/{mmdatasets}/human/rnaseq/exp/tables/{mmdatasets}_human_counts.csv\")\ntotal_counts_list &lt;- lapply(count_files[file.exists(count_files)], read_csv)\nnames &lt;- mmdatasets[file.exists(count_files)]\ncounts_all &lt;- total_counts_list[[1]]\nfor (i in 2:length(total_counts_list)) {\n  counts_all &lt;- bind_cols(counts_all, total_counts_list[[i]][, -(1:2)])\n}\n\n# load new gene symbol info \nhugo_anno &lt;- readr::read_delim(\"/cluster/home/yjliu_jh/projects/mm/data/hgnc_complete_set.txt\",\n                               col_types = cols(intermediate_filament_db = col_character()))\nhugo_anno &lt;- hugo_anno[, c(\"symbol\", \"ensembl_gene_id\", \"locus_group\")] %&gt;% as.data.frame() \ncolnames(hugo_anno)[2] &lt;- \"gene_id\"\n\n# prepare counts data\ncounts_all &lt;- counts_all[, -2] %&gt;% left_join(hugo_anno) %&gt;% na.omit() %&gt;% \n  dplyr::select(-c(gene_id, locus_group)) %&gt;% as.data.frame() %&gt;% remove_rownames() %&gt;% \n  column_to_rownames(var = \"symbol\") %&gt;% as.matrix() %&gt;% round()\ncounts_part &lt;- counts_all[, intersect(clusterings$sample_id, colnames(counts_all))]\n\n# prepare anno data\nsinfo_part &lt;- data.frame(sample_id = colnames(counts_part))\nsinfo_part &lt;- left_join(sinfo_part, clusterings[, c(\"sample_id\", \"sub_groups\")])\nsinfo_part &lt;- left_join(sinfo_part, rna_lib_part)\nmerged_sinfo &lt;- read_rds(\"~/projects/mm/docs/meta/sampleinfo/sampleinfo_jilin_commpass.rds\")\nsinfo_part &lt;- left_join(sinfo_part, merged_sinfo[, c(\"sample_id\", \"batch\")])\nrownames(sinfo_part) &lt;- sinfo_part$sample_id\nsinfo_part$group &lt;- ifelse(sinfo_part$sub_groups %in% \"G3\", \"igd_like\", \"others\")\n\n# construct DESeq2 object\ndds &lt;- DESeqDataSetFromMatrix(counts_part, sinfo_part, ~ batch + rna_type + group)\nkeep &lt;- rowSums(counts(dds) &gt;= 5) &gt; ceiling(0.2 * ncol(dds))  \ndds &lt;- dds[keep, ]\nkeep2 &lt;- rowSums(counts(dds) == 0) &lt; ceiling(0.5 * ncol(dds))\ndds &lt;- dds[keep2, ]\ndds &lt;- DESeq(dds)\nreadr::write_rds(dds, \"dds_corrected.rds\")\n\n# order and add columns to the results\nadd_col &lt;- function(data){\n  data$gene_name &lt;- rownames(data)\n  data$absFC &lt;- abs(data$log2FoldChange)\n  data &lt;- data[order(data$pvalue), ]\n  data2 &lt;- left_join(as.data.frame(data), hugo_anno[, c(\"symbol\", \"gene_id\")], by = c(\"gene_name\" = \"symbol\"))\n  data$ensembl_id &lt;- data2$gene_id\n  data\n}\n\n# get result for  comparison\nres_igd &lt;- add_col(results(dds, c(\"group\", \"igd_like\", \"others\")))\nGSEAInput_i &lt;- data.frame(rownames(res_igd), res_igd$log2FoldChange)\ncolnames(GSEAInput_i) &lt;- c(\"Symbol\", \"logFC\")\nGSEA2 &lt;- GSEAInput_i$logFC\nnames(GSEA2) &lt;- as.character(GSEAInput_i$Symbol)\nGSEA2 &lt;- sort(GSEA2, decreasing = TRUE)\ngseGO_res_i &lt;- gseGO(GSEA2, OrgDb = org.Hs.eg.db, keyType = \"SYMBOL\", ont = \"BP\",\n                     minGSSize = 5, maxGSSize = 1000, pvalueCutoff = 0.2)\n\n# volcano function\nquick_volcano &lt;- function (resA, title, col = \"gene_name\", fc_cutoff = 2, sel_lab = NULL) {\n  if (is.null(sel_lab)) {\n    sel_lab &lt;- unique(c(resA[order(resA$padj), ][1:10, col],\n                        resA[order(resA$absFC, decreasing = T), ][1:10, col]))\n  }\n  p &lt;- EnhancedVolcano(resA, lab = resA[[col]],\n                       title = title, subtitle = NULL, caption = NULL,\n                       legendPosition = \"none\", \n                       selectLab = sel_lab,\n                       drawConnectors = TRUE, widthConnectors = 0.3,\n                       x = 'log2FoldChange', y = 'pvalue',\n                       pCutoff = 0.05, FCcutoff = fc_cutoff,\n                       gridlines.major = FALSE,\n                       gridlines.minor = FALSE)\n  p\n} \nvolcano_p &lt;- quick_volcano(as.data.frame(res_igd), \"IgD group vs others\")\nggsave(\"volcano_igd_comparison_altered.pdf\", volcano_p, dpi = 300, width = 6, height = 6, units = \"in\")\n\nplot:\ncode:\n\n# gsea result\npdf(\"igd_comparison_gsea.pdf\", width = 12, height = 9)\nprint(dotplot(gseGO_res_i, showCategory = 9, split = \".sign\", orderBy = \"p.adjust\") + facet_grid(.~.sign))\ndev.off()\n\nplot:",
    "crumbs": [
      "Visualization",
      "<span class='chapter-number'>16</span>  <span class='chapter-title'>Figure 3</span>"
    ]
  },
  {
    "objectID": "faq.html",
    "href": "faq.html",
    "title": "17  Frequently Asked Questions",
    "section": "",
    "text": "Frequently Asked Questions",
    "crumbs": [
      "Communication",
      "<span class='chapter-number'>17</span>  <span class='chapter-title'>FAQ</span>"
    ]
  },
  {
    "objectID": "contactus.html",
    "href": "contactus.html",
    "title": "18  Contact us",
    "section": "",
    "text": "We welcome inquiries and collaboration to maximize the impact of our research. To ensure your questions are directed to the most appropriate team member, please use the following contact guidelines:\n\nClinical Questions: For inquiries related to clinical implications, diagnostic applications, or patient management, please contact Prof. Fengyan Jin.\nWet Lab and Experimental Questions: For questions about sample preparation, library preparation, functional assays, or other experimental methodologies, please reach out to Prof. Yun Dai.\nBioinformatics and Computational Questions: For assistance with bioinformatics troubleshooting, methodology, or replicating our analytical pipelines, please contact me directly at hiekeen@gmail.com.\n\nGeneral Inquiries or Collaborative Opportunities: For all other questions, including data access, interdisciplinary collaborations, or feedback on the project, we encourage you to email Prof. Fengyan Jin, Prof. Yun Dai, and me collectively. We are deeply invested in enabling others to explore and build upon this dataset.",
    "crumbs": [
      "Communication",
      "<span class='chapter-number'>18</span>  <span class='chapter-title'>Contact us</span>"
    ]
  },
  {
    "objectID": "functions.html",
    "href": "functions.html",
    "title": "19  Functions",
    "section": "",
    "text": "To summarize the features embedded in the large-scale transcriptomic dataset generated in this study and to facilitate downstream application by other researchers, we trained multiple predictive models using various algorithms, built upon the dataset presented herein. To evaluate model performance and guide the selection of optimal classifiers for robust subtype prediction, a set of external, independent samples was integrated with our cohort and annotated using the same analytical pipeline. These external samples were also used as model input. By comparing the model predictions with the results obtained from the standard analytical pipeline, we identified the optimal model, which achieved a high accuracy.\nSubsequently, in conjunction with the findings of this study, we developed a suite of methods for molecular characterization of multiple myeloma (MM) samples and implemented them in an R package (MMyeloMap) designed to enable comprehensive single-sample prediction. This tool takes transcript quantification results generated by the Salmon pipeline as input and optionally produces a comprehensive web-based report. The framework integrates multiple predictive models trained on multiple cohorts (see Methods), and provides an overall subtype assignment for the queried sample. The output includes figures illustrating transcriptomic clustering characteristics, dimensionality reduction visualizations, and other relevant features. When raw FASTQ files are used as input, the tool can also infer the patient’s immunoglobulin (Ig) isotype and identify potential driver alterations.\nPlease check https://github.com/JhuangLab/MMyeloMap/ and https://jhuanglab.github.io/MMyeloMap for the details.",
    "crumbs": [
      "Appendix",
      "<span class='chapter-number'>19</span>  <span class='chapter-title'>Functions</span>"
    ]
  },
  {
    "objectID": "acknowledgement.html",
    "href": "acknowledgement.html",
    "title": "20  Acknowledgement",
    "section": "",
    "text": "I would like to express my gratitude to the following organizations and individuals for their invaluable support in completing this research project.\nFirst of all, I would like to express my sincere gratitude to my [name of the supervisor] for his/her support and guidance throughout the doctoral programme. The [professor name] ’s insights and feedback have been helpful in shaping the scope and directions of this study.\nI am also grateful to [names of all contributors] for their assistance with data collection, analysis, and interpretation, which made the study possible.\nI would also like to express my gratitude to the members of [names of research committee members] for their constructive criticism and valuable feedback, which contributed to enhancing the quality of this research.\nFinally, I thank [institution] for providing the necessary facilities and resources to conduct my research.\nI extend my gratitude to all for your invaluable contributions that significantly enhanced the quality of the paper.",
    "crumbs": [
      "Appendix",
      "<span class='chapter-number'>20</span>  <span class='chapter-title'>Acknowledgement</span>"
    ]
  },
  {
    "objectID": "acknowledgement.html#note",
    "href": "acknowledgement.html#note",
    "title": "20  Acknowledgement",
    "section": "20.1 Note",
    "text": "20.1 Note\nWe get some colors setting from: https://zhuanlan.zhihu.com/p/693124785.",
    "crumbs": [
      "Appendix",
      "<span class='chapter-number'>20</span>  <span class='chapter-title'>Acknowledgement</span>"
    ]
  },
  {
    "objectID": "final.html",
    "href": "final.html",
    "title": "21  Final Words",
    "section": "",
    "text": "We are deeply grateful for your patience and continued interest as we advance this research on molecular subtyping of multiple myeloma in Chinese patients. This project is an ongoing journey, and we are actively working to refine our analyses, enhance the reproducibility of our computational methods, and uncover new insights into the molecular mechanisms driving this disease. In the coming phases, we plan to share expanded datasets, updated bioinformatics workflows, and novel findings that further elucidate population-specific genetic alterations and their therapeutic implications. These efforts aim to empower clinicians with actionable tools for personalized care, provide bioinformatics specialists with robust, replicable pipelines, and offer oncogenesis researchers deeper mechanistic understanding. Your engagement and feedback are invaluable as we strive to bridge clinical practice, computational science, and oncology research. Stay tuned for updates, and thank you for being part of this collaborative endeavor to improve diagnosis, treatment, and outcomes for multiple myeloma in Chinese and Asian populations.",
    "crumbs": [
      "Appendix",
      "<span class='chapter-number'>21</span>  <span class='chapter-title'>Final Words</span>"
    ]
  },
  {
    "objectID": "references.html",
    "href": "references.html",
    "title": "References",
    "section": "",
    "text": "Chen, B., L. Jiang, M. L. Zhong, J. F. Li, B. S. Li, L. J. Peng, Y. T.\nDai, et al. 2018. “Identification of Fusion Genes and\nCharacterization of Transcriptome Features in t-Cell Acute Lymphoblastic\nLeukemia.” Journal Article. Proc Natl Acad Sci U S A 115\n(2): 373–78. https://doi.org/10.1073/pnas.1717125115.\n\n\nDai, Y. T., F. Zhang, H. Fang, J. F. Li, G. Lu, L. Jiang, B. Chen, et\nal. 2022. “Transcriptome-Wide Subtyping of Pediatric and Adult t\nCell Acute Lymphoblastic Leukemia in an International Study of 707\nCases.” Journal Article. Proc Natl Acad Sci U S A 119\n(15): e2120787119. https://doi.org/10.1073/pnas.2120787119.\n\n\nLi, J. F., Y. T. Dai, H. Lilljebjorn, S. H. Shen, B. W. Cui, L. Bai, Y.\nF. Liu, et al. 2018. “Transcriptional Landscape of b Cell\nPrecursor Acute Lymphoblastic Leukemia Based on an International Study\nof 1,223 Cases.” Journal Article. Proc Natl Acad Sci U S\nA 115 (50): E11711–20. https://doi.org/10.1073/pnas.1814397115.\n\n\nLiu, Y. F., B. Y. Wang, W. N. Zhang, J. Y. Huang, B. S. Li, M. Zhang, L.\nJiang, et al. 2016. “Genomic Profiling of Adult and Pediatric\nb-Cell Acute Lymphoblastic Leukemia.” Journal Article.\nEBioMedicine 8: 173–83. https://doi.org/10.1016/j.ebiom.2016.04.038.",
    "crumbs": [
      "References"
    ]
  }
]